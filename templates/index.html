<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>è¨˜è¿°å¼APIï¼ˆå€‹äººé‹ç”¨ç‰ˆï¼‰UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#fdf6ff; --bg2:#f0fbff;
      --ink:#1f2937; --muted:#6b7280;
      --brand:#c084fc; --brand-strong:#a855f7;
      --accent:#f9a8d4; --accent-strong:#f472b6;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#ffffff; --border:#e5e7eb; --shadow:rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,0.75);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px var(--shadow);padding:16px}
    h1{font-size:20px;margin:4px 0}
    h2{font-size:18px;margin:8px 0 12px}
    h3{font-size:15px;margin:10px 0 6px}
    label{font-size:13px;color:var(--muted)}
    input[type=text], select, textarea{
      width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff
    }
    textarea{min-height:120px;resize:vertical}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .flex-col{display:flex;gap:8px;flex-direction:column}
    .btn{
      border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-weight:600;font-size:14px;cursor:pointer
    }
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
    .btn.err{background:var(--err);border-color:var(--err);color:#fff}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#374151;background:#fff}
    .toolbar{display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}}
    .pill{
      display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff
    }
    .small{font-size:12px;color:var(--muted)}
    .qcard{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hint{background:#faf5ff;border:1px solid #eadcff;border-radius:12px;padding:10px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(12px);transition:.25s}
    .toast.show{opacity:1;transform:none}
    .danger{color:var(--err)}
    .success{color:var(--ok)}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .list{display:flex;flex-direction:column;gap:10px;max-height:340px;overflow:auto}
    .item{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .caps{font-variant:all-small-caps;letter-spacing:.04em}
    .kbd{border:1px solid var(--border);padding:1px 6px;border-radius:6px;background:#fff;font-size:12px}

    /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®å¯è¦–ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆè¦‹ãŸç›®ã¯é€šå¸¸æ™‚å¤‰åŒ–ãªã—ï¼‰ */
    :focus-visible{ outline:2px solid var(--brand-strong); outline-offset:2px; }

    /* model è¡¨ç¤ºã¯éè¡¨ç¤ºã« */
    #modelTag{ display:none; }

    /* =========================
       ä½¿ã„æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰
       ========================= */
    .modal{
      position:fixed; inset:0; z-index:999;
      display:none; align-items:center; justify-content:center;
      padding:16px;
      background:rgba(17,24,39,0.35);
      backdrop-filter: blur(4px);
    }
    .modal.show{ display:flex; }
    .modal .panel{
      width:min(920px, 96vw);
      max-height:86vh;
      overflow:auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 60px rgba(0,0,0,0.18);
      padding:16px;
    }
    .modal .panelHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      position:sticky; top:0; background:rgba(255,255,255,0.92);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:8px 8px 10px;
      border-radius:14px;
    }
    .modal .panelTitle{ margin:0; font-size:18px; }
    .modal .panelBody{ padding:10px 6px 6px; }
    .callout{
      background:linear-gradient(180deg,#fff7ff,#f5fbff);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
    }
    .step{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .step h3{ margin:0 0 6px; font-size:15px; }
    .step ol, .step ul{ margin:8px 0 0; padding-left:18px; line-height:1.75; }
    .step .mini{ font-size:12px; color:var(--muted); margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="flex" style="gap:10px">
        <h1>è¨˜è¿°å¼APIï¼ˆå€‹äººé‹ç”¨UIï¼‰</h1>
        <span id="modelTag" class="tag" aria-hidden="true">model: ...</span>
      </div>
      <div class="flex" style="gap:8px;align-items:center">
        <span id="usageBadge" class="pill small" aria-live="polite"></span>

        <!-- âœ… ã“ã“ãŒã€Œè¡¨ç¤ºæ¬„ã€ï¼šå¿…ãšè¦‹ãˆã‚‹å ´æ‰€ã«é…ç½® -->
        <button class="btn brand" id="btnHowto" title="ä½¿ã„æ–¹èª¬æ˜ã‚’é–‹ã">ä½¿ã„æ–¹èª¬æ˜</button>

        <button class="btn ghost" id="btnSettings">è¨­å®š</button>
        <button class="btn ghost" id="btnReload">å†èª­è¾¼</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px;padding-bottom:40px">

    <!-- è¨­å®š -->
    <div class="card" id="settingsCard" style="display:none">
      <h2>æ¥ç¶šè¨­å®š</h2>
      <div class="grid-2">
        <div>
          <label for="baseUrl">API Base URLï¼ˆç©º=åŒä¸€ã‚ªãƒªã‚¸ãƒ³ï¼‰</label>
          <input type="text" id="baseUrl" placeholder="ä¾‹ https://your.onrender.com" aria-describedby="baseUrlHelp" />
          <div id="baseUrlHelp" class="small muted">CORSã‚’è¨­å®šæ¸ˆã¿ã®URLã‚’æŒ‡å®šã€‚ç©ºæ¬„ãªã‚‰åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã‚’ä½¿ç”¨ã€‚</div>
        </div>
        <div>
          <label for="accessCode">ACCESS_CODEï¼ˆä¿è­·APIç”¨ / ä»»æ„ï¼‰</label>
          <input type="text" id="accessCode" placeholder="ãƒ˜ãƒƒãƒ€ãƒ¼ã« X-Access-Code ã¨ã—ã¦ä»˜ä¸" aria-describedby="accessCodeHelp" />
          <div id="accessCodeHelp" class="small muted">è¨­å®šã™ã‚‹ã¨ç”Ÿæˆãƒ»æ¡ç‚¹ãƒ»å‰Šé™¤ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¿…è¦ãªèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn brand" id="btnSaveSettings">ä¿å­˜</button>
        <button class="btn" id="btnHideSettings">é–‰ã˜ã‚‹</button>
        <span id="statusLine" class="small muted"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <!-- å·¦ï¼šç”Ÿæˆ & ã‚¹ãƒˆãƒƒã‚¯ -->
      <section class="card">
        <div class="toolbar">
          <h2>â‘  å‡ºé¡Œã®ç”Ÿæˆ & ã‚¹ãƒˆãƒƒã‚¯</h2>
          <div class="flex">
            <button class="btn" id="btnExportJson">ğŸ“¦ stocks.json</button>
            <button class="btn" id="btnExportCsv">ğŸ“Š stocks.csv</button>
          </div>
        </div>

        <div class="flex" style="gap:6px;margin-bottom:8px">
          <span class="tab active" data-subject="ç¤¾ä¼š" tabindex="0">ç¤¾ä¼š</span>
          <span class="tab" data-subject="ç†ç§‘" tabindex="0">ç†ç§‘</span>
        </div>

        <div class="grid-2">
          <div>
            <label>åˆ†é¡ï¼ˆç§‘ç›®ï¼‰</label>
            <select id="category">
              <option>åœ°ç†</option>
              <option>æ­´å²</option>
            </select>
          </div>
          <div id="gradeBox" style="display:none">
            <label>å­¦å¹´ï¼ˆç†ç§‘ã®ã¿ï¼‰</label>
            <select id="grade">
              <option>ä¸­1</option>
              <option>ä¸­2</option>
              <option selected>ä¸­3</option>
            </select>
          </div>
          <div>
            <label>é›£æ˜“åº¦/é…ç‚¹</label>
            <select id="difficulty">
              <option>5ç‚¹</option>
              <option selected>10ç‚¹</option>
              <option>æº€ç‚¹</option>
            </select>
          </div>
          <div>
            <label>è§£ç­”åˆ†é‡ã®ç›®å®‰</label>
            <input type="text" id="lengthHint" value="30ã€œ80å­—ç¨‹åº¦" maxlength="40">
          </div>
          <div>
            <label>å‡ºé¡Œã®æ–¹å‘æ€§ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="genreHint" placeholder="åˆ¶åº¦/æ–‡åŒ–/æ™‚ä»£èƒŒæ™¯ ãªã©" maxlength="120">
          </div>
          <div>
            <label>é¿ã‘ã‚‹è©±é¡Œï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="avoidTopics" placeholder="ä¾‹ï¼šç¨²ä½œã¯é¿ã‘ãŸã„" maxlength="120">
          </div>
        </div>

        <div class="flex" style="margin-top:8px">
          <label class="pill"><input type="checkbox" id="includeHints"> ãƒ’ãƒ³ãƒˆï¼ˆæ¨¡ç¯„è§£ç­”ç­‰ï¼‰ã‚‚ç”Ÿæˆã«å«ã‚ã‚‹</label>
          <button class="btn brand" id="btnGenerate">å•é¡Œã‚’è‡ªå‹•ç”Ÿæˆ</button>
        </div>

        <div id="genResult" style="margin-top:12px;display:none">
          <h3>ç”Ÿæˆçµæœ</h3>
          <div class="qcard">
            <div class="small muted" id="genMeta"></div>
            <div id="genQuestion" style="margin:8px 0;font-size:15px;line-height:1.6"></div>
            <div class="flex" id="genTags" style="gap:6px;flex-wrap:wrap"></div>
            <div class="divider"></div>
            <div class="flex" style="gap:8px;align-items:center">
              <button class="btn" id="btnUseForGrading">ã“ã®å•é¡Œã§æ¡ç‚¹ã¸</button>
              <label class="pill"><input type="checkbox" id="toggleHints"> ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º</label>
              <span id="dupNote" class="small"></span>
            </div>
            <div id="hintBox" class="hint" style="display:none;margin-top:10px">
              <div style="margin-bottom:6px">
                <button class="btn small" id="btnToggleGenModel" type="button">æ¨¡ç¯„è§£ç­”ã‚’è¡¨ç¤º</button>
                <div id="genModelAnswerWrap" style="display:none;margin-top:4px">
                  <span class="caps">æ¨¡ç¯„è§£ç­”</span>
                  <div id="genModelAnswer" class="mono"></div>
                </div>
              </div>
              <div class="divider"></div>
              <div style="margin:6px 0">
                <button class="btn small" id="btnToggleGenExpl" type="button">è§£èª¬ã‚’è¡¨ç¤º</button>
                <div id="genExplanationWrap" style="display:none;margin-top:4px">
                  <span class="caps">è§£èª¬</span>
                  <div id="genExplanation"></div>
                </div>
              </div>
              <div class="divider"></div>
              <div style="margin-top:6px">
                <button class="btn small" id="btnToggleGenIntn" type="button">å‡ºé¡Œæ„å›³ã‚’è¡¨ç¤º</button>
                <div id="genIntentionWrap" style="display:none;margin-top:4px">
                  <span class="caps">å‡ºé¡Œæ„å›³</span>
                  <div id="genIntention"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3>ã‚¹ãƒˆãƒƒã‚¯ï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>

          <!-- âœ… è¿½åŠ ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ç¶­æŒï¼‰ï¼šæ¤œç´¢ãƒ»ãƒ©ãƒ³ãƒ€ãƒ  -->
          <div class="flex" style="gap:8px;margin:8px 0 6px">
            <input type="text" id="stockSearch" placeholder="ã‚¹ãƒˆãƒƒã‚¯æ¤œç´¢ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰" style="flex:1;min-width:220px" maxlength="120">
            <button class="btn" id="btnStockSearch">æ¤œç´¢</button>
            <button class="btn" id="btnStockClearSearch">ã‚¯ãƒªã‚¢</button>
            <button class="btn" id="btnStockRandom" title="æ¡ä»¶ã«åˆã†ã‚¹ãƒˆãƒƒã‚¯ã‹ã‚‰1å•ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã³ã¾ã™">ãƒ©ãƒ³ãƒ€ãƒ </button>
          </div>
          <div class="small muted" id="stockSearchInfo"></div>

          <div class="list" id="stockList"></div>
          <div class="small muted" id="stockCount"></div>
        </div>
      </section>

      <!-- å³ï¼šæ¡ç‚¹ -->
      <section class="card">
        <div class="toolbar">
          <h2>â‘¡ æ¡ç‚¹</h2>
          <button class="btn" id="btnExportGrading">ğŸ§¾ grading.jsonl</button>
        </div>

        <div class="qcard">
          <div class="small muted">å¯¾è±¡å•é¡Œ</div>
          <div id="currentQuestionText" style="margin:6px 0 8px;line-height:1.6"></div>
          <div class="flex" style="gap:8px;align-items:center">
            <label class="pill"><input type="checkbox" id="includeModelForGrading"> æ¡ç‚¹ã«æ¨¡ç¯„è§£ç­”ã‚‚æ¸¡ã™ï¼ˆå®‰å®šåŒ–ï¼‰</label>
            <label class="pill"><input type="checkbox" id="showCurrentHints"> ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º</label>
          </div>
          <div id="currentHintBox" class="hint" style="display:none;margin-top:8px">
            <div style="margin-bottom:6px">
              <button class="btn small" id="btnToggleCurModel" type="button">æ¨¡ç¯„è§£ç­”ã‚’è¡¨ç¤º</button>
              <div id="currentModelWrap" style="display:none;margin-top:4px">
                <span class="caps">æ¨¡ç¯„è§£ç­”</span>
                <div id="currentModel" class="mono"></div>
              </div>
            </div>
            <div class="divider"></div>
            <div style="margin:6px 0">
              <button class="btn small" id="btnToggleCurExpl" type="button">è§£èª¬ã‚’è¡¨ç¤º</button>
              <div id="currentExplWrap" style="display:none;margin-top:4px">
                <span class="caps">è§£èª¬</span>
                <div id="currentExpl"></div>
              </div>
            </div>
            <div class="divider"></div>
            <div style="margin-top:6px">
              <button class="btn small" id="btnToggleCurIntn" type="button">å‡ºé¡Œæ„å›³ã‚’è¡¨ç¤º</button>
              <div id="currentIntnWrap" style="display:none;margin-top:4px">
                <span class="caps">å‡ºé¡Œæ„å›³</span>
                <div id="currentIntn"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex-col" style="margin-top:10px">
          <label>ã‚ãªãŸã®è§£ç­”</label>
          <textarea id="studentAnswer" placeholder="ã“ã“ã«è§£ç­”ã‚’è¨˜å…¥ï¼ˆ30ã€œ80å­—ç›®å®‰ï¼‰" maxlength="2000"></textarea>
        </div>
        <div class="flex" style="margin-top:10px">
          <select id="gradeDifficulty">
            <option>5ç‚¹</option>
            <option selected>10ç‚¹</option>
            <option>æº€ç‚¹</option>
          </select>
          <button class="btn brand" id="btnGrade">æ¡ç‚¹ã™ã‚‹</button>
          <button class="btn" id="btnClearAnswer">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="gradeResult" style="margin-top:12px;display:none">
          <h3>æ¡ç‚¹çµæœ</h3>
          <div class="qcard">
            <div id="scoreLine" class="success" style="font-weight:700"></div>

            <!-- âœ… è¿½åŠ ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¶­æŒï¼‰ï¼šæº€ç‚¹ç¢ºç‡è¡¨ç¤º -->
            <div id="perfectProbLine" class="small muted" style="margin-top:4px"></div>

            <div id="commentary" style="margin:6px 0 8px"></div>
            <div class="small muted">ç†ç”±</div>
            <ul id="reasons" style="margin-top:4px"></ul>
            <div class="divider"></div>
            <div class="small muted">å‚è€ƒï¼šæ¨¡ç¯„è§£ç­”</div>
            <div id="gradedModel" class="mono"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- =========================
       âœ… ä½¿ã„æ–¹èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰
       ========================= -->
  <div class="modal" id="howtoModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
      <div class="panelHeader">
        <div>
          <h2 class="panelTitle" id="howtoTitle">ä½¿ã„æ–¹èª¬æ˜ï¼ˆã¯ã˜ã‚ã¦ã®æ–¹å‘ã‘ï¼‰</h2>
          <div class="small muted">è¿·ã£ãŸã‚‰ã“ã®ç”»é¢ã‚’é–‹ã„ã¦ã€ä¸Šã‹ã‚‰é †ç•ªã«é€²ã‚ã¦ãã ã•ã„ã€‚</div>
        </div>
        <div class="flex" style="gap:8px">
          <button class="btn" id="btnHowtoClose" aria-label="ä½¿ã„æ–¹èª¬æ˜ã‚’é–‰ã˜ã‚‹">é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="callout">
          <div style="font-weight:700;margin-bottom:6px">ã“ã®UIã§ã§ãã‚‹ã“ã¨</div>
          <ul style="margin:0;padding-left:18px;line-height:1.8">
            <li><b>å‡ºé¡Œï¼ˆè¨˜è¿°å•é¡Œï¼‰ã®è‡ªå‹•ç”Ÿæˆ</b>ï¼šç¤¾ä¼š/ç†ç§‘ã®è¨˜è¿°å•é¡Œã‚’ã€å…¥è©¦ãƒ»å®šæœŸãƒ†ã‚¹ãƒˆæƒ³å®šã§ä½œã‚Œã¾ã™ã€‚</li>
            <li><b>æ¡ç‚¹ï¼ˆ10ç‚¹æº€ç‚¹ï¼‰</b>ï¼šç”Ÿå¾’ã®è§£ç­”ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ç‚¹æ•°ã¨è¬›è©•ãƒ»ç†ç”±ãƒ»æ¨¡ç¯„è§£ç­”ã‚’è¿”ã—ã¾ã™ã€‚</li>
            <li><b>ã‚¹ãƒˆãƒƒã‚¯ä¿å­˜</b>ï¼šç”Ÿæˆã—ãŸå•é¡Œã‚’æœ€å¤§10ä»¶ã¾ã§ä¿å­˜ã—ã€ã‚ã¨ã§å‘¼ã³å‡ºã—ã¦ä½¿ãˆã¾ã™ã€‚</li>
            <li><b>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</b>ï¼šstocks / grading ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„å…±æœ‰ã«ä½¿ãˆã¾ã™ã€‚</li>
          </ul>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div class="step">
          <h3>0. ã¾ãšæœ€åˆã«ï¼šæ¥ç¶šè¨­å®šï¼ˆå¿…è¦ãªäººã ã‘ï¼‰</h3>
          <ol>
            <li>å³ä¸Šã® <b>ã€Œè¨­å®šã€</b> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</li>
            <li><b>API Base URL</b>ï¼š
              <ul>
                <li>åŒã˜ã‚µãƒ¼ãƒãƒ¼å†…ã§UIã‚’é…ã£ã¦ã„ã‚‹ãªã‚‰ <b>ç©ºæ¬„ã®ã¾ã¾</b> ã§OKã§ã™ã€‚</li>
                <li>åˆ¥URLã®APIã«ç¹‹ããªã‚‰ã€ä¾‹ã®ã‚ˆã†ã« <span class="mono">https://xxxx.onrender.com</span> ã®å½¢ã§å…¥åŠ›ã—ã¾ã™ã€‚</li>
              </ul>
            </li>
            <li><b>ACCESS_CODE</b>ï¼š
              <ul>
                <li>ã‚µãƒ¼ãƒãƒ¼å´ã§ACCESS_CODEã‚’è¨­å®šã—ã¦ã„ã‚‹å ´åˆã¯ã“ã“ã«å…¥åŠ›ã—ã¾ã™ï¼ˆæœªè¨­å®šãªã‚‰ç©ºã§OKï¼‰ã€‚</li>
                <li>ã“ã‚ŒãŒåˆã£ã¦ã„ãªã„ã¨ <b>403 Forbidden</b> ã«ãªã‚Šã¾ã™ã€‚</li>
              </ul>
            </li>
            <li><b>ä¿å­˜</b> â†’ å³ä¸Šã® <b>å†èª­è¾¼</b> ã‚’æŠ¼ã—ã¦åæ˜ ã—ã¾ã™ã€‚</li>
          </ol>
          <div class="mini">ã‚ˆãã‚ã‚‹å¤±æ•—ï¼šURLã®æœ«å°¾ã« <span class="mono">/</span> ãŒå…¥ã£ã¦ã„ã¦äºŒé‡ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã«ãªã‚‹ â†’ ã¤ãªãŒã‚‰ãªã„ã€ãªã©ã€‚</div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>1. å‡ºé¡Œã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ï¼ˆå·¦å´ï¼šâ‘  å‡ºé¡Œã®ç”Ÿæˆï¼‰</h3>
          <ol>
            <li>ä¸Šã®ã‚¿ãƒ–ã§ <b>ç¤¾ä¼š</b> / <b>ç†ç§‘</b> ã‚’é¸ã³ã¾ã™ã€‚</li>
            <li><b>åˆ†é¡</b> ã‚’é¸ã³ã¾ã™ï¼š
              <ul>
                <li>ç¤¾ä¼šï¼šåœ°ç† / æ­´å²</li>
                <li>ç†ç§‘ï¼šç”Ÿç‰© / åŒ–å­¦ / åœ°å­¦ / ç‰©ç† / å¤©ä½“ï¼ˆâ€»å¤©ä½“ã¯ä¸­3ã®ã¿ï¼‰</li>
              </ul>
            </li>
            <li>ç†ç§‘ã®å ´åˆã¯ <b>å­¦å¹´</b> ã‚‚é¸ã³ã¾ã™ï¼ˆä¸­1/ä¸­2/ä¸­3ï¼‰ã€‚</li>
            <li><b>é›£æ˜“åº¦/é…ç‚¹</b> ã‚’é¸ã³ã¾ã™ï¼ˆ5ç‚¹/10ç‚¹/æº€ç‚¹ï¼‰ã€‚</li>
            <li><b>å‡ºé¡Œã®æ–¹å‘æ€§</b>ï¼ˆä»»æ„ï¼‰ï¼šä¾‹ï¼‰ã€Œåˆ¶åº¦ã€ã€Œæ–‡åŒ–ã€ã€Œå› æœé–¢ä¿‚ã€ã€Œæ¯”è¼ƒã€ãªã©ã€‚</li>
            <li><b>é¿ã‘ã‚‹è©±é¡Œ</b>ï¼ˆä»»æ„ï¼‰ï¼šä¾‹ï¼‰ã€Œç¨²ä½œã¯é¿ã‘ãŸã„ã€ãªã©ã€åã‚Šé˜²æ­¢ã«ä½¿ãˆã¾ã™ã€‚</li>
            <li><b>å•é¡Œã‚’è‡ªå‹•ç”Ÿæˆ</b> ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
          </ol>
          <div class="mini">
            ç”ŸæˆçµæœãŒå‡ºãŸã‚‰ã€Œã“ã®å•é¡Œã§æ¡ç‚¹ã¸ã€ã§å³å´ã®æ¡ç‚¹å¯¾è±¡ã«ã‚»ãƒƒãƒˆã§ãã¾ã™ã€‚<br>
            ã€Œãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºã€ã‚’ONã«ã™ã‚‹ã¨ã€æ¨¡ç¯„è§£ç­”ãƒ»è§£èª¬ãƒ»å‡ºé¡Œæ„å›³ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆå¿…è¦ãªæ™‚ã ã‘é–‹ãè¨­è¨ˆã§ã™ï¼‰ã€‚
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>2. ã‚¹ãƒˆãƒƒã‚¯ã‚’ä½¿ã†ï¼ˆå·¦ä¸‹ï¼šã‚¹ãƒˆãƒƒã‚¯ä¸€è¦§ï¼‰</h3>
          <ol>
            <li>ã‚¹ãƒˆãƒƒã‚¯ï¼ˆæœ€æ–°10ä»¶ï¼‰ã«ã¯ã€ç”Ÿæˆã—ãŸå•é¡ŒãŒè‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚</li>
            <li>ä½¿ã„ãŸã„å•é¡Œã® <b>ã€Œã“ã®å•é¡Œã‚’ä½¿ã†ã€</b> ã‚’æŠ¼ã™ã¨ã€å³å´ã®ã€Œå¯¾è±¡å•é¡Œã€ã«ã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</li>
            <li>è¿½åŠ æ©Ÿèƒ½ï¼š
              <ul>
                <li><b>æ¤œç´¢</b>ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã‚¹ãƒˆãƒƒã‚¯ã‚’çµã‚Šè¾¼ã¿ã§ãã¾ã™ã€‚</li>
                <li><b>ãƒ©ãƒ³ãƒ€ãƒ </b>ï¼šã‚¹ãƒˆãƒƒã‚¯ã‹ã‚‰1å•ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã§æ¡ç‚¹å¯¾è±¡ã«ã§ãã¾ã™ã€‚</li>
              </ul>
            </li>
            <li>ã‚¹ãƒˆãƒƒã‚¯ã‚’å¤–éƒ¨ä¿å­˜ã—ãŸã„å ´åˆï¼š
              <ul>
                <li><b>stocks.json</b>ï¼šãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã¸ã®ç§»è¡Œã«ã‚‚å‘ãã¾ã™ï¼‰</li>
                <li><b>stocks.csv</b>ï¼šExcelã§è¦‹ã‚„ã™ã„å½¢å¼ï¼ˆä¸€è¦§ç¢ºèªãƒ»ç·¨é›†ã«ä¾¿åˆ©ï¼‰</li>
              </ul>
            </li>
          </ol>
          <div class="mini">â€»ã‚¹ãƒˆãƒƒã‚¯ã¯ä¸Šé™10ä»¶ã€‚å¤ã„ã‚‚ã®ã‹ã‚‰è‡ªå‹•ã§æ¶ˆãˆã‚‹è¨­è¨ˆã§ã™ï¼ˆé‹ç”¨ã§å¢—ã‚„ã™ã“ã¨ã‚‚å¯èƒ½ï¼‰ã€‚</div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>3. æ¡ç‚¹ã™ã‚‹ï¼ˆå³å´ï¼šâ‘¡ æ¡ç‚¹ï¼‰</h3>
          <ol>
            <li>ã¾ãš <b>å¯¾è±¡å•é¡Œ</b> ã«å•é¡ŒãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ï¼ˆç©ºãªã‚‰å·¦ã®ã‚¹ãƒˆãƒƒã‚¯ã‹ã‚‰é¸ã¶ or ç”Ÿæˆã—ã¾ã™ï¼‰ã€‚</li>
            <li>å¿…è¦ã«å¿œã˜ã¦ï¼š
              <ul>
                <li><b>æ¡ç‚¹ã«æ¨¡ç¯„è§£ç­”ã‚‚æ¸¡ã™ï¼ˆå®‰å®šåŒ–ï¼‰</b>ï¼šONã«ã™ã‚‹ã¨éƒ¨åˆ†ç‚¹ã‚„è¡¨ç¾ã‚†ã‚Œã®åˆ¤æ–­ãŒå®‰å®šã—ã‚„ã™ã„ã§ã™ã€‚</li>
                <li><b>ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º</b>ï¼šå•é¡Œã®æ„å›³ã‚„æ¨¡ç¯„è§£ç­”ã‚’ç¢ºèªã—ãŸã„ã¨ãã ã‘ONã€‚</li>
              </ul>
            </li>
            <li>è§£ç­”æ¬„ã«ã€ç”Ÿå¾’ã®è§£ç­”ã‚’å…¥åŠ›ã—ã¾ã™ï¼ˆç›®å®‰30ã€œ80å­—ï¼‰ã€‚</li>
            <li>å³ä¸‹ã® <b>æ¡ç‚¹ã™ã‚‹</b> ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
            <li>çµæœã¨ã—ã¦ <b>10ç‚¹ä¸­â—¯ç‚¹</b>ã€è¬›è©•ã€ç†ç”±ã€å‚è€ƒæ¨¡ç¯„è§£ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
          </ol>
          <div class="mini">
            è¿½åŠ è¡¨ç¤ºï¼š<b>æº€ç‚¹ï¼ˆâ—‹ï¼‰ã«ãªã‚‹ç¢ºç‡</b> ã‚‚å‡ºã¾ã™ï¼ˆè¡¨ç¾ã®æ›–æ˜§ã•ãƒ»è¦ç‚¹æ¼ã‚Œã®å¯èƒ½æ€§ã‚‚åŠ å‘³ã—ãŸç›®å®‰ï¼‰ã€‚<br>
            ã€Œã‚¯ãƒªã‚¢ã€ã¯è§£ç­”æ¬„ã¨è¡¨ç¤ºçµæœã ã‘ã‚’æ¶ˆã—ã¾ã™ï¼ˆå•é¡Œãã®ã‚‚ã®ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰ã€‚
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>4. ãƒ­ã‚°ã‚„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆè¨˜éŒ²ã‚’æ®‹ã—ãŸã„ã¨ãï¼‰</h3>
          <ul style="line-height:1.85">
            <li><b>grading.jsonl</b>ï¼šæ¡ç‚¹å±¥æ­´ã®ãƒ­ã‚°ã§ã™ï¼ˆã„ã¤ãƒ»ã©ã®å•é¡Œã‚’æ¡ç‚¹ã—ãŸã‹ãŒæ®‹ã‚Šã¾ã™ï¼‰ã€‚</li>
            <li><b>logs.zip</b>ï¼ˆURLç›´æ‰“ã¡ã§å–å¾—ï¼‰ï¼šé‹ç”¨ãƒ»ä¸å…·åˆèª¿æŸ»ç”¨ã®ãƒ­ã‚°ä¸€å¼ã§ã™ã€‚ç®¡ç†è€…ãŒåŸå› èª¿æŸ»ã™ã‚‹ã¨ãã«ä½¿ã„ã¾ã™ã€‚</li>
          </ul>
          <div class="mini">
            logs.zip ã¯UIã«ãƒœã‚¿ãƒ³ã‚’ç½®ã„ã¦ã„ãªã„å ´åˆã§ã‚‚ã€ã‚µãƒ¼ãƒãƒ¼å´ã«æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚<br>
            ä¾‹ï¼š<span class="mono">https://ã‚ãªãŸã®URL/logs.zip</span>ï¼ˆACCESS_CODEè¨­å®šæ™‚ã¯å¿…è¦ï¼‰
          </div>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div class="step">
          <h3>ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦</h3>
          <ul style="line-height:1.85">
            <li><b>403 Forbidden</b>ï¼šACCESS_CODEãŒæœªå…¥åŠ›/é•ã† â†’ è¨­å®šç”»é¢ã§æ­£ã—ã„å€¤ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã€‚</li>
            <li><b>CORSã‚¨ãƒ©ãƒ¼</b>ï¼šAPIå´ã® <span class="mono">ALLOWED_ORIGIN</span> ã«UIã®URLãŒå…¥ã£ã¦ã„ãªã„ â†’ ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒå¤‰æ•°ã‚’ä¿®æ­£ã€‚</li>
            <li><b>OpenAI API error</b>ï¼šã‚µãƒ¼ãƒãƒ¼å´ã®APIã‚­ãƒ¼/ãƒ¢ãƒ‡ãƒ«è¨­å®šãŒåŸå›  â†’ <span class="mono">/status</span>ï¼ˆèªè¨¼ã‚ã‚Šï¼‰ã§ç¢ºèªã€‚</li>
            <li><b>quota_exceeded</b>ï¼šç„¡æ–™å›æ•°ä¸Šé™ â†’ ç¿Œæ—¥ãƒªã‚»ãƒƒãƒˆã€ã‚‚ã—ãã¯ä¸Šé™è¨­å®šã‚’å¤‰æ›´ã€‚</li>
          </ul>
        </div>

        <div class="small muted" style="margin-top:10px">
          ãƒ’ãƒ³ãƒˆï¼šã“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ <span class="kbd">Esc</span> ã§ã‚‚é–‰ã˜ã‚‰ã‚Œã¾ã™ã€‚èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ---- è¨­å®šã®æ°¸ç¶šåŒ– ----
    const $ = (q)=>document.querySelector(q);
    const cfg = {
      get baseUrl(){ return localStorage.getItem('baseUrl') || ''; },
      set baseUrl(v){ localStorage.setItem('baseUrl', v||''); },
      get accessCode(){ return localStorage.getItem('accessCode') || ''; },
      set accessCode(v){ localStorage.setItem('accessCode', v||''); },
      endpoint(p){ const b=this.baseUrl.trim(); return (b?b.replace(/\/$/,''):'') + p; }
    };

    // ---- å…±é€šFetch ----
    async function apiGet(path){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok){
        if(res.status === 403) throw new Error('403 Forbidden: ACCESS_CODE ãŒå¿…è¦/ä¸ä¸€è‡´ã®å¯èƒ½æ€§');
        let msg = `${res.status} ${res.statusText}`;
        try {
          const j = await res.json();
          if(j && j.error){ msg += `: ${j.error}`; }
          if(j && j.message && !msg.includes(j.message)){ msg += ` / ${j.message}`; }
        } catch(e){}
        throw new Error(msg);
      }
      try{
        return await res.json();
      }catch(e){
        return {};
      }
    }

    async function apiPost(path, body){
      const headers = {'Content-Type':'application/json'};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {method:'POST', headers, body: JSON.stringify(body||{})});
      let data = null;
      try{
        data = await res.json();
      }catch(e){
        data = null;
      }
      if(!res.ok){
        // quota_exceededï¼ˆ429ï¼‰ã®å ´åˆã¯å°‚ç”¨æ‰±ã„
        if(res.status === 429 && data && data.error === 'quota_exceeded'){
          const err = new Error(data.message || 'ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®1æ—¥ã‚ãŸã‚Šã®åˆ©ç”¨å›æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚');
          err.code = 'quota_exceeded';
          err.status = 429;
          throw err;
        }
        if(res.status === 403){
          const err = new Error('403 Forbidden: ACCESS_CODE ãŒå¿…è¦/ä¸ä¸€è‡´ã®å¯èƒ½æ€§');
          err.code = 'forbidden';
          err.status = 403;
          throw err;
        }
        let msg = `${res.status} ${res.statusText}`;
        if(data){
          if(data.error) msg += `: ${data.error}`;
          if(data.message && !msg.includes(data.message)) msg += ` / ${data.message}`;
        }
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }
      return data || {};
    }

    function toast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.style.background = ok ? '#111827' : '#ef4444';
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }

    function buildQueryString(params){
      const sp = new URLSearchParams();
      Object.entries(params || {}).forEach(([k,v])=>{
        if(v === undefined || v === null) return;
        const s = String(v).trim();
        if(!s) return;
        sp.set(k, s);
      });
      const qs = sp.toString();
      return qs ? `?${qs}` : '';
    }

    // ---- UIçŠ¶æ…‹ ----
    let subject = 'ç¤¾ä¼š';
    let currentItem = null;
    let generatedRaw = null;

    // ---- è¨­å®šUI ----
    function loadSettings(){
      $('#baseUrl').value = cfg.baseUrl;
      $('#accessCode').value = cfg.accessCode;
    }
    function saveSettings(){
      cfg.baseUrl = $('#baseUrl').value.trim();
      cfg.accessCode = $('#accessCode').value.trim();
      $('#statusLine').textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
      setTimeout(()=>$('#statusLine').textContent='', 1500);
    }

    // ---- å­¦å¹´ã¨ã‚«ãƒ†ã‚´ãƒªã®æ•´åˆï¼ˆç†ç§‘ï¼šå¤©ä½“ã¯ä¸­3ã®ã¿ï¼‰----
    function applyScienceConstraints(){
      if(subject!=='ç†ç§‘') return;
      const g = $('#grade').value;
      const cat = $('#category');
      [...cat.options].forEach(opt=>{
        if(opt.textContent==='å¤©ä½“'){
          opt.disabled = (g !== 'ä¸­3');
          if(opt.disabled && cat.value==='å¤©ä½“'){
            cat.value = 'åœ°å­¦';
          }
        }
      });
    }

    // ---- åˆ©ç”¨çŠ¶æ³ãƒãƒƒã‚¸ ----
    async function refreshUsage(){
      const badge = $('#usageBadge');
      if(!badge) return;
      try{
        const r = await apiGet('/api/usage');
        if(!r || !r.ok){
          badge.textContent = '';
          return;
        }
        const limit = r.limit;
        const usage = r.usage || {};
        const total = usage.total ?? 0;
        if(limit == null){
          badge.textContent = `æœ¬æ—¥ã®åˆ©ç”¨: ${total} å›ï¼ˆåˆ¶é™ãªã—ï¼‰`;
        }else{
          badge.textContent = `æœ¬æ—¥ã®åˆ©ç”¨: ${total} / ${limit} å›`;
        }
      }catch(e){
        // å¤±æ•—æ™‚ã¯é™ã‹ã«ä½•ã‚‚ã—ãªã„
      }
    }

    // ---- ä½¿ã„æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ« ----
    function openHowto(){
      const m = $('#howtoModal');
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ã€Œé–‰ã˜ã‚‹ã€ã«ç§»ã™ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã‚‚è¿·ã‚ãªã„ï¼‰
      setTimeout(()=>{ $('#btnHowtoClose').focus(); }, 0);
    }
    function closeHowto(){
      const m = $('#howtoModal');
      m.classList.remove('show');
      m.setAttribute('aria-hidden','true');
      // é–‹ã„ãŸãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
      setTimeout(()=>{ $('#btnHowto').focus(); }, 0);
    }

    // ---- åˆæœŸåŒ– ----
    async function boot(){
      loadSettings();
      try{
        await apiGet('/api/model');
      }catch(e){}
      await refreshStock();
      updateSubjectTabs();
      applyScienceConstraints();
      $('#settingsCard').style.display = 'none';
      refreshUsage();
    }

    // ---- ç”ŸæˆUIãƒ­ã‚¸ãƒƒã‚¯ ----
    function updateSubjectTabs(){
      document.querySelectorAll('.tab').forEach(el=>{
        el.classList.toggle('active', el.dataset.subject === subject);
      });
      const cat = $('#category');
      cat.innerHTML = '';
      if(subject==='ç¤¾ä¼š'){
        ['åœ°ç†','æ­´å²'].forEach(x=>{
          const o=document.createElement('option'); o.textContent=x; cat.appendChild(o);
        });
        $('#gradeBox').style.display='none';
      }else{
        ['ç”Ÿç‰©','åŒ–å­¦','åœ°å­¦','ç‰©ç†','å¤©ä½“'].forEach(x=>{
          const o=document.createElement('option'); o.textContent=x; cat.appendChild(o);
        });
        $('#gradeBox').style.display='';
        applyScienceConstraints();
      }
    }

    async function handleGenerate(){
      const payload = {
        subject,
        category: $('#category').value,
        grade: subject==='ç†ç§‘' ? $('#grade').value : '',
        difficulty: $('#difficulty').value,
        genre_hint: $('#genreHint').value,
        avoid_topics: $('#avoidTopics').value,
        include_hints: $('#includeHints').checked,
        length_hint: $('#lengthHint').value || '30ã€œ80å­—ç¨‹åº¦',
      };
      const btn = $('#btnGenerate');
      btn.disabled = true; const txt = btn.textContent; btn.textContent = 'ç”Ÿæˆä¸­â€¦';
      try{
        const res = await apiPost('/api/generate_question', payload);
        generatedRaw = res;
        let item = res.item || res.generated || {};
        if(res.item && res.item.question){
          currentItem = res.item;
        }else{
          currentItem = item;
        }
        renderGenerated(item, res.duplicate_of);
        await refreshStock();
        await refreshUsage();
        toast('å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
      }catch(e){
        console.error(e);
        if(e.code === 'quota_exceeded'){
          toast(e.message || 'ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®1æ—¥ã‚ãŸã‚Šã®åˆ©ç”¨å›æ•°ã‚’è¶…ãˆã¾ã—ãŸ', false);
        }else{
          toast('ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, false);
        }
        refreshUsage();
      }finally{
        btn.disabled = false; btn.textContent = txt;
      }
    }

    function renderGenerated(item, dupOf){
      $('#genResult').style.display = '';
      $('#genQuestion').textContent = item.question || '(empty)';
      $('#genModelAnswer').textContent = item.model_answer || '';
      $('#genExplanation').textContent = item.explanation || '';
      $('#genIntention').textContent = item.intention || '';
      const tags = item.tags || [];
      const meta = [];
      if(item.subject) meta.push(item.subject);
      if(item.category) meta.push(item.category);
      if(item.grade) meta.push(item.grade);
      if(item.difficulty) meta.push(item.difficulty);
      $('#genMeta').textContent = meta.join(' / ');
      const tagsBox = $('#genTags'); tagsBox.innerHTML='';
      tags.forEach(t=>{
        const s=document.createElement('span'); s.className='tag'; s.textContent=t; tagsBox.appendChild(s);
      });
      $('#dupNote').textContent = dupOf ? `ï¼ˆæ³¨ï¼‰ã‚¹ãƒˆãƒƒã‚¯å†…ã®é¡ä¼¼: ${dupOf}` : '';

      $('#hintBox').style.display = $('#toggleHints').checked ? '' : 'none';
      $('#genModelAnswerWrap').style.display = 'none';
      $('#genExplanationWrap').style.display = 'none';
      $('#genIntentionWrap').style.display = 'none';
    }

    // ---- ã‚¹ãƒˆãƒƒã‚¯ä¸€è¦§ï¼ˆlist / search å¯¾å¿œï¼‰ ----
    async function refreshStock(){
      const q = ($('#stockSearch')?.value || '').trim();
      const info = $('#stockSearchInfo');
      try{
        let r;
        if(q){
          // æ¤œç´¢ï¼ˆ/api/stock/searchï¼‰
          const qs = buildQueryString({ q, limit: 50, offset: 0 });
          r = await apiGet('/api/stock/search' + qs);
          info.textContent = `æ¤œç´¢ä¸­ï¼š"${q}"ï¼ˆãƒ’ãƒƒãƒˆ ${r.total ?? (r.items||[]).length} ä»¶ï¼‰`;
          renderStockList(r.items || [], { count: (r.items||[]).length, limit: r.limit ?? 50, total: r.total ?? (r.items||[]).length });
        }else{
          // é€šå¸¸ï¼ˆ/api/stock/listï¼‰
          r = await apiGet('/api/stock/list');
          info.textContent = '';
          renderStockList(r.items || [], { count: r.count, limit: r.limit, total: r.count });
        }
      }catch(e){
        console.error(e);
        const list = $('#stockList'); list.innerHTML='';
        const errDiv = document.createElement('div');
        errDiv.className = 'small danger';
        errDiv.textContent = 'å–å¾—ã«å¤±æ•—: ' + e.message;
        list.appendChild(errDiv);
        $('#stockCount').textContent = '';
        if(info) info.textContent = '';
      }
    }

    function renderStockList(items, meta){
      const list = $('#stockList'); list.innerHTML='';
      items.forEach(it=>{
        const div=document.createElement('div'); div.className='item';

        const topWrap=document.createElement('div');
        topWrap.className='small muted';
        topWrap.textContent = `${(it.subject||'')}${it.category? ' / '+it.category:''}${it.grade? ' / '+it.grade:''} / ${it.difficulty||''}`;

        const q=document.createElement('div'); q.style.margin='6px 0'; q.textContent = it.question || '';

        const actions=document.createElement('div'); actions.className='flex';
        const useBtn=document.createElement('button'); useBtn.className='btn'; useBtn.textContent='ã“ã®å•é¡Œã‚’ä½¿ã†';
        useBtn.onclick=()=>{ useStock(it); };
        actions.appendChild(useBtn);

        // delete ã¯ ACCESS_CODE è¨­å®šæ™‚ã®ã¿è¡¨ç¤ºï¼ˆæ—¢å­˜ä»•æ§˜ã‚’ç¶­æŒï¼‰
        if(cfg.accessCode){
          const del=document.createElement('button'); del.className='btn err'; del.textContent='å‰Šé™¤';
          del.onclick=()=>deleteStock(it.id);
          actions.appendChild(del);
        }

        div.appendChild(topWrap); div.appendChild(q); div.appendChild(actions);
        list.appendChild(div);
      });

      const count = meta?.count ?? items.length;
      const limit = meta?.limit ?? '';
      const total = meta?.total ?? count;
      if(limit !== ''){
        $('#stockCount').textContent = `è¡¨ç¤º: ${count} ä»¶ / å…¨ä½“ ${total} ä»¶ï¼ˆä¸Šé™ ${limit}ï¼‰`;
      }else{
        $('#stockCount').textContent = `è¡¨ç¤º: ${count} ä»¶ / å…¨ä½“ ${total} ä»¶`;
      }
    }

    async function deleteStock(id){
      if(!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try{
        await apiPost('/api/stock/delete', {id});
        toast('å‰Šé™¤ã—ã¾ã—ãŸ');
        await refreshStock();
      }catch(e){
        toast('å‰Šé™¤ã«å¤±æ•—: ' + e.message, false);
      }
    }

    async function stockRandom(){
      // æ¤œç´¢æ¬„ãŒå…¥ã£ã¦ã„ã‚Œã° q ã‚’ä½¿ã†ï¼ˆç„¡ã‘ã‚Œã°å…¨ä½“ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
      const q = ($('#stockSearch')?.value || '').trim();
      const qs = buildQueryString({ q });
      try{
        const r = await apiGet('/api/stock/random' + qs);
        if(r && r.ok && r.item){
          useStock(r.item);
          toast('ãƒ©ãƒ³ãƒ€ãƒ ã§1å•é¸ã³ã¾ã—ãŸ');
        }else{
          toast('å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', false);
        }
      }catch(e){
        toast('ãƒ©ãƒ³ãƒ€ãƒ å–å¾—ã«å¤±æ•—: ' + e.message, false);
      }
    }

    function useStock(it){
      currentItem = it;
      $('#currentQuestionText').textContent = it.question || '';
      $('#currentModel').textContent = it.model_answer || '';
      $('#currentExpl').textContent = it.explanation || '';
      $('#currentIntn').textContent = it.intention || '';

      $('#currentHintBox').style.display = $('#showCurrentHints').checked ? '' : 'none';
      $('#currentModelWrap').style.display = 'none';
      $('#currentExplWrap').style.display = 'none';
      $('#currentIntnWrap').style.display = 'none';

      $('#studentAnswer').value = '';
      $('#gradeResult').style.display = 'none';

      window.scrollTo({top:0,behavior:'smooth'});
      toast('æ¡ç‚¹å¯¾è±¡ã«ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }

    // ---- æ¡ç‚¹ ----
    async function handleGrade(){
      if(!currentItem || !currentItem.question){
        toast('å…ˆã«å•é¡Œã‚’é¸ã¶ã‹ç”Ÿæˆã—ã¦ãã ã•ã„', false); return;
      }
      const body = {
        question: currentItem.question,
        student_answer: $('#studentAnswer').value || '',
        difficulty: $('#gradeDifficulty').value
      };
      if($('#includeModelForGrading').checked && currentItem.model_answer){
        body.model_answer = currentItem.model_answer;
      }
      if(!body.student_answer.trim()){
        toast('è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', false); return;
      }
      const btn = $('#btnGrade');
      btn.disabled = true; const txt = btn.textContent; btn.textContent = 'æ¡ç‚¹ä¸­â€¦';
      try{
        const r = await apiPost('/api/grade_answer', body);
        $('#gradeResult').style.display='';
        $('#scoreLine').textContent = `ã‚¹ã‚³ã‚¢: 10ç‚¹ä¸­${r.score}ç‚¹`;
        $('#commentary').textContent = r.commentary || '';
        $('#gradedModel').textContent = r.model_answer || '';
        const ul = $('#reasons'); ul.innerHTML='';
        (r.reasons||[]).forEach(s=>{
          const li=document.createElement('li'); li.textContent=s; ul.appendChild(li);
        });

        // âœ… è¿½åŠ ï¼šæº€ç‚¹ï¼ˆâ—‹ï¼‰ã«ãªã‚‹ç¢ºç‡è¡¨ç¤º
        const prob = (r.perfect_probability ?? null);
        const note = (r.perfect_probability_note ?? '').toString().trim();
        const line = $('#perfectProbLine');
        if(line){
          if(prob === null || prob === undefined){
            line.textContent = '';
          }else{
            line.textContent = `æº€ç‚¹ï¼ˆâ—‹ï¼‰ã«ãªã‚‹ç¢ºç‡: ${prob}%${note ? `ï¼ˆ${note}ï¼‰` : ''}`;
          }
        }

        await refreshUsage();
        toast('æ¡ç‚¹ã—ã¾ã—ãŸ');
      }catch(e){
        console.error(e);
        if(e.code === 'quota_exceeded'){
          toast(e.message || 'ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®1æ—¥ã‚ãŸã‚Šã®åˆ©ç”¨å›æ•°ã‚’è¶…ãˆã¾ã—ãŸ', false);
        }else{
          toast('æ¡ç‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, false);
        }
        refreshUsage();
      }finally{
        btn.disabled = false; btn.textContent = txt;
      }
    }

    // ---- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãDLï¼‰----
    async function downloadEndpoint(path, filename){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ---- ã‚¤ãƒ™ãƒ³ãƒˆçµç·š ----
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.tab')){
        subject = e.target.closest('.tab').dataset.subject;
        updateSubjectTabs();
      }
    });
    document.addEventListener('keydown', (e)=>{
      const t = e.target.closest('.tab');
      if(t && (e.key === 'Enter' || e.key === ' ')){ t.click(); e.preventDefault(); }
    });

    $('#grade').onchange = applyScienceConstraints;

    $('#btnGenerate').onclick = handleGenerate;
    $('#toggleHints').onchange = ()=> {
      const on = $('#toggleHints').checked;
      $('#hintBox').style.display = on ? '' : 'none';
      if(!on){
        $('#genModelAnswerWrap').style.display = 'none';
        $('#genExplanationWrap').style.display = 'none';
        $('#genIntentionWrap').style.display = 'none';
      }
    };

    $('#btnToggleGenModel').onclick = ()=>{
      const w = $('#genModelAnswerWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleGenExpl').onclick = ()=>{
      const w = $('#genExplanationWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleGenIntn').onclick = ()=>{
      const w = $('#genIntentionWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };

    $('#btnUseForGrading').onclick = ()=>{
      if(!generatedRaw){ toast('å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„', false); return; }
      const item = (generatedRaw.item || generatedRaw.generated);
      useStock(item);
    };

    $('#showCurrentHints').onchange = ()=>{
      const on = $('#showCurrentHints').checked;
      $('#currentHintBox').style.display = on ? '' : 'none';
      if(!on){
        $('#currentModelWrap').style.display = 'none';
        $('#currentExplWrap').style.display = 'none';
        $('#currentIntnWrap').style.display = 'none';
      }
    };

    $('#btnToggleCurModel').onclick = ()=>{
      const w = $('#currentModelWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleCurExpl').onclick = ()=>{
      const w = $('#currentExplWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleCurIntn').onclick = ()=>{
      const w = $('#currentIntnWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };

    $('#btnGrade').onclick = handleGrade;
    $('#btnClearAnswer').onclick = ()=>{ $('#studentAnswer').value=''; $('#gradeResult').style.display='none'; };

    $('#btnExportJson').onclick = ()=> downloadEndpoint('/api/export/stocks.json', 'stocks.json').catch(e=>toast('DLå¤±æ•—: '+e.message,false));
    $('#btnExportCsv').onclick = ()=> downloadEndpoint('/api/export/stocks.csv', 'stocks.csv').catch(e=>toast('DLå¤±æ•—: '+e.message,false));
    $('#btnExportGrading').onclick = ()=> downloadEndpoint('/api/export/grading.jsonl', 'grading.jsonl').catch(e=>toast('DLå¤±æ•—: '+e.message,false));

    $('#btnSettings').onclick = ()=> $('#settingsCard').style.display='';
    $('#btnHideSettings').onclick = ()=> $('#settingsCard').style.display='none';
    $('#btnSaveSettings').onclick = ()=> { saveSettings(); boot(); };
    $('#btnReload').onclick = boot;

    // âœ… ã‚¹ãƒˆãƒƒã‚¯æ¤œç´¢ãƒ»ã‚¯ãƒªã‚¢ãƒ»ãƒ©ãƒ³ãƒ€ãƒ 
    $('#btnStockSearch').onclick = ()=> refreshStock();
    $('#btnStockClearSearch').onclick = ()=>{ $('#stockSearch').value=''; refreshStock(); };
    $('#btnStockRandom').onclick = stockRandom;
    $('#stockSearch').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ refreshStock(); e.preventDefault(); }
    });

    // âœ… ä½¿ã„æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰
    $('#btnHowto').onclick = openHowto;
    $('#btnHowtoClose').onclick = closeHowto;
    $('#howtoModal').addEventListener('click', (e)=>{
      if(e.target === e.currentTarget) closeHowto(); // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    });
    document.addEventListener('keydown', (e)=>{
      const m = $('#howtoModal');
      if(e.key === 'Escape' && m.classList.contains('show')) closeHowto();
    });

    // èµ·å‹•
    boot();
  </script>
</body>
</html>
