<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>記述式API（個人運用版）UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 外部CSSを読み込み（キャッシュ対策で ?v= を付与） -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=20260102">
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="flex" style="gap:10px">
        <h1>記述式API（個人運用UI）</h1>
        <span id="modelTag" class="tag" aria-hidden="true">model: ...</span>
      </div>
      <div class="flex" style="gap:8px;align-items:center">
        <span id="usageBadge" class="pill small" aria-live="polite"></span>

        <!-- ✅ ここが「表示欄」：必ず見える場所に配置 -->
        <button class="btn brand" id="btnHowto" title="使い方説明を開く">使い方説明</button>

        <button class="btn ghost" id="btnSettings">設定</button>
        <button class="btn ghost" id="btnReload">再読込</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px;padding-bottom:40px">

    <!-- 設定 -->
    <div class="card" id="settingsCard" style="display:none">
      <h2>接続設定</h2>
      <div class="grid-2">
        <div>
          <label for="baseUrl">API Base URL（空=同一オリジン）</label>
          <input type="text" id="baseUrl" placeholder="例 https://your.onrender.com" aria-describedby="baseUrlHelp" />
          <div id="baseUrlHelp" class="small muted">CORSを設定済みのURLを指定。空欄なら同一オリジンを使用。</div>
        </div>
        <div>
          <label for="accessCode">ACCESS_CODE（保護API用 / 任意）</label>
          <input type="text" id="accessCode" placeholder="ヘッダーに X-Access-Code として付与" aria-describedby="accessCodeHelp" />
          <div id="accessCodeHelp" class="small muted">設定すると生成・採点・削除・エクスポートに必要な認証ヘッダーが付与されます。</div>
        </div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn brand" id="btnSaveSettings">保存</button>
        <button class="btn" id="btnHideSettings">閉じる</button>
        <span id="statusLine" class="small muted"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <!-- 左：生成 & ストック -->
      <section class="card">
        <div class="toolbar">
          <h2>① 出題の生成 & ストック</h2>
          <div class="flex">
            <button class="btn" id="btnExportJson">📦 stocks.json</button>
            <button class="btn" id="btnExportCsv">📊 stocks.csv</button>
          </div>
        </div>

        <div class="flex" style="gap:6px;margin-bottom:8px">
          <span class="tab active" data-subject="社会" tabindex="0">社会</span>
          <span class="tab" data-subject="理科" tabindex="0">理科</span>
        </div>

        <div class="grid-2">
          <div>
            <label>分類（科目）</label>
            <select id="category">
              <option>地理</option>
              <option>歴史</option>
            </select>
          </div>
          <div id="gradeBox" style="display:none">
            <label>学年（理科のみ）</label>
            <select id="grade">
              <option>中1</option>
              <option>中2</option>
              <option selected>中3</option>
            </select>
          </div>
          <div>
            <label>難易度/配点</label>
            <select id="difficulty">
              <option>5点</option>
              <option selected>10点</option>
              <option>満点</option>
            </select>
          </div>
          <div>
            <label>解答分量の目安</label>
            <input type="text" id="lengthHint" value="30〜80字程度" maxlength="40">
          </div>
          <div>
            <label>出題の方向性（任意）</label>
            <input type="text" id="genreHint" placeholder="制度/文化/時代背景 など" maxlength="120">
          </div>
          <div>
            <label>避ける話題（任意）</label>
            <input type="text" id="avoidTopics" placeholder="例：稲作は避けたい" maxlength="120">
          </div>
        </div>

        <div class="flex" style="margin-top:8px">
          <label class="pill"><input type="checkbox" id="includeHints"> ヒント（模範解答等）も生成に含める</label>
          <button class="btn brand" id="btnGenerate">問題を自動生成</button>
        </div>

        <div id="genResult" style="margin-top:12px;display:none">
          <h3>生成結果</h3>
          <div class="qcard">
            <div class="small muted" id="genMeta"></div>
            <div id="genQuestion" style="margin:8px 0;font-size:15px;line-height:1.6"></div>
            <div class="flex" id="genTags" style="gap:6px;flex-wrap:wrap"></div>
            <div class="divider"></div>
            <div class="flex" style="gap:8px;align-items:center">
              <button class="btn" id="btnUseForGrading">この問題で採点へ</button>
              <label class="pill"><input type="checkbox" id="toggleHints"> ヒントを表示</label>
              <span id="dupNote" class="small"></span>
            </div>
            <div id="hintBox" class="hint" style="display:none;margin-top:10px">
              <div style="margin-bottom:6px">
                <button class="btn small" id="btnToggleGenModel" type="button">模範解答を表示</button>
                <div id="genModelAnswerWrap" style="display:none;margin-top:4px">
                  <span class="caps">模範解答</span>
                  <div id="genModelAnswer" class="mono"></div>
                </div>
              </div>
              <div class="divider"></div>
              <div style="margin:6px 0">
                <button class="btn small" id="btnToggleGenExpl" type="button">解説を表示</button>
                <div id="genExplanationWrap" style="display:none;margin-top:4px">
                  <span class="caps">解説</span>
                  <div id="genExplanation"></div>
                </div>
              </div>
              <div class="divider"></div>
              <div style="margin-top:6px">
                <button class="btn small" id="btnToggleGenIntn" type="button">出題意図を表示</button>
                <div id="genIntentionWrap" style="display:none;margin-top:4px">
                  <span class="caps">出題意図</span>
                  <div id="genIntention"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3>ストック（最新10件）</h3>

          <!-- ✅ 追加（レイアウトは維持）：検索・ランダム -->
          <div class="flex" style="gap:8px;margin:8px 0 6px">
            <input type="text" id="stockSearch" placeholder="ストック検索（キーワード）" style="flex:1;min-width:220px" maxlength="120">
            <button class="btn" id="btnStockSearch">検索</button>
            <button class="btn" id="btnStockClearSearch">クリア</button>
            <button class="btn" id="btnStockRandom" title="条件に合うストックから1問ランダムに選びます">ランダム</button>
          </div>
          <div class="small muted" id="stockSearchInfo"></div>

          <div class="list" id="stockList"></div>
          <div class="small muted" id="stockCount"></div>
        </div>
      </section>

      <!-- 右：採点 -->
      <section class="card">
        <div class="toolbar">
          <h2>② 採点</h2>
          <button class="btn" id="btnExportGrading">🧾 grading.jsonl</button>
        </div>

        <!-- ✅ 追加：採点の観点を固定表示（常に見える） -->
        <div class="qcard" id="rubricCard"
             style="margin-top:10px; position: sticky; top: 82px; z-index: 2;">
          <div class="small muted" style="font-weight:700">採点の観点（何を見られてるか）</div>
          <ul id="rubricList" style="margin:6px 0 0;padding-left:18px;line-height:1.7"></ul>
          <div id="rubricHint" class="small muted" style="margin-top:6px"></div>
        </div>

        <div class="qcard" style="margin-top:10px">
          <div class="small muted">対象問題</div>
          <div id="currentQuestionText" style="margin:6px 0 8px;line-height:1.6"></div>
          <div class="flex" style="gap:8px;align-items:center">
            <label class="pill"><input type="checkbox" id="includeModelForGrading"> 採点に模範解答も渡す（安定化）</label>
            <label class="pill"><input type="checkbox" id="showCurrentHints"> ヒントを表示</label>
          </div>
          <div id="currentHintBox" class="hint" style="display:none;margin-top:8px">
            <div style="margin-bottom:6px">
              <button class="btn small" id="btnToggleCurModel" type="button">模範解答を表示</button>
              <div id="currentModelWrap" style="display:none;margin-top:4px">
                <span class="caps">模範解答</span>
                <div id="currentModel" class="mono"></div>
              </div>
            </div>
            <div class="divider"></div>
            <div style="margin:6px 0">
              <button class="btn small" id="btnToggleCurExpl" type="button">解説を表示</button>
              <div id="currentExplWrap" style="display:none;margin-top:4px">
                <span class="caps">解説</span>
                <div id="currentExpl"></div>
              </div>
            </div>
            <div class="divider"></div>
            <div style="margin-top:6px">
              <button class="btn small" id="btnToggleCurIntn" type="button">出題意図を表示</button>
              <div id="currentIntnWrap" style="display:none;margin-top:4px">
                <span class="caps">出題意図</span>
                <div id="currentIntn"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex-col" style="margin-top:10px">
          <label>あなたの解答</label>
          <textarea id="studentAnswer" placeholder="ここに解答を記入（30〜80字目安）" maxlength="2000"></textarea>
        </div>
        <div class="flex" style="margin-top:10px">
          <select id="gradeDifficulty">
            <option>5点</option>
            <option selected>10点</option>
            <option>満点</option>
          </select>
          <button class="btn brand" id="btnGrade">採点する</button>
          <button class="btn" id="btnClearAnswer">クリア</button>
        </div>

        <div id="gradeResult" style="margin-top:12px;display:none">
          <h3>採点結果</h3>
          <div class="qcard">
            <div id="scoreLine" class="success" style="font-weight:700"></div>

            <!-- ✅ 満点確率表示 -->
            <div id="perfectProbLine" class="small muted" style="margin-top:4px"></div>

            <div id="commentary" style="margin:6px 0 8px"></div>

            <div class="small muted">理由</div>
            <ul id="reasons" style="margin-top:4px"></ul>

            <!-- ✅ 追加：次の一手（行動） -->
            <div class="divider" style="margin:12px 0"></div>

            <div id="weakTagsWrap" style="display:none">
              <div class="small muted">弱点タグ</div>
              <div id="weakTags" class="flex" style="gap:6px;flex-wrap:wrap;margin-top:4px"></div>
            </div>

            <div id="nextStepsWrap" style="display:none;margin-top:10px">
              <div class="small muted">次の一手（1〜3個・短く）</div>
              <ul id="nextSteps" style="margin-top:4px"></ul>
            </div>

            <div id="practiceMenuWrap" style="display:none;margin-top:10px">
              <div class="small muted">練習メニュー（すぐできる）</div>
              <ul id="practiceMenu" style="margin-top:4px"></ul>
            </div>

            <div class="divider" style="margin:12px 0"></div>
            <div class="small muted">参考：模範解答</div>
            <div id="gradedModel" class="mono"></div>
          </div>

          <!-- ✅ 追加：再挑戦（同じ問題で即リトライ） -->
          <div class="flex" style="gap:8px;margin-top:10px">
            <button class="btn brand" id="btnRetrySame">同じ問題でもう一回</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- =========================
       ✅ 使い方説明モーダル（小ウィンドウ）
       ========================= -->
  <div class="modal" id="howtoModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
      <div class="panelHeader">
        <div>
          <h2 class="panelTitle" id="howtoTitle">使い方説明（はじめての方向け）</h2>
          <div class="small muted">迷ったらこの画面を開いて、上から順番に進めてください。</div>
        </div>
        <div class="flex" style="gap:8px">
          <button class="btn" id="btnHowtoClose" aria-label="使い方説明を閉じる">閉じる</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="callout">
          <div style="font-weight:700;margin-bottom:6px">このUIでできること</div>
          <ul style="margin:0;padding-left:18px;line-height:1.8">
            <li><b>出題（記述問題）の自動生成</b>：社会/理科の記述問題を、入試・定期テスト想定で作れます。</li>
            <li><b>採点（10点満点）</b>：生徒の解答を入力すると、点数と講評・理由・模範解答を返します。</li>
            <li><b>ストック保存</b>：生成した問題を最大10件まで保存し、あとで呼び出して使えます。</li>
            <li><b>エクスポート</b>：stocks / grading のデータを書き出し、バックアップや共有に使えます。</li>
          </ul>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div class="step">
          <h3>0. まず最初に：接続設定（必要な人だけ）</h3>
          <ol>
            <li>右上の <b>「設定」</b> をクリックします。</li>
            <li><b>API Base URL</b>：
              <ul>
                <li>同じサーバー内でUIを配っているなら <b>空欄のまま</b> でOKです。</li>
                <li>別URLのAPIに繋ぐなら、例のように <span class="mono">https://xxxx.onrender.com</span> の形で入力します。</li>
              </ul>
            </li>
            <li><b>ACCESS_CODE</b>：
              <ul>
                <li>サーバー側でACCESS_CODEを設定している場合はここに入力します（未設定なら空でOK）。</li>
                <li>これが合っていないと <b>403 Forbidden</b> になります。</li>
              </ul>
            </li>
            <li><b>保存</b> → 右上の <b>再読込</b> を押して反映します。</li>
          </ol>
          <div class="mini">よくある失敗：URLの末尾に <span class="mono">/</span> が入っていて二重スラッシュになる → つながらない、など。</div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>1. 出題を自動生成する（左側：① 出題の生成）</h3>
          <ol>
            <li>上のタブで <b>社会</b> / <b>理科</b> を選びます。</li>
            <li><b>分類</b> を選びます：
              <ul>
                <li>社会：地理 / 歴史</li>
                <li>理科：生物 / 化学 / 地学 / 物理 / 天体（※天体は中3のみ）</li>
              </ul>
            </li>
            <li>理科の場合は <b>学年</b> も選びます（中1/中2/中3）。</li>
            <li><b>難易度/配点</b> を選びます（5点/10点/満点）。</li>
            <li><b>出題の方向性</b>（任意）：例）「制度」「文化」「因果関係」「比較」など。</li>
            <li><b>避ける話題</b>（任意）：例）「稲作は避けたい」など、偏り防止に使えます。</li>
            <li><b>問題を自動生成</b> を押します。</li>
          </ol>
          <div class="mini">
            生成結果が出たら「この問題で採点へ」で右側の採点対象にセットできます。<br>
            「ヒントを表示」をONにすると、模範解答・解説・出題意図を確認できます（必要な時だけ開く設計です）。
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>2. ストックを使う（左下：ストック一覧）</h3>
          <ol>
            <li>ストック（最新10件）には、生成した問題が自動で保存されます。</li>
            <li>使いたい問題の <b>「この問題を使う」</b> を押すと、右側の「対象問題」にセットされます。</li>
            <li>追加機能：
              <ul>
                <li><b>検索</b>：キーワードでストックを絞り込みできます。</li>
                <li><b>ランダム</b>：ストックから1問ランダムに選んで採点対象にできます。</li>
              </ul>
            </li>
            <li>ストックを外部保存したい場合：
              <ul>
                <li><b>stocks.json</b>：データの完全バックアップ（他サーバーへの移行にも向きます）</li>
                <li><b>stocks.csv</b>：Excelで見やすい形式（一覧確認・編集に便利）</li>
              </ul>
            </li>
          </ol>
          <div class="mini">※ストックは上限10件。古いものから自動で消える設計です（運用で増やすことも可能）。</div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>3. 採点する（右側：② 採点）</h3>
          <ol>
            <li>まず <b>対象問題</b> に問題が入っているか確認します（空なら左のストックから選ぶ or 生成します）。</li>
            <li>必要に応じて：
              <ul>
                <li><b>採点に模範解答も渡す（安定化）</b>：ONにすると部分点や表現ゆれの判断が安定しやすいです。</li>
                <li><b>ヒントを表示</b>：問題の意図や模範解答を確認したいときだけON。</li>
              </ul>
            </li>
            <li>解答欄に、生徒の解答を入力します（目安30〜80字）。</li>
            <li>右下の <b>採点する</b> を押します。</li>
            <li>結果として <b>10点中◯点</b>、講評、理由、参考模範解答が表示されます。</li>
          </ol>
          <div class="mini">
            追加表示：<b>満点（○）になる確率</b> も出ます（表現の曖昧さ・要点漏れの可能性も加味した目安）。<br>
            「クリア」は解答欄と表示結果だけを消します（問題そのものは消えません）。
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="step">
          <h3>4. ログやエクスポート（記録を残したいとき）</h3>
          <ul style="line-height:1.85">
            <li><b>grading.jsonl</b>：採点履歴のログです（いつ・どの問題を採点したかが残ります）。</li>
            <li><b>logs.zip</b>（URL直打ちで取得）：運用・不具合調査用のログ一式です。管理者が原因調査するときに使います。</li>
          </ul>
          <div class="mini">
            logs.zip はUIにボタンを置いていない場合でも、サーバー側に機能があります。<br>
            例：<span class="mono">https://あなたのURL/logs.zip</span>（ACCESS_CODE設定時は必要）
          </div>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div class="step">
          <h3>よくあるエラーと対処</h3>
          <ul style="line-height:1.85">
            <li><b>403 Forbidden</b>：ACCESS_CODEが未入力/違う → 設定画面で正しい値を入力して保存。</li>
            <li><b>CORSエラー</b>：API側の <span class="mono">ALLOWED_ORIGIN</span> にUIのURLが入っていない → サーバー環境変数を修正。</li>
            <li><b>OpenAI API error</b>：サーバー側のAPIキー/モデル設定が原因 → <span class="mono">/status</span>（認証あり）で確認。</li>
            <li><b>quota_exceeded</b>：無料回数上限 → 翌日リセット、もしくは上限設定を変更。</li>
          </ul>
        </div>

        <div class="small muted" style="margin-top:10px">
          ヒント：このモーダルは <span class="kbd">Esc</span> でも閉じられます。背景クリックでも閉じます。
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ---- 設定の永続化 ----
    const $ = (q)=>document.querySelector(q);
    const cfg = {
      get baseUrl(){ return localStorage.getItem('baseUrl') || ''; },
      set baseUrl(v){ localStorage.setItem('baseUrl', v||''); },
      get accessCode(){ return localStorage.getItem('accessCode') || ''; },
      set accessCode(v){ localStorage.setItem('accessCode', v||''); },
      endpoint(p){ const b=this.baseUrl.trim(); return (b?b.replace(/\/$/,''):'') + p; }
    };

    // ---- 追加：観点（固定表示のデフォルト） ----
    const DEFAULT_RUBRIC = [
      {key:'要点', desc:'問われている答えが入っている'},
      {key:'因果', desc:'理由→結論がつながっている'},
      {key:'用語', desc:'重要語句が入っている'},
      {key:'表現', desc:'主語・比較・具体性が明確'}
    ];
    const DEFAULT_RUBRIC_HINT = '迷ったら「原因→結果」「重要語句」「比較の軸」を意識すると点が伸びやすいです。';

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function renderRubric(rubric, hint){
      const list = $('#rubricList');
      const hintEl = $('#rubricHint');
      if(!list || !hintEl) return;

      const r = (Array.isArray(rubric) && rubric.length) ? rubric : DEFAULT_RUBRIC;
      list.innerHTML = '';
      r.forEach(x=>{
        const k = x?.key ?? '';
        const d = x?.desc ?? '';
        const li = document.createElement('li');
        li.innerHTML = `<b>${escapeHtml(k)}</b>：${escapeHtml(d)}`;
        list.appendChild(li);
      });
      hintEl.textContent = (hint || DEFAULT_RUBRIC_HINT);
    }

    function clearGradeResultUI(){
      const gr = $('#gradeResult');
      if(gr) gr.style.display = 'none';

      const scoreLine = $('#scoreLine'); if(scoreLine) scoreLine.textContent = '';
      const perfectProbLine = $('#perfectProbLine'); if(perfectProbLine) perfectProbLine.textContent = '';
      const commentary = $('#commentary'); if(commentary) commentary.textContent = '';
      const gradedModel = $('#gradedModel'); if(gradedModel) gradedModel.textContent = '';
      const reasons = $('#reasons'); if(reasons) reasons.innerHTML = '';

      const weakWrap = $('#weakTagsWrap'); if(weakWrap) weakWrap.style.display = 'none';
      const weakTags = $('#weakTags'); if(weakTags) weakTags.innerHTML = '';

      const nsWrap = $('#nextStepsWrap'); if(nsWrap) nsWrap.style.display = 'none';
      const ns = $('#nextSteps'); if(ns) ns.innerHTML = '';

      const pmWrap = $('#practiceMenuWrap'); if(pmWrap) pmWrap.style.display = 'none';
      const pm = $('#practiceMenu'); if(pm) pm.innerHTML = '';
    }

    // ---- 共通Fetch ----
    async function apiGet(path){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok){
        if(res.status === 403) throw new Error('403 Forbidden: ACCESS_CODE が必要/不一致の可能性');
        let msg = `${res.status} ${res.statusText}`;
        try {
          const j = await res.json();
          if(j && j.error){ msg += `: ${j.error}`; }
          if(j && j.message && !msg.includes(j.message)){ msg += ` / ${j.message}`; }
        } catch(e){}
        throw new Error(msg);
      }
      try{
        return await res.json();
      }catch(e){
        return {};
      }
    }

    async function apiPost(path, body){
      const headers = {'Content-Type':'application/json'};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {method:'POST', headers, body: JSON.stringify(body||{})});
      let data = null;
      try{
        data = await res.json();
      }catch(e){
        data = null;
      }
      if(!res.ok){
        // quota_exceeded（429）の場合は専用扱い
        if(res.status === 429 && data && data.error === 'quota_exceeded'){
          const err = new Error(data.message || '無料プランの1日あたりの利用回数を超えています。');
          err.code = 'quota_exceeded';
          err.status = 429;
          throw err;
        }
        if(res.status === 403){
          const err = new Error('403 Forbidden: ACCESS_CODE が必要/不一致の可能性');
          err.code = 'forbidden';
          err.status = 403;
          throw err;
        }
        let msg = `${res.status} ${res.statusText}`;
        if(data){
          if(data.error) msg += `: ${data.error}`;
          if(data.message && !msg.includes(data.message)) msg += ` / ${data.message}`;
        }
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }
      return data || {};
    }

    function toast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.style.background = ok ? '#111827' : '#ef4444';
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }

    function buildQueryString(params){
      const sp = new URLSearchParams();
      Object.entries(params || {}).forEach(([k,v])=>{
        if(v === undefined || v === null) return;
        const s = String(v).trim();
        if(!s) return;
        sp.set(k, s);
      });
      const qs = sp.toString();
      return qs ? `?${qs}` : '';
    }

    // ---- UI状態 ----
    let subject = '社会';
    let currentItem = null;
    let generatedRaw = null;

    // ---- 設定UI ----
    function loadSettings(){
      $('#baseUrl').value = cfg.baseUrl;
      $('#accessCode').value = cfg.accessCode;
    }
    function saveSettings(){
      cfg.baseUrl = $('#baseUrl').value.trim();
      cfg.accessCode = $('#accessCode').value.trim();
      $('#statusLine').textContent = '保存しました';
      setTimeout(()=>$('#statusLine').textContent='', 1500);
    }

    // ---- 学年とカテゴリの整合（理科：天体は中3のみ）----
    function applyScienceConstraints(){
      if(subject!=='理科') return;
      const g = $('#grade').value;
      const cat = $('#category');
      [...cat.options].forEach(opt=>{
        if(opt.textContent==='天体'){
          opt.disabled = (g !== '中3');
          if(opt.disabled && cat.value==='天体'){
            cat.value = '地学';
          }
        }
      });
    }

    // ---- 利用状況バッジ ----
    async function refreshUsage(){
      const badge = $('#usageBadge');
      if(!badge) return;
      try{
        const r = await apiGet('/api/usage');
        if(!r || !r.ok){
          badge.textContent = '';
          return;
        }
        const limit = r.limit;
        const usage = r.usage || {};
        const total = usage.total ?? 0;
        if(limit == null){
          badge.textContent = `本日の利用: ${total} 回（制限なし）`;
        }else{
          badge.textContent = `本日の利用: ${total} / ${limit} 回`;
        }
      }catch(e){
        // 失敗時は静かに何もしない
      }
    }

    // ---- 使い方モーダル ----
    function openHowto(){
      const m = $('#howtoModal');
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
      setTimeout(()=>{ $('#btnHowtoClose').focus(); }, 0);
    }
    function closeHowto(){
      const m = $('#howtoModal');
      m.classList.remove('show');
      m.setAttribute('aria-hidden','true');
      setTimeout(()=>{ $('#btnHowto').focus(); }, 0);
    }

    // ---- 初期化 ----
    async function boot(){
      loadSettings();

      // まずは固定観点（デフォルト）を描画
      renderRubric(DEFAULT_RUBRIC, DEFAULT_RUBRIC_HINT);

      // model表示
      try{
        const m = await apiGet('/api/model');
        if(m && m.model) $('#modelTag').textContent = `model: ${m.model}`;
      }catch(e){}

      // /status（ACCESS_CODEがある場合だけ成功しやすい）からrubric更新
      try{
        const st = await apiGet('/status');
        if(st && st.rubric){
          renderRubric(st.rubric, st.rubric_hint);
        }
      }catch(e){
        // 403等は無視（オープン運用でも動くように）
      }

      await refreshStock();
      updateSubjectTabs();
      applyScienceConstraints();
      $('#settingsCard').style.display = 'none';
      refreshUsage();
    }

    // ---- 生成UIロジック ----
    function updateSubjectTabs(){
      document.querySelectorAll('.tab').forEach(el=>{
        el.classList.toggle('active', el.dataset.subject === subject);
      });
      const cat = $('#category');
      cat.innerHTML = '';
      if(subject==='社会'){
        ['地理','歴史'].forEach(x=>{
          const o=document.createElement('option'); o.textContent=x; cat.appendChild(o);
        });
        $('#gradeBox').style.display='none';
      }else{
        ['生物','化学','地学','物理','天体'].forEach(x=>{
          const o=document.createElement('option'); o.textContent=x; cat.appendChild(o);
        });
        $('#gradeBox').style.display='';
        applyScienceConstraints();
      }
    }

    async function handleGenerate(){
      const payload = {
        subject,
        category: $('#category').value,
        grade: subject==='理科' ? $('#grade').value : '',
        difficulty: $('#difficulty').value,
        genre_hint: $('#genreHint').value,
        avoid_topics: $('#avoidTopics').value,
        include_hints: $('#includeHints').checked,
        length_hint: $('#lengthHint').value || '30〜80字程度',
      };
      const btn = $('#btnGenerate');
      btn.disabled = true; const txt = btn.textContent; btn.textContent = '生成中…';
      try{
        const res = await apiPost('/api/generate_question', payload);
        generatedRaw = res;
        let item = res.item || res.generated || {};
        if(res.item && res.item.question){
          currentItem = res.item;
        }else{
          currentItem = item;
        }
        renderGenerated(item, res.duplicate_of);
        await refreshStock();
        await refreshUsage();
        toast('問題を生成しました');
      }catch(e){
        console.error(e);
        if(e.code === 'quota_exceeded'){
          toast(e.message || '無料プランの1日あたりの利用回数を超えました', false);
        }else{
          toast('生成に失敗しました: ' + e.message, false);
        }
        refreshUsage();
      }finally{
        btn.disabled = false; btn.textContent = txt;
      }
    }

    function renderGenerated(item, dupOf){
      $('#genResult').style.display = '';
      $('#genQuestion').textContent = item.question || '(empty)';
      $('#genModelAnswer').textContent = item.model_answer || '';
      $('#genExplanation').textContent = item.explanation || '';
      $('#genIntention').textContent = item.intention || '';
      const tags = item.tags || [];
      const meta = [];
      if(item.subject) meta.push(item.subject);
      if(item.category) meta.push(item.category);
      if(item.grade) meta.push(item.grade);
      if(item.difficulty) meta.push(item.difficulty);
      $('#genMeta').textContent = meta.join(' / ');
      const tagsBox = $('#genTags'); tagsBox.innerHTML='';
      tags.forEach(t=>{
        const s=document.createElement('span'); s.className='tag'; s.textContent=t; tagsBox.appendChild(s);
      });
      $('#dupNote').textContent = dupOf ? `（注）ストック内の類似: ${dupOf}` : '';

      $('#hintBox').style.display = $('#toggleHints').checked ? '' : 'none';
      $('#genModelAnswerWrap').style.display = 'none';
      $('#genExplanationWrap').style.display = 'none';
      $('#genIntentionWrap').style.display = 'none';
    }

    // ---- ストック一覧（list / search 対応） ----
    async function refreshStock(){
      const q = ($('#stockSearch')?.value || '').trim();
      const info = $('#stockSearchInfo');
      try{
        let r;
        if(q){
          const qs = buildQueryString({ q, limit: 50, offset: 0 });
          r = await apiGet('/api/stock/search' + qs);
          info.textContent = `検索中："${q}"（ヒット ${r.total ?? (r.items||[]).length} 件）`;
          renderStockList(r.items || [], { count: (r.items||[]).length, limit: r.limit ?? 50, total: r.total ?? (r.items||[]).length });
        }else{
          r = await apiGet('/api/stock/list');
          info.textContent = '';
          renderStockList(r.items || [], { count: r.count, limit: r.limit, total: r.count });
        }
      }catch(e){
        console.error(e);
        const list = $('#stockList'); list.innerHTML='';
        const errDiv = document.createElement('div');
        errDiv.className = 'small danger';
        errDiv.textContent = '取得に失敗: ' + e.message;
        list.appendChild(errDiv);
        $('#stockCount').textContent = '';
        if(info) info.textContent = '';
      }
    }

    function renderStockList(items, meta){
      const list = $('#stockList'); list.innerHTML='';
      items.forEach(it=>{
        const div=document.createElement('div'); div.className='item';

        const topWrap=document.createElement('div');
        topWrap.className='small muted';
        topWrap.textContent = `${(it.subject||'')}${it.category? ' / '+it.category:''}${it.grade? ' / '+it.grade:''} / ${it.difficulty||''}`;

        const q=document.createElement('div'); q.style.margin='6px 0'; q.textContent = it.question || '';

        const actions=document.createElement('div'); actions.className='flex';
        const useBtn=document.createElement('button'); useBtn.className='btn'; useBtn.textContent='この問題を使う';
        useBtn.onclick=()=>{ useStock(it); };
        actions.appendChild(useBtn);

        if(cfg.accessCode){
          const del=document.createElement('button'); del.className='btn err'; del.textContent='削除';
          del.onclick=()=>deleteStock(it.id);
          actions.appendChild(del);
        }

        div.appendChild(topWrap); div.appendChild(q); div.appendChild(actions);
        list.appendChild(div);
      });

      const count = meta?.count ?? items.length;
      const limit = meta?.limit ?? '';
      const total = meta?.total ?? count;
      if(limit !== ''){
        $('#stockCount').textContent = `表示: ${count} 件 / 全体 ${total} 件（上限 ${limit}）`;
      }else{
        $('#stockCount').textContent = `表示: ${count} 件 / 全体 ${total} 件`;
      }
    }

    async function deleteStock(id){
      if(!confirm('この問題を削除しますか？')) return;
      try{
        await apiPost('/api/stock/delete', {id});
        toast('削除しました');
        await refreshStock();
      }catch(e){
        toast('削除に失敗: ' + e.message, false);
      }
    }

    async function stockRandom(){
      const q = ($('#stockSearch')?.value || '').trim();
      const qs = buildQueryString({ q });
      try{
        const r = await apiGet('/api/stock/random' + qs);
        if(r && r.ok && r.item){
          useStock(r.item);
          toast('ランダムで1問選びました');
        }else{
          toast('候補が見つかりませんでした', false);
        }
      }catch(e){
        toast('ランダム取得に失敗: ' + e.message, false);
      }
    }

    function useStock(it){
      currentItem = it;
      $('#currentQuestionText').textContent = it.question || '';
      $('#currentModel').textContent = it.model_answer || '';
      $('#currentExpl').textContent = it.explanation || '';
      $('#currentIntn').textContent = it.intention || '';

      $('#currentHintBox').style.display = $('#showCurrentHints').checked ? '' : 'none';
      $('#currentModelWrap').style.display = 'none';
      $('#currentExplWrap').style.display = 'none';
      $('#currentIntnWrap').style.display = 'none';

      $('#studentAnswer').value = '';
      clearGradeResultUI();

      window.scrollTo({top:0,behavior:'smooth'});
      toast('採点対象にセットしました');
    }

    // ---- 採点 ----
    async function handleGrade(){
      if(!currentItem || !currentItem.question){
        toast('先に問題を選ぶか生成してください', false); return;
      }
      const body = {
        question: currentItem.question,
        student_answer: $('#studentAnswer').value || '',
        difficulty: $('#gradeDifficulty').value
      };
      if($('#includeModelForGrading').checked && currentItem.model_answer){
        body.model_answer = currentItem.model_answer;
      }
      if(!body.student_answer.trim()){
        toast('解答を入力してください', false); return;
      }
      const btn = $('#btnGrade');
      btn.disabled = true; const txt = btn.textContent; btn.textContent = '採点中…';
      try{
        const r = await apiPost('/api/grade_answer', body);

        // rubric（サーバーが返すなら更新）
        if(r && r.rubric){
          renderRubric(r.rubric, r.rubric_hint);
        }

        $('#gradeResult').style.display='';
        $('#scoreLine').textContent = `スコア: 10点中${r.score}点`;
        $('#commentary').textContent = r.commentary || '';
        $('#gradedModel').textContent = r.model_answer || '';

        const ul = $('#reasons'); ul.innerHTML='';
        (r.reasons||[]).forEach(s=>{
          const li=document.createElement('li'); li.textContent=s; ul.appendChild(li);
        });

        const prob = (r.perfect_probability ?? null);
        const note = (r.perfect_probability_note ?? '').toString().trim();
        const line = $('#perfectProbLine');
        if(line){
          if(prob === null || prob === undefined){
            line.textContent = '';
          }else{
            line.textContent = `満点（○）になる確率: ${prob}%${note ? `（${note}）` : ''}`;
          }
        }

        // ✅ 次の一手 / 弱点タグ / 練習メニュー
        const weakTags = Array.isArray(r.weak_tags) ? r.weak_tags : [];
        const nextSteps = Array.isArray(r.next_steps) ? r.next_steps : [];
        const practiceMenu = Array.isArray(r.practice_menu) ? r.practice_menu : [];

        const weakWrap = $('#weakTagsWrap');
        const weakBox = $('#weakTags');
        if(weakWrap && weakBox){
          weakBox.innerHTML = '';
          if(weakTags.length){
            weakWrap.style.display = '';
            weakTags.slice(0,3).forEach(t=>{
              const s=document.createElement('span');
              s.className='tag';
              s.textContent = t;
              weakBox.appendChild(s);
            });
          }else{
            weakWrap.style.display = 'none';
          }
        }

        const nsWrap = $('#nextStepsWrap');
        const nsUl = $('#nextSteps');
        if(nsWrap && nsUl){
          nsUl.innerHTML = '';
          if(nextSteps.length){
            nsWrap.style.display = '';
            nextSteps.slice(0,3).forEach(s=>{
              const li=document.createElement('li');
              li.textContent = s;
              nsUl.appendChild(li);
            });
          }else{
            nsWrap.style.display = 'none';
          }
        }

        const pmWrap = $('#practiceMenuWrap');
        const pmUl = $('#practiceMenu');
        if(pmWrap && pmUl){
          pmUl.innerHTML = '';
          if(practiceMenu.length){
            pmWrap.style.display = '';
            practiceMenu.slice(0,3).forEach(s=>{
              const li=document.createElement('li');
              li.textContent = s;
              pmUl.appendChild(li);
            });
          }else{
            pmWrap.style.display = 'none';
          }
        }

        await refreshUsage();
        toast('採点しました');
      }catch(e){
        console.error(e);
        if(e.code === 'quota_exceeded'){
          toast(e.message || '無料プランの1日あたりの利用回数を超えました', false);
        }else{
          toast('採点に失敗しました: ' + e.message, false);
        }
        refreshUsage();
      }finally{
        btn.disabled = false; btn.textContent = txt;
      }
    }

    // ---- エクスポート（ヘッダー付きDL）----
    async function downloadEndpoint(path, filename){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ---- イベント結線 ----
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.tab')){
        subject = e.target.closest('.tab').dataset.subject;
        updateSubjectTabs();
      }
    });
    document.addEventListener('keydown', (e)=>{
      const t = e.target.closest('.tab');
      if(t && (e.key === 'Enter' || e.key === ' ')){ t.click(); e.preventDefault(); }
    });

    $('#grade').onchange = applyScienceConstraints;

    $('#btnGenerate').onclick = handleGenerate;
    $('#toggleHints').onchange = ()=> {
      const on = $('#toggleHints').checked;
      $('#hintBox').style.display = on ? '' : 'none';
      if(!on){
        $('#genModelAnswerWrap').style.display = 'none';
        $('#genExplanationWrap').style.display = 'none';
        $('#genIntentionWrap').style.display = 'none';
      }
    };

    $('#btnToggleGenModel').onclick = ()=>{
      const w = $('#genModelAnswerWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleGenExpl').onclick = ()=>{
      const w = $('#genExplanationWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleGenIntn').onclick = ()=>{
      const w = $('#genIntentionWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };

    $('#btnUseForGrading').onclick = ()=>{
      if(!generatedRaw){ toast('先に生成してください', false); return; }
      const item = (generatedRaw.item || generatedRaw.generated);
      useStock(item);
    };

    $('#showCurrentHints').onchange = ()=>{
      const on = $('#showCurrentHints').checked;
      $('#currentHintBox').style.display = on ? '' : 'none';
      if(!on){
        $('#currentModelWrap').style.display = 'none';
        $('#currentExplWrap').style.display = 'none';
        $('#currentIntnWrap').style.display = 'none';
      }
    };

    $('#btnToggleCurModel').onclick = ()=>{
      const w = $('#currentModelWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleCurExpl').onclick = ()=>{
      const w = $('#currentExplWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleCurIntn').onclick = ()=>{
      const w = $('#currentIntnWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };

    $('#btnGrade').onclick = handleGrade;

    // ✅ 変更：クリアは「解答欄 + 採点結果表示だけ」を消す（問題は保持）
    $('#btnClearAnswer').onclick = ()=>{ $('#studentAnswer').value=''; clearGradeResultUI(); };

    // ✅ 追加：同じ問題でもう一回（即リトライ）
    $('#btnRetrySame').onclick = ()=>{
      $('#studentAnswer').value = '';
      clearGradeResultUI(); // 結果だけ消す（問題は保持）
      $('#studentAnswer').focus();
      toast('同じ問題で再挑戦できます');
    };

    $('#btnExportJson').onclick = ()=> downloadEndpoint('/api/export/stocks.json', 'stocks.json').catch(e=>toast('DL失敗: '+e.message,false));
    $('#btnExportCsv').onclick = ()=> downloadEndpoint('/api/export/stocks.csv', 'stocks.csv').catch(e=>toast('DL失敗: '+e.message,false));
    $('#btnExportGrading').onclick = ()=> downloadEndpoint('/api/export/grading.jsonl', 'grading.jsonl').catch(e=>toast('DL失敗: '+e.message,false));

    $('#btnSettings').onclick = ()=> $('#settingsCard').style.display='';
    $('#btnHideSettings').onclick = ()=> $('#settingsCard').style.display='none';
    $('#btnSaveSettings').onclick = ()=> { saveSettings(); boot(); };
    $('#btnReload').onclick = boot;

    // ✅ ストック検索・クリア・ランダム
    $('#btnStockSearch').onclick = ()=> refreshStock();
    $('#btnStockClearSearch').onclick = ()=>{ $('#stockSearch').value=''; refreshStock(); };
    $('#btnStockRandom').onclick = stockRandom;
    $('#stockSearch').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ refreshStock(); e.preventDefault(); }
    });

    // ✅ 使い方モーダルの開閉
    $('#btnHowto').onclick = openHowto;
    $('#btnHowtoClose').onclick = closeHowto;
    $('#howtoModal').addEventListener('click', (e)=>{
      if(e.target === e.currentTarget) closeHowto();
    });
    document.addEventListener('keydown', (e)=>{
      const m = $('#howtoModal');
      if(e.key === 'Escape' && m.classList.contains('show')) closeHowto();
    });

    // 起動
    boot();
  </script>
</body>
</html>
