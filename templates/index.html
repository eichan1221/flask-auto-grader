<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>記述式API（個人運用版）UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 外部CSSを読み込み（キャッシュ対策で ?v= を付与） -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=20260102">
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="flex" style="gap:10px">
        <h1>記述式API（個人運用UI）</h1>
        <span id="modelTag" class="tag" aria-hidden="true">model: ...</span>
      </div>
      <div class="flex" style="gap:8px;align-items:center">
        <span id="usageBadge" class="pill small" aria-live="polite"></span>

        <!-- ✅ ここが「表示欄」：必ず見える場所に配置 -->
        <button class="btn brand" id="btnHowto" title="使い方説明を開く">使い方説明</button>

        <button class="btn ghost" id="btnSettings">設定</button>
        <button class="btn ghost" id="btnReload">再読込</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px;padding-bottom:40px">

    <!-- 設定 -->
    <div class="card" id="settingsCard" style="display:none">
      <h2>接続設定</h2>
      <div class="grid-2">
        <div>
          <label for="baseUrl">API Base URL（空=同一オリジン）</label>
          <input type="text" id="baseUrl" placeholder="例 https://your.onrender.com" aria-describedby="baseUrlHelp" />
          <div id="baseUrlHelp" class="small muted">CORSを設定済みのURLを指定。空欄なら同一オリジンを使用。</div>
        </div>
        <div>
          <label for="accessCode">ACCESS_CODE（保護API用 / 任意）</label>
          <input type="text" id="accessCode" placeholder="ヘッダーに X-Access-Code として付与" aria-describedby="accessCodeHelp" />
          <div id="accessCodeHelp" class="small muted">設定すると生成・採点・削除などの保護APIに認証ヘッダーが付与されます。</div>
        </div>
        <div>
          <label for="exportCode">EXPORT_CODE（DL/ログ用 / 任意）</label>
          <input type="text" id="exportCode" placeholder="ヘッダーに X-Export-Code として付与" aria-describedby="exportCodeHelp" />
          <div id="exportCodeHelp" class="small muted">DL/ログ系のエクスポートは別コードで保護されます。</div>
        </div>
      </div>

      <div class="flex" style="margin-top:8px">
        <button class="btn brand" id="btnSaveSettings">保存</button>
        <button class="btn" id="btnHideSettings">閉じる</button>
        <span id="statusLine" class="small muted"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <!-- 左：生成 & ストック -->
      <section class="card">
        <div class="toolbar">
          <h2>① 出題の生成 & ストック</h2>
          <div class="flex">
            <button class="btn" id="btnExportJson">📦 stocks.json</button>
            <button class="btn" id="btnExportCsv">📊 stocks.csv</button>
          </div>
        </div>

        <div class="flex" style="gap:6px;margin-bottom:8px">
          <span class="tab active" data-subject="社会" tabindex="0">社会</span>
          <span class="tab" data-subject="理科" tabindex="0">理科</span>
        </div>

        <div class="grid-2">
          <div>
            <label>分類（科目）</label>
            <select id="category">
              <option>地理</option>
              <option>歴史</option>
            </select>
          </div>
          <div id="gradeBox" style="display:none">
            <label>学年（理科のみ）</label>
            <select id="grade">
              <option>中1</option>
              <option>中2</option>
              <option selected>中3</option>
            </select>
          </div>
          <div>
            <label>単元（任意）</label>
            <input type="text" id="unit" placeholder="例：鎌倉時代 / 光合成" maxlength="60">
          </div>
          <div>
            <label>難易度/配点</label>
            <select id="difficulty">
              <option>5点</option>
              <option selected>10点</option>
              <option>満点</option>
            </select>
          </div>
        </div>

        <details class="advanced" id="advancedSettings">
          <summary>詳細設定（Advanced）</summary>
          <div class="grid-2" style="margin-top:10px">
            <div>
              <label>解答分量の目安</label>
              <input type="text" id="lengthHint" value="30〜80字程度" maxlength="40">
            </div>
            <div>
              <label>出題の方向性（任意）</label>
              <input type="text" id="genreHint" placeholder="制度/文化/時代背景 など" maxlength="120">
            </div>
            <div>
              <label>避ける話題（任意）</label>
              <input type="text" id="avoidTopics" placeholder="例：稲作は避けたい" maxlength="120">
            </div>
            <div class="flex" style="align-items:center">
              <label class="pill"><input type="checkbox" id="includeHints"> ヒント（解説・出題意図）も生成に含める</label>
            </div>
          </div>
        </details>

        <div class="flex" style="margin-top:8px">
          <button class="btn brand" id="btnGenerate">問題を自動生成</button>
        </div>

        <div id="genResult" style="margin-top:12px;display:none">
          <h3>生成結果</h3>
          <div class="qcard">
            <div class="small muted" id="genMeta"></div>
            <div id="genQuestion" style="margin:8px 0;font-size:15px;line-height:1.6"></div>
            <div class="flex" id="genTags" style="gap:6px;flex-wrap:wrap"></div>
            <div class="divider"></div>
            <div class="flex" style="gap:8px;align-items:center">
              <button class="btn brand cta" id="btnUseForGrading">この問題で解答する</button>
              <span class="small muted">押すと解答欄まで移動します</span>
              <label class="pill"><input type="checkbox" id="toggleHints"> ヒントを表示</label>
              <span id="dupNote" class="small"></span>
            </div>
            <div id="hintBox" class="hint" style="display:none;margin-top:10px">
              <div class="small muted" style="margin-bottom:6px">模範解答は採点後の結果エリアに表示されます。</div>
              <div style="margin:6px 0">
                <button class="btn small" id="btnToggleGenExpl" type="button">解説を表示</button>
                <div id="genExplanationWrap" style="display:none;margin-top:4px">
                  <span class="caps">解説</span>
                  <div id="genExplanation"></div>
                </div>
              </div>
              <div class="divider"></div>
              <div style="margin-top:6px">
                <button class="btn small" id="btnToggleGenIntn" type="button">出題意図を表示</button>
                <div id="genIntentionWrap" style="display:none;margin-top:4px">
                  <span class="caps">出題意図</span>
                  <div id="genIntention"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3>ストック（最新10件）</h3>

          <!-- ✅ 追加（レイアウトは維持）：検索・ランダム -->
          <div class="flex" style="gap:8px;margin:8px 0 6px">
            <input type="text" id="stockSearch" placeholder="ストック検索（キーワード）" style="flex:1;min-width:220px" maxlength="120">
            <button class="btn" id="btnStockSearch">検索</button>
            <button class="btn" id="btnStockClearSearch">クリア</button>
            <button class="btn" id="btnStockRandom" title="条件に合うストックから1問ランダムに選びます">ランダム</button>
            <label class="pill small"><input type="checkbox" id="stockFilterOnly" checked> 現在の条件のみ表示</label>
          </div>
          <div class="small muted" id="stockSearchInfo"></div>

          <div class="list" id="stockList"></div>
          <div class="small muted" id="stockCount"></div>
        </div>
      </section>

      <!-- 右：採点 -->
      <section class="card" id="gradingSection">
        <div class="toolbar">
          <h2>② 採点</h2>
          <button class="btn" id="btnExportGrading">🧾 grading.jsonl</button>
        </div>

        <!-- ✅ 追加：採点の観点（折りたたみ可能） -->
        <div class="qcard" id="rubricCard" style="margin-top:10px;">
          <details class="rubric-details">
            <summary>採点の観点（クリックで開く）</summary>
            <ul id="rubricList" style="margin:6px 0 0;padding-left:18px;line-height:1.7"></ul>
            <div id="rubricHint" class="small muted" style="margin-top:6px"></div>
          </details>
        </div>

        <div class="qcard" style="margin-top:10px">
          <div class="small muted">対象問題</div>
          <div id="currentQuestionText" style="margin:6px 0 8px;line-height:1.6"></div>
          <div class="flex" style="gap:8px;align-items:center">
            <label class="pill"><input type="checkbox" id="includeModelForGrading"> 採点に模範解答も渡す（安定化）</label>
            <label class="pill"><input type="checkbox" id="showCurrentHints"> ヒントを表示</label>
          </div>
          <div id="currentHintBox" class="hint" style="display:none;margin-top:8px">
            <div style="margin:6px 0">
              <button class="btn small" id="btnToggleCurExpl" type="button">解説を表示</button>
              <div id="currentExplWrap" style="display:none;margin-top:4px">
                <span class="caps">解説</span>
                <div id="currentExpl"></div>
              </div>
            </div>
            <div class="divider"></div>
            <div style="margin-top:6px">
              <button class="btn small" id="btnToggleCurIntn" type="button">出題意図を表示</button>
              <div id="currentIntnWrap" style="display:none;margin-top:4px">
                <span class="caps">出題意図</span>
                <div id="currentIntn"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex-col" style="margin-top:10px">
          <label>あなたの解答</label>
          <textarea id="studentAnswer" placeholder="ここに解答を記入（30〜80字目安 / 具体例は1つでOK）" maxlength="2000"></textarea>
        </div>
        <div class="flex" style="margin-top:10px">
          <select id="gradeDifficulty">
            <option>5点</option>
            <option selected>10点</option>
            <option>満点</option>
          </select>
          <button class="btn brand" id="btnGrade">採点する</button>
          <button class="btn" id="btnClearAnswer">クリア</button>
        </div>
        <div class="small muted" style="margin-top:6px">
          解答欄を書き換えて「採点する」を押せば、同じ問題で何度でも再採点できます。
        </div>

        <div id="gradeResult" style="margin-top:12px;display:none">
          <div class="qcard mini" id="continueScoreCard">
            <div class="small muted">このアプリ、続けたいですか？（0〜10）</div>
            <div class="continue-score" id="continueScoreButtons" role="group" aria-label="続けたい度の選択">
              <button class="chip" data-score="0">0</button>
              <button class="chip" data-score="1">1</button>
              <button class="chip" data-score="2">2</button>
              <button class="chip" data-score="3">3</button>
              <button class="chip" data-score="4">4</button>
              <button class="chip" data-score="5">5</button>
              <button class="chip" data-score="6">6</button>
              <button class="chip" data-score="7">7</button>
              <button class="chip" data-score="8">8</button>
              <button class="chip" data-score="9">9</button>
              <button class="chip" data-score="10">10</button>
            </div>
            <div class="small muted" id="continueScoreStatus"></div>
          </div>

          <div class="qcard result-header" id="resultHeader">
            <div class="flex" style="justify-content:space-between;gap:10px">
              <div>
                <div class="caps">今回の得点</div>
                <div id="scoreLine" class="success" style="font-weight:700;font-size:20px"></div>
                <div id="shortComment" class="small muted" style="margin-top:4px"></div>
              </div>
              <div class="pill" id="rewriteTipWrap" style="display:none">
                <span class="small muted">書き直しのコツ：</span>
                <span id="rewriteTip"></span>
              </div>
            </div>

            <div class="grid-2" style="margin-top:10px">
              <div>
                <div class="small muted">✅ 今回の良かった点</div>
                <ul id="goodPoints" style="margin:6px 0 0;padding-left:18px"></ul>
              </div>
              <div>
                <div class="small muted">🎯 次回はここだけ直そう</div>
                <div id="nextStep" style="margin-top:6px"></div>
              </div>
            </div>

            <div class="divider" style="margin:12px 0"></div>
            <div class="small muted">ルーブリック（毎回同じ尺度）</div>
            <div class="rubric-grid" id="rubricScores"></div>

            <div class="divider" style="margin:12px 0"></div>
            <div class="small muted">あなたの一番良い一文</div>
            <div id="bestSentence" class="mono" style="margin-top:6px"></div>

            <div id="improvementsWrap" style="display:none;margin-top:12px">
              <div class="small muted">前回より改善した点</div>
              <ul id="improvements" style="margin:6px 0 0;padding-left:18px"></ul>
              <div class="small muted" style="margin-top:6px">ルーブリックの前回比</div>
              <div id="rubricDiff" class="rubric-diff"></div>
            </div>

            <div class="flex" style="gap:8px;margin-top:12px">
              <button class="btn brand" id="btnRewrite">書き直して再採点する</button>
            </div>
          </div>

          <h3>採点結果</h3>
          <div class="qcard">

            <!-- ✅ 満点確率表示 -->
            <div id="perfectProbLine" class="small muted" style="margin-top:4px"></div>

            <div class="small muted" style="margin-top:10px">講評</div>
            <div id="commentary" style="margin:6px 0 8px"></div>

            <div class="divider" style="margin:12px 0"></div>
            <div class="small muted">模範解答（採点後に表示）</div>
            <div id="gradedModel" class="mono"></div>
            <div class="small muted" style="margin-top:8px">満点条件（必須要素）</div>
            <ul id="fullScoreCriteria" style="margin-top:4px"></ul>

            <div class="divider" style="margin:12px 0"></div>
            <div class="small muted">解説</div>
            <div id="gradedExplanation" style="margin-top:4px"></div>

            <div class="divider" style="margin:12px 0"></div>
            <div class="small muted">出題意図</div>
            <div id="gradedIntention" style="margin-top:4px"></div>

            <div class="divider" style="margin:12px 0"></div>
            <div class="small muted">理由</div>
            <ul id="reasons" style="margin-top:4px"></ul>

            <!-- ✅ 追加：次の一手（行動） -->
            <div class="divider" style="margin:12px 0"></div>

            <div id="weakTagsWrap" style="display:none">
              <div class="small muted">弱点タグ</div>
              <div id="weakTags" class="flex" style="gap:6px;flex-wrap:wrap;margin-top:4px"></div>
            </div>

            <div id="nextStepsWrap" style="display:none;margin-top:10px">
              <div class="small muted">次の一手（1〜3個・短く）</div>
              <ul id="nextSteps" style="margin-top:4px"></ul>
            </div>

            <div id="practiceMenuWrap" style="display:none;margin-top:10px">
              <div class="small muted">練習メニュー（すぐできる）</div>
              <ul id="practiceMenu" style="margin-top:4px"></ul>
            </div>
          </div>

          <!-- ✅ 追加：再挑戦（同じ問題で即リトライ） -->
          <div class="flex" style="gap:8px;margin-top:10px">
            <button class="btn brand" id="btnRetrySame">解答を消して同じ問題を最初から解く</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- =========================
       ✅ 使い方説明モーダル（小ウィンドウ）
       ========================= -->
  <div class="modal" id="howtoModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
      <div class="panelHeader">
        <div>
          <h2 class="panelTitle" id="howtoTitle">使い方説明（はじめての方向け）</h2>
          <div class="small muted">迷ったらこの画面を開いて、上から順番に進めてください。</div>
        </div>
        <div class="flex" style="gap:8px">
          <button class="btn" id="btnHowtoClose" aria-label="使い方説明を閉じる">閉じる</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="callout">
          <div style="font-weight:700;margin-bottom:6px">このUIでできること</div>
          <ul style="margin:0;padding-left:18px;line-height:1.8">
            <li><b>出題（記述問題）の自動生成</b>：社会/理科の記述問題を、入試・定期テスト想定で作れます。</li>
            <li><b>採点（5点/10点/満点）</b>：生徒の解答を入力すると、点数と講評・理由・模範解答（採点後のみ）を返します。</li>
            <li><b>ストック保存</b>：生成した問題を最大10件まで保存し、あとで呼び出して使えます。</li>
            <li><b>エクスポート</b>：stocks / grading のデータを書き出し、バックアップや共有に使えます。</li>
          </ul>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div>
          <div class="caps">まず最初に（初回だけ）</div>
          <ol style="margin-top:8px;line-height:1.8">
            <li>右上の<strong>設定</strong>を開き、必要なら「API Base URL」と「ACCESS_CODE」を入力します。</li>
            <li>保存後、右上の<strong>再読込</strong>で反映します（同一オリジンなら空欄のままでOK）。</li>
            <li>使い方が分からなくなったら、この<strong>使い方説明</strong>を開けばOKです。</li>
          </ol>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div>
          <div class="caps">① 出題の生成（左側）</div>
          <ol style="margin-top:8px;line-height:1.8">
            <li><strong>社会/理科</strong>タブを選びます（理科は学年を指定可能）。</li>
            <li>分類・単元・難易度・解答分量の目安を入力します。</li>
            <li>必要なら「出題の方向性」「避ける話題」を入力します。</li>
            <li><strong>問題を自動生成</strong>を押すと、生成結果が表示されます。</li>
          </ol>
          <div class="small muted" style="margin-top:6px">
            ヒントを見たい場合は「ヒントを表示」をONにすると、解説・出題意図を確認できます（模範解答は採点後に表示）。
          </div>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div>
          <div class="caps">② ストックの使い方（左側下部）</div>
          <ol style="margin-top:8px;line-height:1.8">
            <li>生成した問題は自動的にストックに追加されます（最新10件）。</li>
            <li>検索ボックスでキーワード検索、<strong>ランダム</strong>で条件に合う問題を1問選べます。</li>
            <li>使いたい問題をクリックすると、採点側にセットされます。</li>
          </ol>
          <div class="small muted" style="margin-top:6px">
            ストックは「📦 stocks.json」「📊 stocks.csv」で書き出しできます。
          </div>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div>
          <div class="caps">③ 採点の流れ（右側）</div>
          <ol style="margin-top:8px;line-height:1.8">
            <li>左側で作成した問題を「この問題で解答する」で右側に送ります。</li>
            <li>生徒の解答を入力し、<strong>採点する</strong>を押します。</li>
            <li>点数、講評、理由、模範解答（採点後のみ）が表示されます。</li>
            <li>採点の観点は折りたたみで確認できるので、<strong>何を見ているか</strong>が把握できます。</li>
            <li>やり直したいときは「解答をリセットして同じ問題を解き直す」で即リトライできます。</li>
          </ol>
          <div class="small muted" style="margin-top:6px">
            採点結果は「🧾 grading.jsonl」で書き出しできます。
          </div>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div>
          <div class="caps">よくある使い方（例）</div>
          <ul style="margin-top:8px;padding-left:18px;line-height:1.8">
            <li>小テスト用に<strong>難易度=5点</strong>で10問生成 → ストックから当日使う。</li>
            <li>定期テスト対策で<strong>満点</strong>にして記述量を増やす。</li>
            <li>「単元」や「避ける話題」に既習内容を入れて、被りを防ぐ。</li>
          </ul>
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div>
          <div class="caps">困ったときは</div>
          <ul style="margin-top:8px;padding-left:18px;line-height:1.8">
            <li>表示が変わらないときは<strong>再読込</strong>を押してください。</li>
            <li>APIに接続できない場合は、<strong>設定</strong>のURLとACCESS_CODEを確認します。</li>
            <li>フィードバックフォームが画面内に表示されない場合は「別タブで開く」を使ってください。</li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <!-- =========================
       ✅ フィードバック モーダル
       ========================= -->
  <div class="modal" id="feedbackModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle">
      <div class="panelHeader">
        <div>
          <h2 class="panelTitle" id="feedbackTitle">フィードバック（30秒）</h2>
          <div class="small muted">※個人名・学校名などの個人情報は入力しないでください。</div>
        </div>
        <div class="flex" style="gap:8px">
          <button class="btn" id="btnFeedbackClose" aria-label="フィードバックを閉じる">閉じる</button>
        </div>
      </div>

      <div class="panelBody">
        <form id="feedbackForm" class="feedback-form">
          <div class="grid-2">
            <div>
              <label for="feedbackRole">立場</label>
              <select id="feedbackRole">
                <option value="teacher">講師</option>
                <option value="student">生徒</option>
                <option value="parent">保護者</option>
                <option value="other">その他</option>
              </select>
            </div>
            <div>
              <label for="feedbackEmail">メール（任意）</label>
              <input type="text" id="feedbackEmail" placeholder="example@example.com">
            </div>
          </div>
          <div style="margin-top:12px">
            <label for="feedbackMessage">本文（必須・200〜800文字）</label>
            <textarea id="feedbackMessage" minlength="200" maxlength="800" placeholder="どの場面で良かった/困ったか、具体的に教えてください。"></textarea>
            <div class="small muted" id="feedbackCount">0 / 800</div>
          </div>
          <div class="flex" style="margin-top:12px">
            <button class="btn brand" id="btnSubmitFeedback" type="submit">送信する</button>
            <span class="small muted" id="feedbackStatus"></span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <button class="feedback-fab" id="btnFeedback" type="button">フィードバック</button>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ---- 設定の永続化 ----
    const $ = (q)=>document.querySelector(q);
    const cfg = {
      get baseUrl(){ return localStorage.getItem('baseUrl') || ''; },
      set baseUrl(v){ localStorage.setItem('baseUrl', v||''); },
      get accessCode(){ return localStorage.getItem('accessCode') || ''; },
      set accessCode(v){ localStorage.setItem('accessCode', v||''); },
      get exportCode(){ return localStorage.getItem('exportCode') || ''; },
      set exportCode(v){ localStorage.setItem('exportCode', v||''); },

      endpoint(p){ const b=this.baseUrl.trim(); return (b?b.replace(/\/$/,''):'') + p; }
    };

    // ---- 追加：観点（固定表示のデフォルト） ----
    const DEFAULT_RUBRIC = [
      {key:'要点', desc:'問われている答えが入っている'},
      {key:'因果', desc:'理由→結論がつながっている'},
      {key:'用語', desc:'重要語句が入っている'},
      {key:'表現', desc:'主語・比較・具体性が明確'}
    ];
    const DEFAULT_RUBRIC_HINT = '迷ったら「原因→結果」「重要語句」「比較の軸」を意識すると点が伸びやすいです。';

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function renderRubric(rubric, hint){
      const list = $('#rubricList');
      const hintEl = $('#rubricHint');
      if(!list || !hintEl) return;

      const r = (Array.isArray(rubric) && rubric.length) ? rubric : DEFAULT_RUBRIC;
      list.innerHTML = '';
      r.forEach(x=>{
        const k = x?.key ?? '';
        const d = x?.desc ?? '';
        const li = document.createElement('li');
        li.innerHTML = `<b>${escapeHtml(k)}</b>：${escapeHtml(d)}`;
        list.appendChild(li);
      });
      hintEl.textContent = (hint || DEFAULT_RUBRIC_HINT);
    }

    function difficultyToMaxPoints(difficulty){
      if(difficulty === '5点') return 5;
      if(difficulty === '満点') return 100;
      return 10;
    }

    function maxPointsToDifficulty(maxPoints){
      if(Number(maxPoints) === 5) return '5点';
      if(Number(maxPoints) === 100) return '満点';
      return '10点';
    }

    function resetContinueScoreUI(){
      const status = $('#continueScoreStatus');
      const buttons = document.querySelectorAll('#continueScoreButtons .chip');
      buttons.forEach(btn=>{
        btn.disabled = false;
        btn.classList.remove('selected');
      });
      if(status) status.textContent = '';
    }

    function clearGradeResultUI(){
      const gr = $('#gradeResult');
      if(gr) gr.style.display = 'none';

      const scoreLine = $('#scoreLine'); if(scoreLine) scoreLine.textContent = '';
      const shortComment = $('#shortComment'); if(shortComment) shortComment.textContent = '';
      const goodPoints = $('#goodPoints'); if(goodPoints) goodPoints.innerHTML = '';
      const nextStep = $('#nextStep'); if(nextStep) nextStep.textContent = '';
      const rubricScores = $('#rubricScores'); if(rubricScores) rubricScores.innerHTML = '';
      const bestSentence = $('#bestSentence'); if(bestSentence) bestSentence.textContent = '';
      const rewriteTipWrap = $('#rewriteTipWrap'); if(rewriteTipWrap) rewriteTipWrap.style.display = 'none';
      const rewriteTip = $('#rewriteTip'); if(rewriteTip) rewriteTip.textContent = '';
      const improvementsWrap = $('#improvementsWrap'); if(improvementsWrap) improvementsWrap.style.display = 'none';
      const improvements = $('#improvements'); if(improvements) improvements.innerHTML = '';
      const rubricDiff = $('#rubricDiff'); if(rubricDiff) rubricDiff.innerHTML = '';
      const perfectProbLine = $('#perfectProbLine'); if(perfectProbLine) perfectProbLine.textContent = '';
      const commentary = $('#commentary'); if(commentary) commentary.textContent = '';
      const gradedModel = $('#gradedModel'); if(gradedModel) gradedModel.textContent = '';
      const fullScoreCriteria = $('#fullScoreCriteria'); if(fullScoreCriteria) fullScoreCriteria.innerHTML = '';
      const gradedExplanation = $('#gradedExplanation'); if(gradedExplanation) gradedExplanation.textContent = '';
      const gradedIntention = $('#gradedIntention'); if(gradedIntention) gradedIntention.textContent = '';
      const reasons = $('#reasons'); if(reasons) reasons.innerHTML = '';

      const weakWrap = $('#weakTagsWrap'); if(weakWrap) weakWrap.style.display = 'none';
      const weakTags = $('#weakTags'); if(weakTags) weakTags.innerHTML = '';

      const nsWrap = $('#nextStepsWrap'); if(nsWrap) nsWrap.style.display = 'none';
      const ns = $('#nextSteps'); if(ns) ns.innerHTML = '';

      const pmWrap = $('#practiceMenuWrap'); if(pmWrap) pmWrap.style.display = 'none';
      const pm = $('#practiceMenu'); if(pm) pm.innerHTML = '';

      resetContinueScoreUI();
    }

    // ---- 共通Fetch ----
    async function apiGet(path){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok){
        if(res.status === 403) throw new Error('403 Forbidden: ACCESS_CODE が必要/不一致の可能性');
        let msg = `${res.status} ${res.statusText}`;
        try {
          const j = await res.json();
          if(j && j.error){ msg += `: ${j.error}`; }
          if(j && j.message && !msg.includes(j.message)){ msg += ` / ${j.message}`; }
        } catch(e){}
        throw new Error(msg);
      }
      try{
        return await res.json();
      }catch(e){
        return {};
      }
    }

    async function apiPost(path, body){
      const headers = {'Content-Type':'application/json'};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {method:'POST', headers, body: JSON.stringify(body||{})});
      let data = null;
      try{
        data = await res.json();
      }catch(e){
        data = null;
      }
      if(!res.ok){
        if(res.status === 429 && data && data.error === 'quota_exceeded'){
          const err = new Error(data.message || '無料プランの1日あたりの利用回数を超えています。');
          err.code = 'quota_exceeded';
          err.status = 429;
          throw err;
        }
        if(res.status === 403){
          const err = new Error('403 Forbidden: ACCESS_CODE が必要/不一致の可能性');
          err.code = 'forbidden';
          err.status = 403;
          throw err;
        }
        let msg = `${res.status} ${res.statusText}`;
        if(data){
          if(data.error) msg += `: ${data.error}`;
          if(data.message && !msg.includes(data.message)) msg += ` / ${data.message}`;
        }
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }
      return data || {};
    }

    function toast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.style.background = ok ? '#111827' : '#ef4444';
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }

    async function postFeedback(payload){
      const res = await fetch(cfg.endpoint('/feedback'), {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload || {})
      });
      let data = null;
      try{
        data = await res.json();
      }catch(e){
        data = null;
      }
      if(!res.ok){
        const msg = data?.error ? `: ${data.error}` : '';
        throw new Error(`${res.status} ${res.statusText}${msg}`);
      }
      return data || {};
    }

    function buildQueryString(params){
      const sp = new URLSearchParams();
      Object.entries(params || {}).forEach(([k,v])=>{
        if(v === undefined || v === null) return;
        const s = String(v).trim();
        if(!s) return;
        sp.set(k, s);
      });
      const qs = sp.toString();
      return qs ? `?${qs}` : '';
    }

    // ---- UI状態 ----
    let subject = '社会';
    let currentItem = null;
    let generatedRaw = null;
    let lastGradeResult = null;
    let lastGradedAnswer = '';

    // ---- 設定UI ----
    function loadSettings(){
      $('#baseUrl').value = cfg.baseUrl;
      $('#accessCode').value = cfg.accessCode;
      $('#exportCode').value = cfg.exportCode;
    }
    function saveSettings(){
      cfg.baseUrl = $('#baseUrl').value.trim();
      cfg.accessCode = $('#accessCode').value.trim();
      cfg.exportCode = $('#exportCode').value.trim();
      $('#statusLine').textContent = '保存しました';
      setTimeout(()=>$('#statusLine').textContent='', 1500);
    }

    // ---- 学年とカテゴリの整合（理科：天体は中3のみ）----
    function applyScienceConstraints(){
      if(subject!=='理科') return;
      const g = $('#grade').value;
      const cat = $('#category');
      [...cat.options].forEach(opt=>{
        if(opt.textContent==='天体'){
          opt.disabled = (g !== '中3');
          if(opt.disabled && cat.value==='天体'){
            cat.value = '地学';
          }
        }
      });
    }

    // ---- 利用状況バッジ ----
    async function refreshUsage(){
      const badge = $('#usageBadge');
      if(!badge) return;
      try{
        const r = await apiGet('/api/usage');
        if(!r || !r.ok){
          badge.textContent = '';
          return;
        }
        const limit = r.limit;
        const usage = r.usage || {};
        const total = usage.total ?? 0;
        if(limit == null){
          badge.textContent = `本日の利用: ${total} 回（制限なし）`;
        }else{
          badge.textContent = `本日の利用: ${total} / ${limit} 回`;
        }
      }catch(e){}
    }

    // ---- 使い方モーダル ----
    function openHowto(){
      const m = $('#howtoModal');
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
      setTimeout(()=>{ $('#btnHowtoClose').focus(); }, 0);
    }
    function closeHowto(){
      const m = $('#howtoModal');
      m.classList.remove('show');
      m.setAttribute('aria-hidden','true');
      setTimeout(()=>{ $('#btnHowto').focus(); }, 0);
    }

    // ---- 初期化 ----
    async function boot(){
      loadSettings();
      updateFeedbackCount();

      renderRubric(DEFAULT_RUBRIC, DEFAULT_RUBRIC_HINT);

      try{
        const m = await apiGet('/api/model');
        if(m && m.model) $('#modelTag').textContent = `model: ${m.model}`;
      }catch(e){}

      try{
        const st = await apiGet('/status');
        if(st && st.rubric){
          renderRubric(st.rubric, st.rubric_hint);
        }
      }catch(e){}

      await refreshStock();
      updateSubjectTabs();
      applyScienceConstraints();
      $('#settingsCard').style.display = 'none';
      refreshUsage();
    }

    // ---- 生成UIロジック ----
    function updateSubjectTabs(){
      document.querySelectorAll('.tab').forEach(el=>{
        el.classList.toggle('active', el.dataset.subject === subject);
      });
      const cat = $('#category');
      cat.innerHTML = '';
      if(subject==='社会'){
        ['地理','歴史'].forEach(x=>{
          const o=document.createElement('option'); o.textContent=x; cat.appendChild(o);
        });
        $('#gradeBox').style.display='none';
      }else{
        ['生物','化学','地学','物理','天体'].forEach(x=>{
          const o=document.createElement('option'); o.textContent=x; cat.appendChild(o);
        });
        $('#gradeBox').style.display='';
        applyScienceConstraints();
      }
      refreshStock();
    }

    async function handleGenerate(){
      const payload = {
        subject,
        category: $('#category').value,
        grade: subject==='理科' ? $('#grade').value : '',
        unit: $('#unit').value || '',
        difficulty: $('#difficulty').value,
        max_points: difficultyToMaxPoints($('#difficulty').value),
        genre_hint: $('#genreHint').value,
        avoid_topics: $('#avoidTopics').value,
        include_hints: $('#includeHints').checked,
        length_hint: $('#lengthHint').value || '30〜80字程度',
      };
      const btn = $('#btnGenerate');
      btn.disabled = true; const txt = btn.textContent; btn.textContent = '生成中…';
      try{
        const res = await apiPost('/api/generate_question', payload);
        generatedRaw = res;
        let item = res.item || res.generated || {};
        if(res.item && res.item.question){
          currentItem = res.item;
        }else{
          currentItem = item;
        }
        renderGenerated(item, res.duplicate_of);
        await refreshStock();
        await refreshUsage();
        toast('問題を生成しました');
      }catch(e){
        console.error(e);
        if(e.code === 'quota_exceeded'){
          toast(e.message || '無料プランの1日あたりの利用回数を超えました', false);
        }else{
          toast('生成に失敗しました: ' + e.message, false);
        }
        refreshUsage();
      }finally{
        btn.disabled = false; btn.textContent = txt;
      }
    }

    function renderGenerated(item, dupOf){
      $('#genResult').style.display = '';
      $('#genQuestion').textContent = item.question || '(empty)';
      $('#genExplanation').textContent = item.explanation || '';
      $('#genIntention').textContent = item.intention || '';
      const tags = item.tags || [];
      const meta = [];
      if(item.subject) meta.push(item.subject);
      if(item.domain || item.category) meta.push(item.domain || item.category);
      if(item.grade) meta.push(item.grade);
      if(item.unit) meta.push(`単元:${item.unit}`);
      const maxPoints = item.max_points || difficultyToMaxPoints(item.difficulty || '');
      if(maxPoints) meta.push(`配点:${maxPoints}点`);
      $('#genMeta').textContent = meta.join(' / ');
      const tagsBox = $('#genTags'); tagsBox.innerHTML='';
      tags.forEach(t=>{
        const s=document.createElement('span'); s.className='tag'; s.textContent=t; tagsBox.appendChild(s);
      });
      $('#dupNote').textContent = dupOf ? `（注）ストック内の類似: ${dupOf}` : '';

      $('#hintBox').style.display = $('#toggleHints').checked ? '' : 'none';
      $('#genExplanationWrap').style.display = 'none';
      $('#genIntentionWrap').style.display = 'none';
    }

    // ---- ストック一覧（list / search 対応） ----
    function currentFilters(){
      return {
        subject,
        domain: $('#category')?.value || '',
        category: $('#category')?.value || '',
        grade: subject === '理科' ? ($('#grade')?.value || '') : '',
        unit: $('#unit')?.value || '',
        difficulty: $('#difficulty')?.value || '10点',
        max_points: difficultyToMaxPoints($('#difficulty')?.value || '10点'),
      };
    }

    async function refreshStock(){
      const q = ($('#stockSearch')?.value || '').trim();
      const info = $('#stockSearchInfo');
      const filters = currentFilters();
      const filterOnly = $('#stockFilterOnly')?.checked ?? true;
      const queryFilters = filterOnly ? filters : {};
      try{
        let r;
        if(q){
          const qs = buildQueryString({ q, limit: 50, offset: 0, ...queryFilters });
          r = await apiGet('/api/stock/search' + qs);
          info.textContent = filterOnly
            ? `検索中："${q}"（条件一致 ${r.total ?? (r.items||[]).length} 件）`
            : `検索中："${q}"（全体 ${r.total ?? (r.items||[]).length} 件）`;
          renderStockList(r.items || [], { count: (r.items||[]).length, limit: r.limit ?? 50, total: r.total ?? (r.items||[]).length }, filters, filterOnly);
        }else{
          const qs = buildQueryString(queryFilters);
          r = await apiGet('/api/stock/list' + qs);
          info.textContent = filterOnly ? '' : '全件表示中（上部に条件一致を優先表示）';
          renderStockList(r.items || [], { count: r.count, limit: r.limit, total: r.count }, filters, filterOnly);
        }
      }catch(e){
        console.error(e);
        const list = $('#stockList'); list.innerHTML='';
        const errDiv = document.createElement('div');
        errDiv.className = 'small danger';
        errDiv.textContent = '取得に失敗: ' + e.message;
        list.appendChild(errDiv);
        $('#stockCount').textContent = '';
        if(info) info.textContent = '';
      }
    }

    function matchesFilters(it, filters){
      if(filters.subject && it.subject !== filters.subject) return false;
      if(filters.domain && (it.domain || it.category) !== filters.domain) return false;
      if(filters.grade && it.grade !== filters.grade) return false;
      if(filters.unit && it.unit !== filters.unit) return false;
      if(filters.max_points && Number(it.max_points || 0) !== Number(filters.max_points)) return false;
      return true;
    }

    function renderStockList(items, meta, filters = {}, filterOnly = true){
      const list = $('#stockList'); list.innerHTML='';
      const sorted = filterOnly ? items : [...items].sort((a,b)=>{
        const am = matchesFilters(a, filters) ? 0 : 1;
        const bm = matchesFilters(b, filters) ? 0 : 1;
        return am - bm;
      });
      sorted.forEach(it=>{
        const div=document.createElement('div'); div.className='item';

        const topWrap=document.createElement('div');
        topWrap.className='small muted';
        const metaPieces = [
          it.subject || '',
          it.domain || it.category || '',
          it.grade || '',
          it.unit ? `単元:${it.unit}` : '',
          `配点:${it.max_points || difficultyToMaxPoints(it.difficulty || '')}点`,
        ].filter(Boolean);
        topWrap.textContent = metaPieces.join(' / ');

        const q=document.createElement('div'); q.style.margin='6px 0'; q.textContent = it.question || '';

        const actions=document.createElement('div'); actions.className='flex';
        const useBtn=document.createElement('button'); useBtn.className='btn'; useBtn.textContent='この問題を使う';
        useBtn.onclick=()=>{ useStock(it); };
        actions.appendChild(useBtn);

        if(cfg.accessCode){
          const del=document.createElement('button'); del.className='btn err'; del.textContent='削除';
          del.onclick=()=>deleteStock(it.id);
          actions.appendChild(del);
        }

        div.appendChild(topWrap); div.appendChild(q); div.appendChild(actions);
        list.appendChild(div);
      });

      const count = meta?.count ?? items.length;
      const limit = meta?.limit ?? '';
      const total = meta?.total ?? count;
      if(limit !== ''){
        $('#stockCount').textContent = `表示: ${count} 件 / 全体 ${total} 件（上限 ${limit}）`;
      }else{
        $('#stockCount').textContent = `表示: ${count} 件 / 全体 ${total} 件`;
      }
    }

    async function deleteStock(id){
      if(!confirm('この問題を削除しますか？')) return;
      try{
        await apiPost('/api/stock/delete', {id});
        toast('削除しました');
        await refreshStock();
      }catch(e){
        toast('削除に失敗: ' + e.message, false);
      }
    }

    async function stockRandom(){
      const q = ($('#stockSearch')?.value || '').trim();
      const filterOnly = $('#stockFilterOnly')?.checked ?? true;
      const qs = buildQueryString({ q, ...(filterOnly ? currentFilters() : {}) });
      try{
        const r = await apiGet('/api/stock/random' + qs);
        if(r && r.ok && r.item){
          useStock(r.item);
          toast('ランダムで1問選びました');
        }else{
          toast('候補が見つかりませんでした', false);
        }
      }catch(e){
        toast('ランダム取得に失敗: ' + e.message, false);
      }
    }

    function useStock(it){
      currentItem = it;
      if(it.subject && it.subject !== subject){
        subject = it.subject;
        updateSubjectTabs();
      }
      if(it.domain || it.category){
        $('#category').value = it.domain || it.category;
      }
      if(subject === '理科' && it.grade){
        $('#grade').value = it.grade;
      }
      $('#currentQuestionText').textContent = it.question || '';
      $('#currentExpl').textContent = it.explanation || '';
      $('#currentIntn').textContent = it.intention || '';
      const difficultyValue = it.difficulty || maxPointsToDifficulty(it.max_points);
      if(difficultyValue){
        $('#gradeDifficulty').value = difficultyValue;
        $('#difficulty').value = difficultyValue;
      }
      if(it.unit){
        $('#unit').value = it.unit;
      }

      $('#currentHintBox').style.display = $('#showCurrentHints').checked ? '' : 'none';
      $('#currentExplWrap').style.display = 'none';
      $('#currentIntnWrap').style.display = 'none';

      $('#studentAnswer').value = '';
      clearGradeResultUI();

      applyScienceConstraints();
      refreshStock();

      document.querySelector('#studentAnswer')?.scrollIntoView({behavior:'smooth', block:'start'});
      $('#studentAnswer')?.focus();
      toast('採点対象にセットしました');
    }

    function renderResultHeader(r){
      const score = r?.score_total ?? r?.score ?? 0;
      const label = r?.score_label || `${r?.max_score ?? 10}点`;
      $('#scoreLine').textContent = `${label}中${score}点`;
      $('#shortComment').textContent = r?.short_comment || '';

      const gp = $('#goodPoints'); gp.innerHTML = '';
      (r?.good_points || []).forEach(t=>{
        const li = document.createElement('li');
        li.textContent = t;
        gp.appendChild(li);
      });

      $('#nextStep').textContent = r?.next_step || '';

      const rubricScores = $('#rubricScores');
      rubricScores.innerHTML = '';
      const rubric = r?.rubric || {};
      const labels = [
        {key:'conclusion', label:'結論の明確さ'},
        {key:'logic', label:'理由の筋道'},
        {key:'wording', label:'用語・表現の適切さ'}
      ];
      labels.forEach(({key,label})=>{
        const val = rubric[key] ?? 0;
        const div = document.createElement('div');
        div.className = 'rubric-item';
        div.innerHTML = `<span class="small muted">${label}</span><span class="rubric-score">${val}/3</span>`;
        rubricScores.appendChild(div);
      });

      $('#bestSentence').textContent = r?.best_sentence || '';

      const tipWrap = $('#rewriteTipWrap');
      const tip = (r?.rewrite_tip || '').trim();
      if(tip){
        tipWrap.style.display = '';
        $('#rewriteTip').textContent = tip;
      }else{
        tipWrap.style.display = 'none';
        $('#rewriteTip').textContent = '';
      }

      const improvements = Array.isArray(r?.improvements) ? r.improvements : [];
      const improvementsWrap = $('#improvementsWrap');
      const improvementsList = $('#improvements');
      const rubricDiff = $('#rubricDiff');
      improvementsList.innerHTML = '';
      rubricDiff.innerHTML = '';
      if(improvements.length){
        improvementsWrap.style.display = '';
        improvements.forEach(s=>{
          const li = document.createElement('li');
          li.textContent = s;
          improvementsList.appendChild(li);
        });
        const diff = r?.rubric_diff || {};
        labels.forEach(({key,label})=>{
          const d = diff[key] ?? 0;
          const span = document.createElement('span');
          span.className = `diff ${d > 0 ? 'up' : d < 0 ? 'down' : 'same'}`;
          const sign = d > 0 ? `+${d}` : `${d}`;
          span.textContent = `${label} ${sign}`;
          rubricDiff.appendChild(span);
        });
      }else{
        improvementsWrap.style.display = 'none';
      }
    }

    async function sendContinueScore(score, btn){
      const status = $('#continueScoreStatus');
      const role = localStorage.getItem('feedbackRole') || 'unknown';
      const context = {};
      if(currentItem){
        if(currentItem.subject) context.subject = currentItem.subject;
        if(currentItem.category) context.category = currentItem.category;
        if(currentItem.grade) context.grade = currentItem.grade;
        if(currentItem.difficulty) context.difficulty = currentItem.difficulty;
        if(currentItem.question) context.question = currentItem.question.slice(0, 160);
      }
      if(lastGradeResult){
        const scoreTotal = lastGradeResult.score_total ?? lastGradeResult.score;
        if(scoreTotal !== undefined) context.score_total = scoreTotal;
        if(lastGradeResult.rubric) context.rubric = lastGradeResult.rubric;
      }
      if(lastGradedAnswer) context.answer_length = lastGradedAnswer.length;

      try{
        if(status) status.textContent = '送信中...';
        await postFeedback({
          type: 'continue_score',
          continue_score: score,
          role,
          context
        });
        const buttons = document.querySelectorAll('#continueScoreButtons .chip');
        buttons.forEach(b=>{
          b.disabled = true;
          b.classList.remove('selected');
        });
        if(btn) btn.classList.add('selected');
        if(status) status.textContent = '送信しました。ありがとうございます！';
      }catch(e){
        if(status) status.textContent = '送信に失敗しました。';
        toast('送信に失敗しました: ' + e.message, false);
      }
    }

    function openFeedback(){
      const modal = $('#feedbackModal');
      const status = $('#feedbackStatus');
      if(status) status.textContent = '';
      const savedRole = localStorage.getItem('feedbackRole');
      if(savedRole) $('#feedbackRole').value = savedRole;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=>{ $('#feedbackMessage')?.focus(); }, 0);
    }

    function closeFeedback(){
      const modal = $('#feedbackModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
      setTimeout(()=>{ $('#btnFeedback')?.focus(); }, 0);
    }

    function updateFeedbackCount(){
      const msg = $('#feedbackMessage').value || '';
      const count = msg.length;
      const counter = $('#feedbackCount');
      if(counter) counter.textContent = `${count} / 800`;
    }

    async function handleFeedbackSubmit(e){
      e.preventDefault();
      const role = $('#feedbackRole').value;
      const email = $('#feedbackEmail').value.trim();
      const message = $('#feedbackMessage').value.trim();
      const status = $('#feedbackStatus');
      if(message.length < 200 || message.length > 800){
        if(status) status.textContent = '本文は200〜800文字で入力してください。';
        return;
      }
      if(status) status.textContent = '送信中...';
      try{
        await postFeedback({
          type: 'feedback',
          role,
          email,
          message
        });
        localStorage.setItem('feedbackRole', role);
        toast('送信しました。ありがとうございます！');
        closeFeedback();
        $('#feedbackMessage').value = '';
        updateFeedbackCount();
      }catch(err){
        if(status) status.textContent = '送信に失敗しました。';
        toast('送信に失敗しました: ' + err.message, false);
      }
    }

    // ---- 採点 ----
    async function handleGrade(){
      if(!currentItem || !currentItem.question){
        toast('先に問題を選ぶか生成してください', false); return;
      }
      const body = {
        question: currentItem.question,
        student_answer: $('#studentAnswer').value || '',
        difficulty: $('#gradeDifficulty').value,
        max_points: difficultyToMaxPoints($('#gradeDifficulty').value),
      };
      if($('#includeModelForGrading').checked && currentItem.model_answer){
        body.model_answer = currentItem.model_answer;
      }
      if(!body.student_answer.trim()){
        toast('解答を入力してください', false); return;
      }
      const btn = $('#btnGrade');
      btn.disabled = true; const txt = btn.textContent; btn.textContent = '採点中…';
      try{
        const r = await apiPost('/api/grade_answer', body);

        if(r && r.rubric){
          renderRubric(r.rubric, r.rubric_hint);
        }

        clearGradeResultUI();
        $('#gradeResult').style.display='';
        renderResultHeader(r);
        resetContinueScoreUI();

        lastGradeResult = r;
        lastGradedAnswer = body.student_answer;
        if(currentItem && r.model_answer){
          currentItem.model_answer = r.model_answer;
        }

        $('#commentary').textContent = r.commentary || '';
        const modelText = (r.model_answer || '').trim();
        $('#gradedModel').textContent = modelText || '（未設定）';

        const criteria = Array.isArray(r.full_score_criteria) ? r.full_score_criteria : [];
        const criteriaList = $('#fullScoreCriteria');
        if(criteriaList){
          criteriaList.innerHTML = '';
          (criteria.length ? criteria : ['結論が明確', '理由が1つ以上ある', '重要語句が入っている']).forEach(c=>{
            const li = document.createElement('li');
            li.textContent = c;
            criteriaList.appendChild(li);
          });
        }

        $('#gradedExplanation').textContent = (currentItem?.explanation || '').trim() || '（未設定）';
        $('#gradedIntention').textContent = (currentItem?.intention || '').trim() || '（未設定）';

        const ul = $('#reasons'); ul.innerHTML='';
        (r.reasons||[]).forEach(s=>{
          const li=document.createElement('li'); li.textContent=s; ul.appendChild(li);
        });

        const prob = (r.perfect_probability ?? null);
        const note = (r.perfect_probability_note ?? '').toString().trim();
        const line = $('#perfectProbLine');
        if(line){
          if(prob === null || prob === undefined){
            line.textContent = '';
          }else{
            line.textContent = `満点（○）になる確率: ${prob}%${note ? `（${note}）` : ''}`;
          }
        }

        const weakTags = Array.isArray(r.weak_tags) ? r.weak_tags : [];
        const nextSteps = Array.isArray(r.next_steps) ? r.next_steps : [];
        const practiceMenu = Array.isArray(r.practice_menu) ? r.practice_menu : [];

        const weakWrap = $('#weakTagsWrap');
        const weakBox = $('#weakTags');
        if(weakWrap && weakBox){
          weakBox.innerHTML = '';
          if(weakTags.length){
            weakWrap.style.display = '';
            weakTags.slice(0,3).forEach(t=>{
              const s=document.createElement('span');
              s.className='tag';
              s.textContent = t;
              weakBox.appendChild(s);
            });
          }else{
            weakWrap.style.display = 'none';
          }
        }

        const nsWrap = $('#nextStepsWrap');
        const nsUl = $('#nextSteps');
        if(nsWrap && nsUl){
          nsUl.innerHTML = '';
          if(nextSteps.length){
            nsWrap.style.display = '';
            nextSteps.slice(0,3).forEach(s=>{
              const li=document.createElement('li');
              li.textContent = s;
              nsUl.appendChild(li);
            });
          }else{
            nsWrap.style.display = 'none';
          }
        }

        const pmWrap = $('#practiceMenuWrap');
        const pmUl = $('#practiceMenu');
        if(pmWrap && pmUl){
          pmUl.innerHTML = '';
          if(practiceMenu.length){
            pmWrap.style.display = '';
            practiceMenu.slice(0,3).forEach(s=>{
              const li=document.createElement('li');
              li.textContent = s;
              pmUl.appendChild(li);
            });
          }else{
            pmWrap.style.display = 'none';
          }
        }

        await refreshUsage();
        toast('採点しました');
      }catch(e){
        console.error(e);
        if(e.code === 'quota_exceeded'){
          toast(e.message || '無料プランの1日あたりの利用回数を超えました', false);
        }else{
          toast('採点に失敗しました: ' + e.message, false);
        }
        refreshUsage();
      }finally{
        btn.disabled = false; btn.textContent = txt;
      }
    }

    // ---- エクスポート（ヘッダー付きDL）----
    async function downloadEndpoint(path, filename){
      const headers = {};
      if(cfg.exportCode) headers['X-Export-Code'] = cfg.exportCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ---- イベント結線 ----
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.tab')){
        subject = e.target.closest('.tab').dataset.subject;
        updateSubjectTabs();
      }
    });
    document.addEventListener('keydown', (e)=>{
      const t = e.target.closest('.tab');
      if(t && (e.key === 'Enter' || e.key === ' ')){ t.click(); e.preventDefault(); }
    });

    $('#grade').onchange = ()=>{ applyScienceConstraints(); refreshStock(); };
    $('#category').onchange = ()=> refreshStock();
    $('#difficulty').onchange = ()=>{
      $('#gradeDifficulty').value = $('#difficulty').value;
      refreshStock();
    };
    $('#unit').onchange = ()=> refreshStock();
    $('#stockFilterOnly').onchange = ()=> refreshStock();
    $('#unit').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ refreshStock(); e.preventDefault(); }
    });
    $('#gradeDifficulty').onchange = ()=>{
      $('#difficulty').value = $('#gradeDifficulty').value;
      refreshStock();
    };

    $('#btnGenerate').onclick = handleGenerate;
    $('#toggleHints').onchange = ()=> {
      const on = $('#toggleHints').checked;
      $('#hintBox').style.display = on ? '' : 'none';
      if(!on){
        $('#genExplanationWrap').style.display = 'none';
        $('#genIntentionWrap').style.display = 'none';
      }
    };

    $('#btnToggleGenExpl').onclick = ()=>{
      const w = $('#genExplanationWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleGenIntn').onclick = ()=>{
      const w = $('#genIntentionWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };

    $('#btnUseForGrading').onclick = ()=>{
      if(!generatedRaw){ toast('先に生成してください', false); return; }
      const item = (generatedRaw.item || generatedRaw.generated);
      useStock(item);
    };

    $('#showCurrentHints').onchange = ()=>{
      const on = $('#showCurrentHints').checked;
      $('#currentHintBox').style.display = on ? '' : 'none';
      if(!on){
        $('#currentExplWrap').style.display = 'none';
        $('#currentIntnWrap').style.display = 'none';
      }
    };

    $('#btnToggleCurExpl').onclick = ()=>{
      const w = $('#currentExplWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };
    $('#btnToggleCurIntn').onclick = ()=>{
      const w = $('#currentIntnWrap');
      w.style.display = (w.style.display === 'none' || !w.style.display) ? '' : 'none';
    };

    $('#btnGrade').onclick = handleGrade;

    $('#btnClearAnswer').onclick = ()=>{ $('#studentAnswer').value=''; clearGradeResultUI(); };

    $('#btnRetrySame').onclick = ()=>{
      $('#studentAnswer').value = '';
      clearGradeResultUI();
      $('#studentAnswer').focus();
      toast('解答を消しました。同じ問題を最初から解き直せます');
    };

    $('#btnRewrite').onclick = ()=>{
      if(!lastGradedAnswer){
        toast('まず採点してください', false);
        return;
      }
      $('#studentAnswer').value = lastGradedAnswer;
      $('#studentAnswer').focus();
      toast('前回の解答を読み直して書き直しましょう（再採点されます）');
    };

    document.querySelectorAll('#continueScoreButtons .chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(btn.disabled) return;
        const score = Number(btn.dataset.score);
        if(Number.isNaN(score)) return;
        sendContinueScore(score, btn);
      });
    });

    $('#btnExportJson').onclick = ()=> downloadEndpoint('/api/export/stocks.json', 'stocks.json').catch(e=>toast('DL失敗: '+e.message,false));
    $('#btnExportCsv').onclick = ()=> downloadEndpoint('/api/export/stocks.csv', 'stocks.csv').catch(e=>toast('DL失敗: '+e.message,false));
    $('#btnExportGrading').onclick = ()=> downloadEndpoint('/api/export/grading.jsonl', 'grading.jsonl').catch(e=>toast('DL失敗: '+e.message,false));

    $('#btnSettings').onclick = ()=> $('#settingsCard').style.display='';
    $('#btnHideSettings').onclick = ()=> $('#settingsCard').style.display='none';
    $('#btnSaveSettings').onclick = ()=> { saveSettings(); boot(); };
    $('#btnReload').onclick = boot;

    $('#btnStockSearch').onclick = ()=> refreshStock();
    $('#btnStockClearSearch').onclick = ()=>{ $('#stockSearch').value=''; refreshStock(); };
    $('#btnStockRandom').onclick = stockRandom;
    $('#stockSearch').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ refreshStock(); e.preventDefault(); }
    });

    $('#btnHowto').onclick = openHowto;
    $('#btnHowtoClose').onclick = closeHowto;
    $('#howtoModal').addEventListener('click', (e)=>{
      if(e.target === e.currentTarget) closeHowto();
    });

    // ✅ フィードバックモーダル開閉
    $('#btnFeedback').onclick = openFeedback;
    $('#btnFeedbackClose').onclick = closeFeedback;
    $('#feedbackModal').addEventListener('click', (e)=>{
      if(e.target === e.currentTarget) closeFeedback();
    });
    $('#feedbackForm').addEventListener('submit', handleFeedbackSubmit);
    $('#feedbackMessage').addEventListener('input', updateFeedbackCount);

    document.addEventListener('keydown', (e)=>{
      const howto = $('#howtoModal');
      const fb = $('#feedbackModal');
      if(e.key === 'Escape'){
        if(howto && howto.classList.contains('show')) closeHowto();
        if(fb && fb.classList.contains('show')) closeFeedback();
      }
    });

    // 起動
    boot();
  </script>
</body>
</html>
