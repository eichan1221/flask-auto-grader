<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>è¨˜è¿°å¼APIï¼ˆå€‹äººé‹ç”¨ç‰ˆï¼‰UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#fdf6ff; --bg2:#f0fbff;
      --ink:#1f2937; --muted:#6b7280;
      --brand:#c084fc; --brand-strong:#a855f7;
      --accent:#f9a8d4; --accent-strong:#f472b6;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#ffffff; --border:#e5e7eb; --shadow:rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,0.75);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px var(--shadow);padding:16px}
    h1{font-size:20px;margin:4px 0}
    h2{font-size:18px;margin:8px 0 12px}
    h3{font-size:15px;margin:10px 0 6px}
    label{font-size:13px;color:var(--muted)}
    input[type=text], select, textarea{
      width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff
    }
    textarea{min-height:120px;resize:vertical}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .flex-col{display:flex;gap:8px;flex-direction:column}
    .btn{
      border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-weight:600;font-size:14px;cursor:pointer
    }
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
    .btn.err{background:var(--err);border-color:var(--err);color:#fff}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#374151;background:#fff}
    .toolbar{display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}}
    .pill{
      display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff
    }
    .small{font-size:12px;color:var(--muted)}
    .qcard{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hint{background:#faf5ff;border:1px solid #eadcff;border-radius:12px;padding:10px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(12px);transition:.25s}
    .toast.show{opacity:1;transform:none}
    .danger{color:var(--err)}
    .success{color:var(--ok)}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .list{display:flex;flex-direction:column;gap:10px;max-height:340px;overflow:auto}
    .item{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .caps{font-variant:all-small-caps;letter-spacing:.04em}
    .kbd{border:1px solid var(--border);padding:1px 6px;border-radius:6px;background:#fff;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="flex" style="gap:10px">
        <h1>è¨˜è¿°å¼APIï¼ˆå€‹äººé‹ç”¨UIï¼‰</h1>
        <span id="modelTag" class="tag">model: ...</span>
      </div>
      <div class="flex">
        <button class="btn ghost" id="btnSettings">è¨­å®š</button>
        <button class="btn ghost" id="btnReload">å†èª­è¾¼</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px;padding-bottom:40px">
    <!-- è¨­å®š -->
    <div class="card" id="settingsCard" style="display:none">
      <h2>æ¥ç¶šè¨­å®š</h2>
      <div class="grid-2">
        <div>
          <label for="baseUrl">API Base URLï¼ˆç©º=åŒä¸€ã‚ªãƒªã‚¸ãƒ³ï¼‰</label>
          <input type="text" id="baseUrl" placeholder="ä¾‹ https://your.onrender.com">
          <div class="small muted">CORSæ¸ˆã¿ã®URLã‚’æŒ‡å®šã€‚ç©ºæ¬„ãªã‚‰åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã€‚</div>
        </div>
        <div>
          <label for="accessCode">ACCESS_CODEï¼ˆä¿è­·APIç”¨ / ä»»æ„ï¼‰</label>
          <input type="text" id="accessCode" placeholder="ãƒ˜ãƒƒãƒ€ãƒ¼ã« X-Access-Code ã¨ã—ã¦ä»˜ä¸">
          <div class="small muted">ç”Ÿæˆãƒ»æ¡ç‚¹ãƒ»å‰Šé™¤ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¿…è¦ãªèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn brand" id="btnSaveSettings">ä¿å­˜</button>
        <button class="btn" id="btnHideSettings">é–‰ã˜ã‚‹</button>
        <span id="statusLine" class="small muted"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <!-- å·¦ï¼šç”Ÿæˆ & ã‚¹ãƒˆãƒƒã‚¯ -->
      <section class="card">
        <div class="toolbar">
          <h2>â‘  å‡ºé¡Œã®ç”Ÿæˆ & ã‚¹ãƒˆãƒƒã‚¯</h2>
          <div class="flex">
            <button class="btn" id="btnExportJson">ğŸ“¦ stocks.json</button>
            <button class="btn" id="btnExportCsv">ğŸ“Š stocks.csv</button>
          </div>
        </div>

        <div class="flex" style="gap:6px;margin-bottom:8px">
          <span class="tab active" data-subject="ç¤¾ä¼š">ç¤¾ä¼š</span>
          <span class="tab" data-subject="ç†ç§‘">ç†ç§‘</span>
        </div>

        <div class="grid-2">
          <div>
            <label>åˆ†é¡ï¼ˆç§‘ç›®ï¼‰</label>
            <select id="category">
              <option>åœ°ç†</option>
              <option>æ­´å²</option>
            </select>
          </div>
          <div id="gradeBox" style="display:none">
            <label>å­¦å¹´ï¼ˆç†ç§‘ã®ã¿ï¼‰</label>
            <select id="grade">
              <option>ä¸­1</option>
              <option>ä¸­2</option>
              <option selected>ä¸­3</option>
            </select>
          </div>
          <div>
            <label>é›£æ˜“åº¦/é…ç‚¹</label>
            <select id="difficulty">
              <option>5ç‚¹</option>
              <option selected>10ç‚¹</option>
            </select>
          </div>
          <div>
            <label>è§£ç­”åˆ†é‡ã®ç›®å®‰</label>
            <input type="text" id="lengthHint" value="30ã€œ80å­—ç¨‹åº¦">
          </div>
          <div>
            <label>å‡ºé¡Œã®æ–¹å‘æ€§ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="genreHint" placeholder="åˆ¶åº¦/æ–‡åŒ–/æ™‚ä»£èƒŒæ™¯ ãªã©">
          </div>
          <div>
            <label>é¿ã‘ã‚‹è©±é¡Œï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="avoidTopics" placeholder="ä¾‹ï¼šç¨²ä½œã¯é¿ã‘ãŸã„">
          </div>
        </div>

        <div class="flex" style="margin-top:8px">
          <label class="pill"><input type="checkbox" id="includeHints"> ãƒ’ãƒ³ãƒˆï¼ˆæ¨¡ç¯„è§£ç­”ç­‰ï¼‰ã‚‚ç”Ÿæˆã«å«ã‚ã‚‹</label>
          <button class="btn brand" id="btnGenerate">å•é¡Œã‚’è‡ªå‹•ç”Ÿæˆ</button>
        </div>

        <div id="genResult" style="margin-top:12px;display:none">
          <h3>ç”Ÿæˆçµæœ</h3>
          <div class="qcard">
            <div class="small muted" id="genMeta"></div>
            <div id="genQuestion" style="margin:8px 0;font-size:15px;line-height:1.6"></div>
            <div class="flex" id="genTags" style="gap:6px;flex-wrap:wrap"></div>
            <div class="divider"></div>
            <div class="flex" style="gap:8px;align-items:center">
              <button class="btn" id="btnUseForGrading">ã“ã®å•é¡Œã§æ¡ç‚¹ã¸</button>
              <label class="pill"><input type="checkbox" id="toggleHints"> ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º</label>
              <span id="dupNote" class="small"></span>
              <span id="noveltyNote" class="small"></span>
            </div>
            <div id="hintBox" class="hint" style="display:none;margin-top:10px">
              <div><span class="caps">æ¨¡ç¯„è§£ç­”</span><div id="genModelAnswer" class="mono"></div></div>
              <div class="divider"></div>
              <div><span class="caps">è§£èª¬</span><div id="genExplanation"></div></div>
              <div class="divider"></div>
              <div><span class="caps">å‡ºé¡Œæ„å›³</span><div id="genIntention"></div></div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3>ã‚¹ãƒˆãƒƒã‚¯ï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>
          <div class="list" id="stockList"></div>
          <div class="small muted" id="stockCount"></div>
        </div>
      </section>

      <!-- å³ï¼šæ¡ç‚¹ -->
      <section class="card">
        <div class="toolbar">
          <h2>â‘¡ æ¡ç‚¹</h2>
          <button class="btn" id="btnExportGrading">ğŸ§¾ grading.jsonl</button>
        </div>

        <div class="qcard">
          <div class="small muted">å¯¾è±¡å•é¡Œ</div>
          <div id="currentQuestionText" style="margin:6px 0 8px;line-height:1.6"></div>
          <div class="flex" style="gap:8px;align-items:center">
            <label class="pill"><input type="checkbox" id="includeModelForGrading"> æ¡ç‚¹ã«æ¨¡ç¯„è§£ç­”ã‚‚æ¸¡ã™ï¼ˆå®‰å®šåŒ–ï¼‰</label>
            <label class="pill"><input type="checkbox" id="showCurrentHints"> ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º</label>
          </div>
          <div id="currentHintBox" class="hint" style="display:none;margin-top:8px">
            <div><span class="caps">æ¨¡ç¯„è§£ç­”</span><div id="currentModel" class="mono"></div></div>
            <div class="divider"></div>
            <div><span class="caps">è§£èª¬</span><div id="currentExpl"></div></div>
            <div class="divider"></div>
            <div><span class="caps">å‡ºé¡Œæ„å›³</span><div id="currentIntn"></div></div>
          </div>
        </div>

        <div class="flex-col" style="margin-top:10px">
          <label>ã‚ãªãŸã®è§£ç­”</label>
          <textarea id="studentAnswer" placeholder="ã“ã“ã«è§£ç­”ã‚’è¨˜å…¥ï¼ˆ30ã€œ80å­—ç›®å®‰ï¼‰"></textarea>
        </div>
        <div class="flex" style="margin-top:10px">
          <select id="gradeDifficulty">
            <option>5ç‚¹</option>
            <option selected>10ç‚¹</option>
          </select>
          <button class="btn brand" id="btnGrade">æ¡ç‚¹ã™ã‚‹</button>
          <button class="btn" id="btnClearAnswer">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="gradeResult" style="margin-top:12px;display:none">
          <h3>æ¡ç‚¹çµæœ</h3>
          <div class="qcard">
            <div id="scoreLine" class="success" style="font-weight:700"></div>
            <div id="commentary" style="margin:6px 0 8px"></div>
            <div class="small muted">ç†ç”±</div>
            <ul id="reasons" style="margin-top:4px"></ul>
            <div class="divider"></div>
            <div class="small muted">å‚è€ƒï¼šæ¨¡ç¯„è§£ç­”</div>
            <div id="gradedModel" class="mono"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    // ---- è¨­å®šã®æ°¸ç¶šåŒ– ----
    const $ = (q)=>document.querySelector(q);
    const cfg = {
      get baseUrl(){ return localStorage.getItem('baseUrl') || ''; },
      set baseUrl(v){ localStorage.setItem('baseUrl', v||''); },
      get accessCode(){ return localStorage.getItem('accessCode') || ''; },
      set accessCode(v){ localStorage.setItem('accessCode', v||''); },
      endpoint(p){ const b=this.baseUrl.trim(); return (b?b.replace(/\/$/,''):'') + p; }
    };

    // ---- å…±é€šFetch ----
    async function apiGet(path){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }
    async function apiPost(path, body){
      const headers = {'Content-Type':'application/json'};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {method:'POST', headers, body: JSON.stringify(body||{})});
      if(!res.ok){
        let msg = `${res.status} ${res.statusText}`;
        try { const j = await res.json(); if(j.error) msg += `: ${j.error}`; } catch(e){}
        throw new Error(msg);
      }
      return res.json();
    }

    function toast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.style.background = ok ? '#111827' : '#ef4444';
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }

    // ---- UIçŠ¶æ…‹ ----
    let subject = 'ç¤¾ä¼š';
    let currentItem = null;      // {question, model_answer, ...}
    let generatedRaw = null;     // ç”ŸæˆAPIã®ç”Ÿãƒ‡ãƒ¼ã‚¿

    // ---- è¨­å®šUI ----
    function loadSettings(){
      $('#baseUrl').value = cfg.baseUrl;
      $('#accessCode').value = cfg.accessCode;
    }
    function saveSettings(){
      cfg.baseUrl = $('#baseUrl').value.trim();
      cfg.accessCode = $('#accessCode').value.trim();
      $('#statusLine').textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
      setTimeout(()=>$('#statusLine').textContent='', 1500);
    }

    // ---- åˆæœŸåŒ– ----
    async function boot(){
      loadSettings();
      try{
        const r = await apiGet('/api/model');
        $('#modelTag').textContent = `model: ${r.model}`;
      }catch(e){
        $('#modelTag').textContent = 'model: (å–å¾—å¤±æ•—)';
      }
      await refreshStock();
      updateSubjectTabs();
      $('#settingsCard').style.display = 'none';
    }

    // ---- ç”ŸæˆUIãƒ­ã‚¸ãƒƒã‚¯ ----
    function updateSubjectTabs(){
      document.querySelectorAll('.tab').forEach(el=>{
        el.classList.toggle('active', el.dataset.subject === subject);
      });
      const cat = $('#category'); cat.innerHTML = '';
      if(subject==='ç¤¾ä¼š'){
        ['åœ°ç†','æ­´å²'].forEach(x=>{ const o=document.createElement('option'); o.textContent=x; cat.appendChild(o); });
        $('#gradeBox').style.display='none';
      }else{
        ['ç”Ÿç‰©','åŒ–å­¦','åœ°å­¦','ç‰©ç†','å¤©ä½“'].forEach(x=>{ const o=document.createElement('option'); o.textContent=x; cat.appendChild(o); });
        $('#gradeBox').style.display='';
      }
    }

    async function handleGenerate(){
      const payload = {
        subject,
        category: $('#category').value,
        grade: subject==='ç†ç§‘' ? $('#grade').value : '',
        difficulty: $('#difficulty').value,
        genre_hint: $('#genreHint').value,
        avoid_topics: $('#avoidTopics').value,
        include_hints: $('#includeHints').checked,
        length_hint: $('#lengthHint').value || '30ã€œ80å­—ç¨‹åº¦',
      };
      const btn = $('#btnGenerate');
      btn.disabled = true; btn.textContent = 'ç”Ÿæˆä¸­â€¦';
      try{
        const res = await apiPost('/api/generate_question', payload);
        generatedRaw = res;
        const item = res.item || res.generated || {};
        currentItem = res.item ? res.item : item;  // ä¿å­˜æ¸ˆã¿ or ç”Ÿæˆå†…å®¹
        renderGenerated(item, res.duplicate_of, res.novelty);
        await refreshStock();
        toast('å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
      }catch(e){
        console.error(e);
        toast('ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, false);
      }finally{
        btn.disabled = false; btn.textContent = 'å•é¡Œã‚’è‡ªå‹•ç”Ÿæˆ';
      }
    }

    function renderGenerated(item, dupOf, novelty){
      $('#genResult').style.display = '';
      $('#genQuestion').textContent = item.question || '(empty)';
      $('#genModelAnswer').textContent = item.model_answer || '';
      $('#genExplanation').textContent = item.explanation || '';
      $('#genIntention').textContent = item.intention || '';
      const tags = item.tags || [];
      const meta = [];
      if(item.subject) meta.push(item.subject);
      if(item.category) meta.push(item.category);
      if(item.grade) meta.push(item.grade);
      if(item.difficulty) meta.push(item.difficulty);
      $('#genMeta').textContent = meta.join(' / ');
      const tagsBox = $('#genTags'); tagsBox.innerHTML='';
      tags.forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tagsBox.appendChild(s); });
      $('#dupNote').textContent = dupOf ? `ï¼ˆæ³¨ï¼‰ã‚¹ãƒˆãƒƒã‚¯é¡ä¼¼: ${dupOf}` : '';
      $('#noveltyNote').textContent = novelty && typeof novelty.score==='number' ? `æ–°è¦æ€§: ${novelty.score}` : '';
      $('#hintBox').style.display = $('#toggleHints').checked ? '' : 'none';
    }

    // ---- ã‚¹ãƒˆãƒƒã‚¯ä¸€è¦§ ----
    async function refreshStock(){
      try{
        const r = await apiGet('/api/stock/list');
        const list = $('#stockList'); list.innerHTML='';
        (r.items||[]).forEach(it=>{
          const div=document.createElement('div'); div.className='item';
          const top=document.createElement('div');
          const nov = (it.meta && typeof it.meta.novelty_score==='number') ? ` / æ–°è¦æ€§:${it.meta.novelty_score}` : '';
          top.innerHTML = `<div class="small muted">${(it.subject||'')}${it.category? ' / '+it.category:''}${it.grade? ' / '+it.grade:''} / ${it.difficulty||''}${nov}</div>`;
          const q=document.createElement('div'); q.style.margin='6px 0'; q.textContent = it.question || '';
          const actions=document.createElement('div'); actions.className='flex';
          const useBtn=document.createElement('button'); useBtn.className='btn'; useBtn.textContent='ã“ã®å•é¡Œã‚’ä½¿ã†';
          useBtn.onclick=()=>{ useStock(it); };
          actions.appendChild(useBtn);
          if(cfg.accessCode){
            const del=document.createElement('button'); del.className='btn err'; del.textContent='å‰Šé™¤';
            del.onclick=()=>deleteStock(it.id);
            actions.appendChild(del);
          }
          div.appendChild(top); div.appendChild(q); div.appendChild(actions);
          list.appendChild(div);
        });
        $('#stockCount').textContent = `ä»¶æ•°: ${r.count} / ä¸Šé™ ${r.limit}`;
      }catch(e){
        console.error(e);
        $('#stockList').innerHTML = `<div class="small danger">å–å¾—ã«å¤±æ•—: ${e.message}</div>`;
      }
    }
    async function deleteStock(id){
      if(!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try{
        await apiPost('/api/stock/delete', {id});
        toast('å‰Šé™¤ã—ã¾ã—ãŸ');
        await refreshStock();
      }catch(e){
        toast('å‰Šé™¤ã«å¤±æ•—: ' + e.message, false);
      }
    }
    function useStock(it){
      currentItem = it;
      $('#currentQuestionText').textContent = it.question || '';
      $('#currentModel').textContent = it.model_answer || '';
      $('#currentExpl').textContent = it.explanation || '';
      $('#currentIntn').textContent = it.intention || '';
      $('#currentHintBox').style.display = $('#showCurrentHints').checked ? '' : 'none';
      window.scrollTo({top:0,behavior:'smooth'});
      toast('æ¡ç‚¹å¯¾è±¡ã«ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }

    // ---- æ¡ç‚¹ ----
    async function handleGrade(){
      if(!currentItem || !currentItem.question){
        toast('å…ˆã«å•é¡Œã‚’é¸ã¶ã‹ç”Ÿæˆã—ã¦ãã ã•ã„', false); return;
      }
      const body = {
        question: currentItem.question,
        student_answer: $('#studentAnswer').value || '',
        difficulty: $('#gradeDifficulty').value
      };
      if($('#includeModelForGrading').checked && currentItem.model_answer){
        body.model_answer = currentItem.model_answer;
      }
      if(!body.student_answer.trim()){
        toast('è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', false); return;
      }
      try{
        const r = await apiPost('/api/grade_answer', body);
        $('#gradeResult').style.display='';
        $('#scoreLine').textContent = `ã‚¹ã‚³ã‚¢: 10ç‚¹ä¸­${r.score}ç‚¹`;
        $('#commentary').textContent = r.commentary || '';
        $('#gradedModel').textContent = r.model_answer || '';
        const ul = $('#reasons'); ul.innerHTML='';
        (r.reasons||[]).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; ul.appendChild(li); });
        toast('æ¡ç‚¹ã—ã¾ã—ãŸ');
      }catch(e){
        console.error(e);
        toast('æ¡ç‚¹ã«å¤±æ•—: ' + e.message, false);
      }
    }

    // ---- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãDLï¼‰----
    async function downloadEndpoint(path, filename){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ---- ã‚¤ãƒ™ãƒ³ãƒˆçµç·š ----
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.tab')){
        subject = e.target.closest('.tab').dataset.subject;
        updateSubjectTabs();
      }
    });
    $('#btnGenerate').onclick = handleGenerate;
    $('#toggleHints').onchange = ()=> $('#hintBox').style.display = $('#toggleHints').checked ? '' : 'none';
    $('#btnUseForGrading').onclick = ()=>{
      if(!generatedRaw){ toast('å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„', false); return; }
      const item = (generatedRaw.item || generatedRaw.generated);
      useStock(item);
    };
    $('#showCurrentHints').onchange = ()=> $('#currentHintBox').style.display = $('#showCurrentHints').checked ? '' : 'none';
    $('#btnGrade').onclick = handleGrade;
    $('#btnClearAnswer').onclick = ()=>{ $('#studentAnswer').value=''; $('#gradeResult').style.display='none'; };

    $('#btnExportJson').onclick = ()=> downloadEndpoint('/api/export/stocks.json', 'stocks.json').catch(e=>toast('DLå¤±æ•—: '+e.message,false));
    $('#btnExportCsv').onclick = ()=> downloadEndpoint('/api/export/stocks.csv', 'stocks.csv').catch(e=>toast('DLå¤±æ•—: '+e.message,false));
    $('#btnExportGrading').onclick = ()=> downloadEndpoint('/api/export/grading.jsonl', 'grading.jsonl').catch(e=>toast('DLå¤±æ•—: '+e.message,false));

    $('#btnSettings').onclick = ()=> $('#settingsCard').style.display='';
    $('#btnHideSettings').onclick = ()=> $('#settingsCard').style.display='none';
    $('#btnSaveSettings').onclick = ()=> { saveSettings(); boot(); };
    $('#btnReload').onclick = boot;

    // èµ·å‹•
    boot();
  </script>
</body>
</html>
