<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>記述式API（個人運用版）UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#fdf6ff; --bg2:#f0fbff;
      --ink:#1f2937; --muted:#6b7280;
      --brand:#c084fc; --brand-strong:#a855f7;
      --accent:#f9a8d4; --accent-strong:#f472b6;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#ffffff; --border:#e5e7eb; --shadow:rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,0.75);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px var(--shadow);padding:16px}
    h1{font-size:20px;margin:4px 0}
    h2{font-size:18px;margin:8px 0 12px}
    h3{font-size:15px;margin:10px 0 6px}
    label{font-size:13px;color:var(--muted)}
    input[type=text], select, textarea{
      width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff
    }
    textarea{min-height:120px;resize:vertical}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .flex-col{display:flex;gap:8px;flex-direction:column}
    .btn{
      border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-weight:600;font-size:14px;cursor:pointer
    }
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
    .btn.err{background:var(--err);border-color:var(--err);color:#fff}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#374151;background:#fff}
    .toolbar{display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}}
    .pill{
      display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff
    }
    .small{font-size:12px;color:var(--muted)}
    .qcard{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hint{background:#faf5ff;border:1px solid #eadcff;border-radius:12px;padding:10px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(12px);transition:.25s}
    .toast.show{opacity:1;transform:none}
    .danger{color:var(--err)}
    .success{color:var(--ok)}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .list{display:flex;flex-direction:column;gap:10px;max-height:340px;overflow:auto}
    .item{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .caps{font-variant:all-small-caps;letter-spacing:.04em}
    .kbd{border:1px solid var(--border);padding:1px 6px;border-radius:6px;background:#fff;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="flex" style="gap:10px">
        <h1>記述式API（個人運用UI）</h1>
        <span id="modelTag" class="tag">model: ...</span>
      </div>
      <div class="flex">
        <button class="btn ghost" id="btnSettings">設定</button>
        <button class="btn ghost" id="btnReload">再読込</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px;padding-bottom:40px">
    <!-- 設定 -->
    <div class="card" id="settingsCard" style="display:none">
      <h2>接続設定</h2>
      <div class="grid-2">
        <div>
          <label for="baseUrl">API Base URL（空=同一オリジン）</label>
          <input type="text" id="baseUrl" placeholder="例 https://your.onrender.com">
          <div class="small muted">CORS済みのURLを指定。空欄なら同一オリジン。</div>
        </div>
        <div>
          <label for="accessCode">ACCESS_CODE（保護API用 / 任意）</label>
          <input type="text" id="accessCode" placeholder="ヘッダーに X-Access-Code として付与">
          <div class="small muted">生成・採点・削除・エクスポートに必要な認証ヘッダーが付与されます。</div>
        </div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn brand" id="btnSaveSettings">保存</button>
        <button class="btn" id="btnHideSettings">閉じる</button>
        <span id="statusLine" class="small muted"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <!-- 左：生成 & ストック -->
      <section class="card">
        <div class="toolbar">
          <h2>① 出題の生成 & ストック</h2>
          <div class="flex">
            <button class="btn" id="btnExportJson">📦 stocks.json</button>
            <button class="btn" id="btnExportCsv">📊 stocks.csv</button>
          </div>
        </div>

        <div class="flex" style="gap:6px;margin-bottom:8px">
          <span class="tab active" data-subject="社会">社会</span>
          <span class="tab" data-subject="理科">理科</span>
        </div>

        <div class="grid-2">
          <div>
            <label>分類（科目）</label>
            <select id="category">
              <option>地理</option>
              <option>歴史</option>
            </select>
          </div>
          <div id="gradeBox" style="display:none">
            <label>学年（理科のみ）</label>
            <select id="grade">
              <option>中1</option>
              <option>中2</option>
              <option selected>中3</option>
            </select>
          </div>
          <div>
            <label>難易度/配点</label>
            <select id="difficulty">
              <option>5点</option>
              <option selected>10点</option>
            </select>
          </div>
          <div>
            <label>解答分量の目安</label>
            <input type="text" id="lengthHint" value="30〜80字程度">
          </div>
          <div>
            <label>出題の方向性（任意）</label>
            <input type="text" id="genreHint" placeholder="制度/文化/時代背景 など">
          </div>
          <div>
            <label>避ける話題（任意）</label>
            <input type="text" id="avoidTopics" placeholder="例：稲作は避けたい">
          </div>
        </div>

        <div class="flex" style="margin-top:8px">
          <label class="pill"><input type="checkbox" id="includeHints"> ヒント（模範解答等）も生成に含める</label>
          <button class="btn brand" id="btnGenerate">問題を自動生成</button>
        </div>

        <div id="genResult" style="margin-top:12px;display:none">
          <h3>生成結果</h3>
          <div class="qcard">
            <div class="small muted" id="genMeta"></div>
            <div id="genQuestion" style="margin:8px 0;font-size:15px;line-height:1.6"></div>
            <div class="flex" id="genTags" style="gap:6px;flex-wrap:wrap"></div>
            <div class="divider"></div>
            <div class="flex" style="gap:8px;align-items:center">
              <button class="btn" id="btnUseForGrading">この問題で採点へ</button>
              <label class="pill"><input type="checkbox" id="toggleHints"> ヒントを表示</label>
              <span id="dupNote" class="small"></span>
              <span id="noveltyNote" class="small"></span>
            </div>
            <div id="hintBox" class="hint" style="display:none;margin-top:10px">
              <div><span class="caps">模範解答</span><div id="genModelAnswer" class="mono"></div></div>
              <div class="divider"></div>
              <div><span class="caps">解説</span><div id="genExplanation"></div></div>
              <div class="divider"></div>
              <div><span class="caps">出題意図</span><div id="genIntention"></div></div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3>ストック（最新10件）</h3>
          <div class="list" id="stockList"></div>
          <div class="small muted" id="stockCount"></div>
        </div>
      </section>

      <!-- 右：採点 -->
      <section class="card">
        <div class="toolbar">
          <h2>② 採点</h2>
          <button class="btn" id="btnExportGrading">🧾 grading.jsonl</button>
        </div>

        <div class="qcard">
          <div class="small muted">対象問題</div>
          <div id="currentQuestionText" style="margin:6px 0 8px;line-height:1.6"></div>
          <div class="flex" style="gap:8px;align-items:center">
            <label class="pill"><input type="checkbox" id="includeModelForGrading"> 採点に模範解答も渡す（安定化）</label>
            <label class="pill"><input type="checkbox" id="showCurrentHints"> ヒントを表示</label>
          </div>
          <div id="currentHintBox" class="hint" style="display:none;margin-top:8px">
            <div><span class="caps">模範解答</span><div id="currentModel" class="mono"></div></div>
            <div class="divider"></div>
            <div><span class="caps">解説</span><div id="currentExpl"></div></div>
            <div class="divider"></div>
            <div><span class="caps">出題意図</span><div id="currentIntn"></div></div>
          </div>
        </div>

        <div class="flex-col" style="margin-top:10px">
          <label>あなたの解答</label>
          <textarea id="studentAnswer" placeholder="ここに解答を記入（30〜80字目安）"></textarea>
        </div>
        <div class="flex" style="margin-top:10px">
          <select id="gradeDifficulty">
            <option>5点</option>
            <option selected>10点</option>
          </select>
          <button class="btn brand" id="btnGrade">採点する</button>
          <button class="btn" id="btnClearAnswer">クリア</button>
        </div>

        <div id="gradeResult" style="margin-top:12px;display:none">
          <h3>採点結果</h3>
          <div class="qcard">
            <div id="scoreLine" class="success" style="font-weight:700"></div>
            <div id="commentary" style="margin:6px 0 8px"></div>
            <div class="small muted">理由</div>
            <ul id="reasons" style="margin-top:4px"></ul>
            <div class="divider"></div>
            <div class="small muted">参考：模範解答</div>
            <div id="gradedModel" class="mono"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    // ---- 設定の永続化 ----
    const $ = (q)=>document.querySelector(q);
    const cfg = {
      get baseUrl(){ return localStorage.getItem('baseUrl') || ''; },
      set baseUrl(v){ localStorage.setItem('baseUrl', v||''); },
      get accessCode(){ return localStorage.getItem('accessCode') || ''; },
      set accessCode(v){ localStorage.setItem('accessCode', v||''); },
      endpoint(p){ const b=this.baseUrl.trim(); return (b?b.replace(/\/$/,''):'') + p; }
    };

    // ---- 共通Fetch ----
    async function apiGet(path){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }
    async function apiPost(path, body){
      const headers = {'Content-Type':'application/json'};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {method:'POST', headers, body: JSON.stringify(body||{})});
      if(!res.ok){
        let msg = `${res.status} ${res.statusText}`;
        try { const j = await res.json(); if(j.error) msg += `: ${j.error}`; } catch(e){}
        throw new Error(msg);
      }
      return res.json();
    }

    function toast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.style.background = ok ? '#111827' : '#ef4444';
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }

    // ---- UI状態 ----
    let subject = '社会';
    let currentItem = null;      // {question, model_answer, ...}
    let generatedRaw = null;     // 生成APIの生データ

    // ---- 設定UI ----
    function loadSettings(){
      $('#baseUrl').value = cfg.baseUrl;
      $('#accessCode').value = cfg.accessCode;
    }
    function saveSettings(){
      cfg.baseUrl = $('#baseUrl').value.trim();
      cfg.accessCode = $('#accessCode').value.trim();
      $('#statusLine').textContent = '保存しました';
      setTimeout(()=>$('#statusLine').textContent='', 1500);
    }

    // ---- 初期化 ----
    async function boot(){
      loadSettings();
      try{
        const r = await apiGet('/api/model');
        $('#modelTag').textContent = `model: ${r.model}`;
      }catch(e){
        $('#modelTag').textContent = 'model: (取得失敗)';
      }
      await refreshStock();
      updateSubjectTabs();
      $('#settingsCard').style.display = 'none';
    }

    // ---- 生成UIロジック ----
    function updateSubjectTabs(){
      document.querySelectorAll('.tab').forEach(el=>{
        el.classList.toggle('active', el.dataset.subject === subject);
      });
      const cat = $('#category'); cat.innerHTML = '';
      if(subject==='社会'){
        ['地理','歴史'].forEach(x=>{ const o=document.createElement('option'); o.textContent=x; cat.appendChild(o); });
        $('#gradeBox').style.display='none';
      }else{
        ['生物','化学','地学','物理','天体'].forEach(x=>{ const o=document.createElement('option'); o.textContent=x; cat.appendChild(o); });
        $('#gradeBox').style.display='';
      }
    }

    async function handleGenerate(){
      const payload = {
        subject,
        category: $('#category').value,
        grade: subject==='理科' ? $('#grade').value : '',
        difficulty: $('#difficulty').value,
        genre_hint: $('#genreHint').value,
        avoid_topics: $('#avoidTopics').value,
        include_hints: $('#includeHints').checked,
        length_hint: $('#lengthHint').value || '30〜80字程度',
      };
      const btn = $('#btnGenerate');
      btn.disabled = true; btn.textContent = '生成中…';
      try{
        const res = await apiPost('/api/generate_question', payload);
        generatedRaw = res;
        const item = res.item || res.generated || {};
        currentItem = res.item ? res.item : item;  // 保存済み or 生成内容
        renderGenerated(item, res.duplicate_of, res.novelty);
        await refreshStock();
        toast('問題を生成しました');
      }catch(e){
        console.error(e);
        toast('生成に失敗しました: ' + e.message, false);
      }finally{
        btn.disabled = false; btn.textContent = '問題を自動生成';
      }
    }

    function renderGenerated(item, dupOf, novelty){
      $('#genResult').style.display = '';
      $('#genQuestion').textContent = item.question || '(empty)';
      $('#genModelAnswer').textContent = item.model_answer || '';
      $('#genExplanation').textContent = item.explanation || '';
      $('#genIntention').textContent = item.intention || '';
      const tags = item.tags || [];
      const meta = [];
      if(item.subject) meta.push(item.subject);
      if(item.category) meta.push(item.category);
      if(item.grade) meta.push(item.grade);
      if(item.difficulty) meta.push(item.difficulty);
      $('#genMeta').textContent = meta.join(' / ');
      const tagsBox = $('#genTags'); tagsBox.innerHTML='';
      tags.forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tagsBox.appendChild(s); });
      $('#dupNote').textContent = dupOf ? `（注）ストック類似: ${dupOf}` : '';
      $('#noveltyNote').textContent = novelty && typeof novelty.score==='number' ? `新規性: ${novelty.score}` : '';
      $('#hintBox').style.display = $('#toggleHints').checked ? '' : 'none';
    }

    // ---- ストック一覧 ----
    async function refreshStock(){
      try{
        const r = await apiGet('/api/stock/list');
        const list = $('#stockList'); list.innerHTML='';
        (r.items||[]).forEach(it=>{
          const div=document.createElement('div'); div.className='item';
          const top=document.createElement('div');
          const nov = (it.meta && typeof it.meta.novelty_score==='number') ? ` / 新規性:${it.meta.novelty_score}` : '';
          top.innerHTML = `<div class="small muted">${(it.subject||'')}${it.category? ' / '+it.category:''}${it.grade? ' / '+it.grade:''} / ${it.difficulty||''}${nov}</div>`;
          const q=document.createElement('div'); q.style.margin='6px 0'; q.textContent = it.question || '';
          const actions=document.createElement('div'); actions.className='flex';
          const useBtn=document.createElement('button'); useBtn.className='btn'; useBtn.textContent='この問題を使う';
          useBtn.onclick=()=>{ useStock(it); };
          actions.appendChild(useBtn);
          if(cfg.accessCode){
            const del=document.createElement('button'); del.className='btn err'; del.textContent='削除';
            del.onclick=()=>deleteStock(it.id);
            actions.appendChild(del);
          }
          div.appendChild(top); div.appendChild(q); div.appendChild(actions);
          list.appendChild(div);
        });
        $('#stockCount').textContent = `件数: ${r.count} / 上限 ${r.limit}`;
      }catch(e){
        console.error(e);
        $('#stockList').innerHTML = `<div class="small danger">取得に失敗: ${e.message}</div>`;
      }
    }
    async function deleteStock(id){
      if(!confirm('この問題を削除しますか？')) return;
      try{
        await apiPost('/api/stock/delete', {id});
        toast('削除しました');
        await refreshStock();
      }catch(e){
        toast('削除に失敗: ' + e.message, false);
      }
    }
    function useStock(it){
      currentItem = it;
      $('#currentQuestionText').textContent = it.question || '';
      $('#currentModel').textContent = it.model_answer || '';
      $('#currentExpl').textContent = it.explanation || '';
      $('#currentIntn').textContent = it.intention || '';
      $('#currentHintBox').style.display = $('#showCurrentHints').checked ? '' : 'none';
      window.scrollTo({top:0,behavior:'smooth'});
      toast('採点対象にセットしました');
    }

    // ---- 採点 ----
    async function handleGrade(){
      if(!currentItem || !currentItem.question){
        toast('先に問題を選ぶか生成してください', false); return;
      }
      const body = {
        question: currentItem.question,
        student_answer: $('#studentAnswer').value || '',
        difficulty: $('#gradeDifficulty').value
      };
      if($('#includeModelForGrading').checked && currentItem.model_answer){
        body.model_answer = currentItem.model_answer;
      }
      if(!body.student_answer.trim()){
        toast('解答を入力してください', false); return;
      }
      try{
        const r = await apiPost('/api/grade_answer', body);
        $('#gradeResult').style.display='';
        $('#scoreLine').textContent = `スコア: 10点中${r.score}点`;
        $('#commentary').textContent = r.commentary || '';
        $('#gradedModel').textContent = r.model_answer || '';
        const ul = $('#reasons'); ul.innerHTML='';
        (r.reasons||[]).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; ul.appendChild(li); });
        toast('採点しました');
      }catch(e){
        console.error(e);
        toast('採点に失敗: ' + e.message, false);
      }
    }

    // ---- エクスポート（ヘッダー付きDL）----
    async function downloadEndpoint(path, filename){
      const headers = {};
      if(cfg.accessCode) headers['X-Access-Code'] = cfg.accessCode;
      const res = await fetch(cfg.endpoint(path), {headers});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ---- イベント結線 ----
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.tab')){
        subject = e.target.closest('.tab').dataset.subject;
        updateSubjectTabs();
      }
    });
    $('#btnGenerate').onclick = handleGenerate;
    $('#toggleHints').onchange = ()=> $('#hintBox').style.display = $('#toggleHints').checked ? '' : 'none';
    $('#btnUseForGrading').onclick = ()=>{
      if(!generatedRaw){ toast('先に生成してください', false); return; }
      const item = (generatedRaw.item || generatedRaw.generated);
      useStock(item);
    };
    $('#showCurrentHints').onchange = ()=> $('#currentHintBox').style.display = $('#showCurrentHints').checked ? '' : 'none';
    $('#btnGrade').onclick = handleGrade;
    $('#btnClearAnswer').onclick = ()=>{ $('#studentAnswer').value=''; $('#gradeResult').style.display='none'; };

    $('#btnExportJson').onclick = ()=> downloadEndpoint('/api/export/stocks.json', 'stocks.json').catch(e=>toast('DL失敗: '+e.message,false));
    $('#btnExportCsv').onclick = ()=> downloadEndpoint('/api/export/stocks.csv', 'stocks.csv').catch(e=>toast('DL失敗: '+e.message,false));
    $('#btnExportGrading').onclick = ()=> downloadEndpoint('/api/export/grading.jsonl', 'grading.jsonl').catch(e=>toast('DL失敗: '+e.message,false));

    $('#btnSettings').onclick = ()=> $('#settingsCard').style.display='';
    $('#btnHideSettings').onclick = ()=> $('#settingsCard').style.display='none';
    $('#btnSaveSettings').onclick = ()=> { saveSettings(); boot(); };
    $('#btnReload').onclick = boot;

    // 起動
    boot();
  </script>
</body>
</html>
