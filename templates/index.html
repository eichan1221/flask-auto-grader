<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>記述添削アプリ（テスト版）</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root{
      --text-dark:#111827;
      --muted:#6b7280;
      --card:#ffffff;
      --border:#e5e7eb;
      --pastel-bg:#f5f3ff;
      --pastel-accent:#e9d5ff;       /* 共有いただいたCSSに合わせる */
      --pastel-accent-strong:#c4b5fd;
      --primary:#a78bfa;
      --primary-strong:#7c3aed;
    }
    body{ line-height:1.6; color:var(--text-dark); background:#fff; }
    .container{ max-width:980px; margin:24px auto; padding:0 16px; }
    h1{ margin-bottom:8px; }
    .desc{ background:var(--pastel-accent); border:1px solid var(--pastel-accent-strong); padding:12px; border-radius:12px; margin:12px 0 24px; }

    /* タブ */
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tab-btn{ padding:8px 12px; border:1px solid var(--pastel-accent-strong); background:var(--pastel-bg); border-radius:10px; cursor:pointer; color:var(--text-dark) !important; min-height:42px; }
    .tab-btn:hover{ background:var(--pastel-accent); }
    .tab-btn.active{ background:var(--primary); color:#fff !important; border-color:var(--primary-strong); }

    /* レイアウト */
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(12,1fr); }
    .col-4{ grid-column:span 4; }
    .col-6{ grid-column:span 6; }
    .col-12{ grid-column:span 12; }

    @media (max-width: 720px){
      .grid{ grid-template-columns:1fr; }
      .col-4, .col-6, .col-12{ grid-column:1 / -1; }
      body{ line-height:1.7; }           /* スマホ読みやすさUP */
      .row{ gap:10px; }
    }

    /* ボタン（共有CSSと整合） */
    .btn{ padding:10px 16px; border-radius:10px; border:1px solid var(--primary-strong); background:var(--primary); color:#fff; cursor:pointer; }
    .btn:hover{ background:var(--primary-strong); }
    .btn.secondary{ background:#fff; color:var(--primary-strong); border:1px solid var(--primary-strong); }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted{ color:var(--muted); font-size:13px; }

    /* 出力表示 */
    pre{ background:var(--pastel-bg); color:var(--text-dark); padding:12px; border-radius:10px; border:1px solid var(--pastel-accent-strong); overflow-x:auto; }

    /* ヒント（想定解答/出題意図/観点） */
    details.hints{ background:var(--pastel-accent); border:1px solid var(--pastel-accent-strong); border-radius:12px; padding:10px 14px; }
    details.hints > summary{ cursor:pointer; font-weight:600; color:#4c1d95; list-style:none; padding:6px 0; }
    details.hints > summary::-webkit-details-marker{ display:none; }
    .hint-content{ margin-top:8px; }
    .badge{ display:inline-block; padding:2px 6px; border:1px solid var(--pastel-accent-strong); border-radius:6px; font-size:12px; color:#4b5563; background:#faf5ff; }

    /* ストック一覧の簡易モーダル（見た目は現状テイスト踏襲） */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.2); }
    .modal .panel{ width:min(900px, 92vw); max-height:85vh; overflow:auto; background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.1); }
    .stock-item{ border:1px solid var(--border); border-radius:10px; padding:10px; margin:8px 0; background:#fff; }
    .stock-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>記述添削アプリ（テスト版）</h1>
    <div class="desc">
      <strong>使い方</strong><br/>
      ① 上のタブで <b>社会</b>／<b>理科</b> を選び、必要項目（単元・学年・分野・難易度など）を指定します。<br/>
      ② 「出題モード」を選び、<b>自動生成</b> または <b>ストックから出題（手動/自動）</b> を選択します。<br/>
      ③ <b>問題を生成</b> を押すと、問題が表示されます。<b>ヒント</b>（想定解答／出題意図／観点）は開閉できます。<br/>
      ④ 生徒の解答を入力して <b>採点</b> を押すと、10点満点のスコアと講評が表示されます。
    </div>

    <!-- タブ -->
    <div class="tabs">
      <button class="tab-btn active" id="tab-social">社会</button>
      <button class="tab-btn" id="tab-science">理科</button>
    </div>

    <!-- 社会 設定 -->
    <div id="panel-social" class="card">
      <div class="grid">
        <div class="col-6">
          <label>分野（社会）</label>
          <select id="social-branch">
            <option value="歴史">歴史</option>
            <option value="地理">地理</option>
            <option value="公民">公民</option>
          </select>
        </div>
        <div class="col-6">
          <label>単元・時代（例：弥生時代／日本地理の工業／地方自治）</label>
          <input id="social-unit" type="text" placeholder="例：弥生時代" />
        </div>
        <div class="col-6">
          <label>難易度</label>
          <select id="difficulty-social">
            <option value="5">5点問題（基礎〜標準）</option>
            <option value="10">10点問題（標準〜やや発展）</option>
            <option value="満点">満点レベル（観点統合・根拠要求）</option>
          </select>
        </div>
        <div class="col-6">
          <label>出題モード</label>
          <select id="mode-social">
            <option value="auto">自動生成</option>
            <option value="stock-auto">ストックから出題（自動）</option>
            <option value="manual">ストックから出題（手動プリセット）</option>
          </select>
        </div>
        <div class="col-12" id="manual-area-social" style="display:none;">
          <label>手動プリセット問題（そのまま出題に使用）</label>
          <textarea id="manual-text-social" placeholder="（例）問題: ……&#10;想定解答: ……&#10;出題意図: ……&#10;模範解答の観点: ……"></textarea>
          <div class="muted">既存のプリントや過去問から抜粋する場合にお使いください。</div>
        </div>
      </div>
    </div>

    <!-- 理科 設定 -->
    <div id="panel-science" class="card" style="display:none;">
      <div class="grid">
        <div class="col-4">
          <label>学年（理科）</label>
          <select id="sci-grade">
            <option value="中1">中1</option>
            <option value="中2">中2</option>
            <option value="中3">中3</option>
          </select>
        </div>
        <div class="col-4">
          <label>分野</label>
          <select id="sci-domain">
            <option value="生物">生物</option>
            <option value="化学">化学</option>
            <option value="地学">地学</option>
            <option value="物理">物理</option>
            <option value="天体">天体</option>
          </select>
        </div>
        <div class="col-4">
          <label>難易度</label>
          <select id="difficulty-science">
            <option value="5">5点問題（基礎〜標準）</option>
            <option value="10">10点問題（標準〜やや発展）</option>
            <option value="満点">満点レベル（観点統合・根拠要求）</option>
          </select>
        </div>
        <div class="col-12">
          <label>トピック（任意：例「光合成」「イオン」「台風」など）</label>
          <input id="sci-topic" type="text" placeholder="例：光合成" />
        </div>
        <div class="col-6">
          <label>出題モード</label>
          <select id="mode-science">
            <option value="auto">自動生成</option>
            <option value="stock-auto">ストックから出題（自動）</option>
            <option value="manual">ストックから出題（手動プリセット）</option>
          </select>
        </div>
        <div class="col-12" id="manual-area-science" style="display:none;">
          <label>手動プリセット問題（そのまま出題に使用）</label>
          <textarea id="manual-text-science" placeholder="（例）問題: ……&#10;想定解答: ……&#10;出題意図: ……&#10;模範解答の観点: ……"></textarea>
        </div>
      </div>
    </div>

    <!-- 実行ボタン -->
    <div class="row" style="margin: 12px 0;">
      <button class="btn" id="btn-generate">問題を生成</button>
      <button class="btn secondary" id="btn-reset">形式履歴をリセット</button>
      <button class="btn secondary" id="btn-open-stock">ストックを見る</button>
      <span class="muted"><span class="badge">注意</span> 初回は数秒かかることがあります。</span>
    </div>

    <!-- 出題結果 -->
    <div class="card">
      <h3>生成された問題</h3>
      <pre id="question-out">（ここに問題が表示されます）</pre>

      <!-- 想定解答の表示トグル -->
      <div class="row" style="margin:8px 0;">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
          <input type="checkbox" id="toggle-answer" />
          想定解答を表示（教師用）
        </label>
      </div>

      <!-- ヒント（開閉） -->
      <details class="hints" id="hints" style="display:none;">
        <summary>ヒント（想定解答・出題意図・観点）を表示</summary>
        <div class="hint-content">
          <div id="hint-answer-block"><b>想定解答</b><div><pre id="hint-answer"></pre></div></div>
          <div><b>出題意図</b><div><pre id="hint-intent"></pre></div></div>
          <div><b>模範解答の観点</b><ul id="hint-points"></ul></div>
        </div>
      </details>
    </div>

    <!-- 採点 -->
    <div class="card">
      <h3>採点</h3>
      <label>生徒の解答（30〜80字目安）</label>
      <textarea id="answer"></textarea>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btn-grade">採点する</button>
        <span class="muted">出題直後の問題をもとに採点します。</span>
      </div>
      <div style="margin-top:12px;">
        <div id="grade-out"></div>
      </div>
    </div>
  </div>

  <!-- ストック一覧モーダル -->
  <div class="modal" id="stock-modal" aria-hidden="true">
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0;">ストック一覧</h3>
        <button class="btn secondary" id="btn-close-stock">閉じる</button>
      </div>
      <div class="row" style="margin:8px 0;">
        <button class="btn secondary" id="btn-load-social">社会</button>
        <button class="btn secondary" id="btn-load-science">理科</button>
      </div>
      <div id="stock-list"></div>
    </div>
  </div>

  <script>
    // タブ切り替え
    const tabSocial = document.getElementById("tab-social");
    const tabScience = document.getElementById("tab-science");
    const panelSocial = document.getElementById("panel-social");
    const panelScience = document.getElementById("panel-science");

    tabSocial.addEventListener("click", () => {
      tabSocial.classList.add("active"); tabScience.classList.remove("active");
      panelSocial.style.display = ""; panelScience.style.display = "none";
    });
    tabScience.addEventListener("click", () => {
      tabScience.classList.add("active"); tabSocial.classList.remove("active");
      panelScience.style.display = ""; panelSocial.style.display = "none";
    });

    // モード切替で手動エリアの出し分け
    const modeSocial = document.getElementById("mode-social");
    const manualAreaSocial = document.getElementById("manual-area-social");
    modeSocial.addEventListener("change", () => {
      manualAreaSocial.style.display = modeSocial.value === "manual" ? "" : "none";
    });

    const modeScience = document.getElementById("mode-science");
    const manualAreaScience = document.getElementById("manual-area-science");
    modeScience.addEventListener("change", () => {
      manualAreaScience.style.display = modeScience.value === "manual" ? "" : "none";
    });

    // 想定解答の任意表示トグル（ローカル保存つき）
    const toggleAns = document.getElementById("toggle-answer");
    const hintAnswerBlock = document.getElementById("hint-answer-block");
    let showAnswer = JSON.parse(localStorage.getItem("showAnswer") || "false");
    if (toggleAns) toggleAns.checked = showAnswer;

    function applyAnswerVisibility(hasAnswer){
      if (!hasAnswer){ hintAnswerBlock.style.display = "none"; return; }
      hintAnswerBlock.style.display = toggleAns.checked ? "" : "none";
    }
    if (toggleAns){
      toggleAns.addEventListener("change", () => {
        localStorage.setItem("showAnswer", JSON.stringify(toggleAns.checked));
        const has = (document.getElementById("hint-answer").textContent || "").trim().length > 0;
        applyAnswerVisibility(has);
      });
    }

    // 直近の生成結果（採点・再挑戦用に保持）
    let lastQuestionText = "";
    let lastQuestionId = "";
    let lastCategory = "";

    // セクション抽出
    function extractSection(text, label){
      const re = new RegExp(label.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "\\s*([\\s\\S]*?)(?=\\n(?:問題:|想定解答:|出題意図:|模範解答の観点:)|$)");
      const m = text.match(re);
      return m ? m[1].trim() : "";
    }
    function parseGenerated(text){
      const q = extractSection(text, "問題:");
      const a = extractSection(text, "想定解答:");
      const i = extractSection(text, "出題意図:");
      const pRaw = extractSection(text, "模範解答の観点:");
      const points = pRaw ? pRaw.split(/\n|・|-/).map(s=>s.trim()).filter(Boolean) : [];
      return {question:q || text, answer:a, intent:i, points};
    }

    // 簡易必須チェック
    function assertNonEmpty(value, msg){
      if (!value || !value.trim()){
        alert(msg);
        throw new Error(msg);
      }
    }

    // 生成
    document.getElementById("btn-generate").addEventListener("click", async () => {
      const isSocial = tabSocial.classList.contains("active");
      let payload = { category: isSocial ? "社会" : "理科" };

      if (isSocial) {
        payload.branch = document.getElementById("social-branch").value;
        payload.unit_or_era = document.getElementById("social-unit").value || "弥生時代";
        payload.difficulty = document.getElementById("difficulty-social").value;
        payload.mode = document.getElementById("mode-social").value;
        if (payload.mode === "manual") {
          payload.manual_text = document.getElementById("manual-text-social").value || "";
          assertNonEmpty(payload.manual_text, "手動プリセットが空です。");
        }
      } else {
        payload.grade = document.getElementById("sci-grade").value;
        payload.domain = document.getElementById("sci-domain").value;
        payload.topic = document.getElementById("sci-topic").value || "";
        payload.difficulty = document.getElementById("difficulty-science").value;
        payload.mode = document.getElementById("mode-science").value;
        if (payload.mode === "manual") {
          payload.manual_text = document.getElementById("manual-text-science").value || "";
          assertNonEmpty(payload.manual_text, "手動プリセットが空です。");
        }
      }

      try {
        const res = await fetch("/api/generate_question", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.ok) {
          const parsed = parseGenerated(data.text || "");
          document.getElementById("question-out").textContent = parsed.question || "（問題テキストが取得できませんでした）";

          // ヒント
          const hints = document.getElementById("hints");
          const hasHints = (parsed.answer || parsed.intent || (parsed.points && parsed.points.length));
          if (hasHints){
            document.getElementById("hint-answer").textContent = parsed.answer || "";
            document.getElementById("hint-intent").textContent = parsed.intent || "";
            const ul = document.getElementById("hint-points");
            ul.innerHTML = (parsed.points||[]).map(s=>`<li>${s}</li>`).join("");
            hints.style.display = ""; 
            hints.open = false;
            applyAnswerVisibility(!!parsed.answer);
          } else {
            hints.style.display = "none";
          }

          lastQuestionText = data.text;
          lastQuestionId = data.id || "";
          lastCategory = (data.meta && data.meta.category) || payload.category || "";

        } else {
          document.getElementById("question-out").textContent = "エラー: " + (data.error || "不明なエラー");
          document.getElementById("hints").style.display = "none";
        }
      } catch (e) {
        document.getElementById("question-out").textContent = "通信エラー: " + e;
        document.getElementById("hints").style.display = "none";
      }
    });

    // 採点
    document.getElementById("btn-grade").addEventListener("click", async () => {
      const answer = document.getElementById("answer").value || "";
      if (!lastQuestionText){
        document.getElementById("grade-out").innerHTML = "<span class='muted'>先に問題を生成してください。</span>";
        return;
      }
      try{
        const res = await fetch("/api/grade", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: lastQuestionText, answer, question_id: lastQuestionId, category: lastCategory }),
        });
        const data = await res.json();
        if (data.ok){
          document.getElementById("grade-out").innerHTML =
            `<div class="row"><div class="badge">score</div> <b>${data.score}/10</b></div>
             <div class="muted" style="margin-top:6px;">${data.summary || ""}</div>
             <div style="margin-top:8px;"><b>理由</b><ul>${(data.reasons || []).map(r=>`<li>${r}</li>`).join("")}</ul></div>
             <div><b>模範解答</b><div><pre>${data.model_answer || ""}</pre></div></div>
             <div><b>改善ポイント</b><ul>${(data.points || []).map(p=>`<li>${p}</li>`).join("")}</ul></div>`;
        } else {
          document.getElementById("grade-out").textContent = "エラー: " + (data.error || "採点に失敗しました");
        }
      } catch(e){
        document.getElementById("grade-out").textContent = "通信エラー: " + e;
      }
    });

    // 履歴リセット
    document.getElementById("btn-reset").addEventListener("click", async () => {
      try { await fetch("/api/reset_session", { method: "POST" }); } catch {}
    });

    // ===== ストックUI =====
    const stockModal = document.getElementById("stock-modal");
    const stockList = document.getElementById("stock-list");

    document.getElementById("btn-open-stock").addEventListener("click", async ()=>{
      stockModal.style.display = "flex";
      loadStock("社会");
    });
    document.getElementById("btn-close-stock").addEventListener("click", ()=>{
      stockModal.style.display = "none";
      stockList.innerHTML = "";
    });
    document.getElementById("btn-load-social").addEventListener("click", ()=> loadStock("社会"));
    document.getElementById("btn-load-science").addEventListener("click", ()=> loadStock("理科"));

    async function loadStock(category){
      stockList.innerHTML = "<div class='muted'>読み込み中…</div>";
      try{
        const url = category ? `/api/stock/list?category=${encodeURIComponent(category)}` : "/api/stock/list";
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) throw new Error("load failed");

        let items = [];
        if (category==="社会") items = (data.data.social||[]);
        else if (category==="理科") items = (data.data.science||[]);
        else items = (data.data.social||[]).concat(data.data.science||[]);

        if (!items.length){
          stockList.innerHTML = "<div class='muted'>ストックがありません。</div>";
          return;
        }

        stockList.innerHTML = items.map(it=>{
          const txt = (it.text||"").split("\n").slice(0,3).join("\n");
          return `
            <div class="stock-item">
              <div class="muted">${it.date || ""} / ${it.meta?.category || ""}</div>
              <pre style="margin:6px 0 0 0;">${escapeHtml(txt)}</pre>
              <div class="stock-actions">
                <button class="btn" data-act="use" data-id="${it.id}">出題</button>
                <button class="btn secondary" data-act="del" data-id="${it.id}">削除</button>
              </div>
            </div>`;
        }).join("");

        // ボタンイベント
        stockList.querySelectorAll("button[data-act]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            const act = btn.getAttribute("data-act");
            if (act==="use"){
              await useStock(id);
              stockModal.style.display = "none";
            } else if (act==="del"){
              if (!confirm("この問題を削除しますか？")) return;
              await deleteStock(id);
              await loadStock(category);
            }
          });
        });

      } catch(e){
        stockList.innerHTML = "<div class='muted'>読み込みに失敗しました。</div>";
      }
    }

    async function useStock(id){
      try{
        const res = await fetch("/api/retry", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "retry failed");

        const parsed = parseGenerated(data.text || "");
        document.getElementById("question-out").textContent = parsed.question || "（問題テキストが取得できませんでした）";

        const hints = document.getElementById("hints");
        const hasHints = (parsed.answer || parsed.intent || (parsed.points && parsed.points.length));
        if (hasHints){
          document.getElementById("hint-answer").textContent = parsed.answer || "";
          document.getElementById("hint-intent").textContent = parsed.intent || "";
          const ul = document.getElementById("hint-points");
          ul.innerHTML = (parsed.points||[]).map(s=>`<li>${s}</li>`).join("");
          hints.style.display = ""; 
          hints.open = false;
          applyAnswerVisibility(!!parsed.answer);
        } else {
          hints.style.display = "none";
        }
        lastQuestionText = data.text;
        lastQuestionId = data.id || id;
        lastCategory = (data.meta && data.meta.category) || "";

      } catch(e){
        alert("ストックの読み込みに失敗しました。");
      }
    }

    async function deleteStock(id){
      try{
        const res = await fetch("/api/stock/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (!data.ok) alert("削除に失敗しました。");
      } catch(e){
        alert("削除に失敗しました。");
      }
    }

    function escapeHtml(str){
      return (str||"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
  </script>
</body>
</html>
