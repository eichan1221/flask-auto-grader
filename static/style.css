:root{
  --bg1:#fdf0ff; --bg2:#f0fbff;
  --ink:#1f2937; --muted:#6b7280;
  --brand:#c084fc; --brand-strong:#a855f7;
  --accent:#f9a8d4; --accent-strong:#f472b6;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  --card:#ffffff; --border:#e5e7eb; --shadow:rgba(0,0,0,0.08);
  --action-bar-height:64px;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
body{padding-bottom:calc(var(--action-bar-height) + env(safe-area-inset-bottom, 0px))}
header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,0.75);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:900px){.row{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px var(--shadow);padding:16px}
h1{font-size:20px;margin:4px 0}
h2{font-size:18px;margin:8px 0 12px}
h3{font-size:15px;margin:10px 0 6px}
label{font-size:13px;color:var(--muted)}
input[type=text], select, textarea{
  width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff
}
textarea{min-height:120px;resize:vertical}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.flex-col{display:flex;gap:8px;flex-direction:column}
.btn{
  border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-weight:600;font-size:14px;cursor:pointer
}
.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.cta{padding:10px 18px;font-size:15px;box-shadow:0 6px 16px rgba(168,85,247,0.18)}
.btn.ghost{background:transparent}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.err{background:var(--err);border-color:var(--err);color:#fff}
.btn.small{padding:6px 12px;font-size:12px}

#btnStudyTips{
  border:none;
  color:#5b2b87;
  background:linear-gradient(135deg,#fde68a 0%,#fbcfe8 48%,#c4b5fd 100%);
  box-shadow:0 10px 24px rgba(168,85,247,0.22);
  position:relative;
  transition:transform .2s ease, box-shadow .2s ease, filter .2s ease;
  animation:studyPulse 2.6s ease-in-out infinite;
}
#btnStudyTips:hover{
  transform:translateY(-2px);
  box-shadow:0 14px 28px rgba(168,85,247,0.28);
  filter:saturate(1.05);
}
.study-tips-icon{font-size:15px;line-height:1}
.study-tips-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:34px;
  height:20px;
  padding:0 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  color:#fff;
  background:#ef4444;
  box-shadow:0 4px 10px rgba(239,68,68,0.35);
}
@keyframes studyPulse{
  0%,100%{transform:translateY(0);box-shadow:0 10px 24px rgba(168,85,247,0.22)}
  50%{transform:translateY(-1px);box-shadow:0 12px 26px rgba(168,85,247,0.28)}
}

.tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#374151;background:#fff}
.toolbar{display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){.grid-3{grid-template-columns:1fr}}
@media (max-width:700px){.grid-2{grid-template-columns:1fr}}
.pill{
  display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff
}
.pill.small{padding:4px 8px;font-size:12px}
.small{font-size:12px;color:var(--muted)}
.qcard{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px}
.qcard.mini{background:#fdf7ff}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.hint{background:#faf5ff;border:1px solid #eadcff;border-radius:12px;padding:10px}
.toast{position:fixed;right:16px;bottom:calc(var(--action-bar-height) + 12px);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(12px);transition:.25s;max-width:min(92vw,420px);line-height:1.5}
.toast.show{opacity:1;transform:none}
.danger{color:var(--err)}
.success{color:var(--ok)}
.muted{color:var(--muted)}
.divider{height:1px;background:var(--border);margin:8px 0}
.tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
.tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
.list{display:flex;flex-direction:column;gap:10px;max-height:380px;overflow:auto}
.item{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
.caps{font-variant:all-small-caps;letter-spacing:.04em}
.kbd{border:1px solid var(--border);padding:1px 6px;border-radius:6px;background:#fff;font-size:12px}
.advanced{
  margin-top:10px;
  border:1px dashed var(--border);
  border-radius:12px;
  padding:10px 12px;
  background:#fff;
}
.advanced summary{
  cursor:pointer;
  font-weight:600;
  color:#111827;
  list-style:none;
}
.advanced summary::-webkit-details-marker{display:none}
.advanced[open]{background:#f9fafb}
.rubric-details summary{
  cursor:pointer;
  font-weight:700;
  color:#111827;
  list-style:none;
}
.rubric-details summary::-webkit-details-marker{display:none}

/* キーボード操作の可視フォーカス（見た目は通常時変化なし） */
:focus-visible{ outline:2px solid var(--brand-strong); outline-offset:2px; }

/* model 表示 */
#modelTag{ display:inline-flex; }

/* =========================
   使い方モーダル（小ウィンドウ）
   ========================= */
.modal{
  position:fixed; inset:0; z-index:999;
  display:none; align-items:center; justify-content:center;
  padding:16px;
  background:rgba(17,24,39,0.35);
  backdrop-filter: blur(4px);
}
.modal.show{ display:flex; }
.modal .panel{
  width:min(920px, 96vw);
  max-height:86vh;
  overflow:auto;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:0 16px 60px rgba(0,0,0,0.18);
  padding:16px;
}
.modal .panelHeader{
  display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  position:sticky; top:0; background:rgba(255,255,255,0.92);
  backdrop-filter:saturate(180%) blur(8px);
  border-bottom:1px solid var(--border);
  padding:8px 8px 10px;
  border-radius:14px;
}
.modal .panelTitle{ margin:0; font-size:18px; }
.modal .panelBody{ padding:10px 6px 6px; }


#studyTipsModal{z-index:1000}
.study-tips-body{display:grid;gap:12px;line-height:1.8}
.study-loop-callout{
  border:1px solid #e9d5ff;
  border-radius:14px;
  background:linear-gradient(180deg,#fff7ff,#f5f3ff);
  padding:10px 12px;
}
.study-loop-callout p{margin:4px 0 0;font-weight:700;color:#6d28d9}
.study-tip-list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
.study-tip-item{
  display:grid;
  grid-template-columns:28px 1fr;
  gap:10px;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:#fff;
}
.study-tip-number{
  width:28px;height:28px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:800;color:#6d28d9;
  background:#f3e8ff;border:1px solid #ddd6fe;
}
.study-tip-closing{
  margin:0;
  font-weight:700;
  color:#1f2937;
  background:#fffbeb;
  border:1px solid #fde68a;
  border-radius:12px;
  padding:10px 12px;
}

.studyTips-highlight{
  border:1px solid #f5d0fe;
  border-radius:14px;
  background:linear-gradient(180deg,#fff8ff,#fdf4ff);
  padding:12px;
  box-shadow:0 8px 20px rgba(216,180,254,0.18);
}
.studyTips-highlight p{
  margin:0;
  color:#4c1d95;
  line-height:1.8;
  font-weight:600;
}
.studyTips-highlight .small{margin-top:8px;display:block;min-height:1.2em}
.studyTips-askBtn{
  margin-top:10px;
  border:none;
  border-radius:999px;
  padding:10px 16px;
  font-weight:800;
  color:#4c1d95;
  background:linear-gradient(135deg,#fde68a,#fbcfe8 55%,#ddd6fe);
  box-shadow:0 8px 18px rgba(168,85,247,0.22);
  cursor:pointer;
  transition:transform .16s ease, box-shadow .16s ease, filter .16s ease;
}
.studyTips-askBtn:hover{
  transform:translateY(-1px);
  box-shadow:0 12px 24px rgba(168,85,247,0.28);
  filter:saturate(1.08);
}
.studyTips-askBtn:focus-visible{
  outline:3px solid rgba(168,85,247,0.35);
  outline-offset:2px;
}
.callout{
  background:linear-gradient(180deg,#fff7ff,#f5fbff);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
}
.step{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  background:#fff;
}
.step h3{ margin:0 0 6px; font-size:15px; }
.step ol, .step ul{ margin:8px 0 0; padding-left:18px; line-height:1.75; }
.step .mini{ font-size:12px; color:var(--muted); margin-top:6px; }

/* 結果ヘッダブロック */
.result-header{background:linear-gradient(180deg,#fff,#f7f2ff)}
.result-summary{display:flex;flex-direction:column;gap:12px}
.summary-row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.summary-continue{border-top:1px dashed var(--border);padding-top:10px}
.result-details{margin-top:12px;border:1px dashed var(--border);border-radius:14px;padding:10px 12px;background:#fff}
.result-details summary{cursor:pointer;font-weight:700;list-style:none;color:#111827}
.result-details summary::-webkit-details-marker{display:none}
.result-detail-body{margin-top:10px}
.rubric-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:8px}
@media (max-width:700px){.rubric-grid{grid-template-columns:1fr}}
.rubric-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:#fff}
.rubric-score{font-weight:700;color:#111827}
.perfect-badge{
  margin-top:6px;
  display:inline-flex;
  align-items:center;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  color:#7c2d12;
  background:linear-gradient(135deg,#fde68a,#fbcfe8);
  border:1px solid #f9a8d4;
}
.praise-headline{
  margin-top:8px;
  font-weight:700;
  color:#065f46;
}
.rubric-diff{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.rubric-diff .diff{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
.rubric-diff .diff.up{color:var(--ok);border-color:rgba(34,197,94,0.4)}
.rubric-diff .diff.down{color:var(--err);border-color:rgba(239,68,68,0.4)}
.rubric-diff .diff.same{color:var(--muted)}

/* 続けたい度 */
.continue-score{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.continue-score .chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-weight:600;cursor:pointer}
.continue-score .chip:hover{border-color:var(--brand);color:var(--brand-strong)}
.continue-score .chip.selected{background:var(--brand);border-color:var(--brand);color:#fff}
.continue-score .chip:disabled{opacity:0.6;cursor:not-allowed}

/* フィードバック */
.feedback-fab{
  position:fixed;right:18px;bottom:calc(var(--action-bar-height) + 20px);z-index:20;
  background:var(--brand);color:#fff;border:none;border-radius:999px;
  padding:10px 16px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,0.18);cursor:pointer
}
.feedback-fab:hover{background:var(--brand-strong)}
.feedback-form textarea{min-height:180px}

/* 文字数メーター */
.char-meter{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
.char-meter.in-range{color:var(--ok)}
.char-meter.too-short{color:var(--warn)}
.char-meter.too-long{color:var(--err)}

/* アシスト */
.assist-panel{background:linear-gradient(180deg,#fff,#f8f3ff)}
.assist-field.missing input{border-color:var(--warn);box-shadow:0 0 0 2px rgba(245,158,11,0.15)}
.assist-actions{display:flex;gap:8px;align-items:center;margin:10px 0}
.assist-head{margin-top:10px}

/* 学習履歴 */
.history-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.history-chip{border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;background:#fff}
.history-stats{display:grid;gap:6px;margin-top:8px;font-size:12px;color:var(--muted)}

/* 満点条件チェック */
.criteria-check{list-style:none;padding-left:0;margin:0}
.criteria-check li{display:flex;gap:8px;align-items:flex-start;margin-bottom:6px}
.criteria-check li .check{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;border:1px solid var(--border);font-size:11px}
.criteria-check li.met .check{background:rgba(34,197,94,0.15);border-color:rgba(34,197,94,0.4);color:var(--ok)}
.criteria-check li.unmet .check{background:#fff;border-color:rgba(245,158,11,0.4);color:var(--warn)}

/* 結果タブ */
.result-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.tab-btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer}
.tab-btn.active{background:var(--brand);border-color:var(--brand);color:#fff}
.tab-panel{display:none}
.tab-panel.active{display:block}

/* 下部固定アクションバー */
.action-bar{
  position:fixed;left:0;right:0;bottom:0;z-index:30;
  display:flex;gap:8px;justify-content:space-around;align-items:center;
  padding:8px 12px calc(8px + env(safe-area-inset-bottom, 0px));
  background:rgba(255,255,255,0.95);
  border-top:1px solid var(--border);
  backdrop-filter:saturate(180%) blur(8px);
}
.action-btn{
  flex:1;
  min-height:48px;
  border:1px solid var(--border);
  border-radius:14px;
  background:#fff;
  font-weight:700;
  font-size:14px;
  cursor:pointer;
}
.action-btn:active{transform:translateY(1px)}
.action-btn:first-child{background:var(--brand);border-color:var(--brand);color:#fff}

@media (max-width:700px){
  h1{font-size:18px}
  h2{font-size:17px}
  h3{font-size:14px}
  input[type=text], select, textarea{font-size:15px;padding:12px 14px}
  .card{padding:14px}
  .summary-grid{grid-template-columns:1fr}
  .btn{font-size:15px}
  .next-cta .small{display:none}
}

/* AI先生チャット */
.ai-teacher-fab{
  position:fixed;right:16px;bottom:calc(var(--action-bar-height) + 84px);z-index:99999;
  width:72px;height:72px;
  border:2px solid #e9dbff;
  background:linear-gradient(180deg,#fff,#f9f2ff);
  border-radius:50%;
  overflow:hidden;
  padding:0;
  font-weight:700;
  color:#5b4a75;
  box-shadow:0 12px 28px rgba(109,85,255,0.25);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.ai-teacher-fab img{width:100%;height:100%;object-fit:cover;display:block}
.ai-teacher-fab:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(109,85,255,0.32)}
.ai-teacher-hint{
  position:fixed;right:22px;bottom:calc(var(--action-bar-height) + 162px);z-index:99999;
  background:#fff;border:1px solid #eadcff;border-radius:999px;padding:6px 10px;
  font-size:12px;color:#6d55ff;box-shadow:0 6px 16px rgba(109,85,255,0.16);
}
.ai-chat-log{
  min-height:220px;max-height:46vh;overflow:auto;
  border:1px solid var(--border);border-radius:14px;
  padding:10px;background:linear-gradient(180deg,#fff,#faf8ff);
}
.ai-chat-row{display:flex;margin-bottom:8px}
.ai-chat-row.user{justify-content:flex-end}
.ai-chat-row.assistant{justify-content:flex-start}
.ai-chat-bubble{
  max-width:min(84%,560px);
  padding:8px 10px;border-radius:12px;white-space:pre-wrap;line-height:1.6;
  border:1px solid var(--border);background:#fff;
}
.ai-chat-row.user .ai-chat-bubble{background:#f3ecff;border-color:#e2d5ff}
.ai-chat-bubble.error{color:var(--err);border-color:rgba(239,68,68,0.4);background:#fff5f5}
.ai-chat-bubble.loading{opacity:0.8}

@media (max-width:700px){
  .ai-teacher-fab{right:12px;bottom:calc(var(--action-bar-height) + 80px);width:64px;height:64px}
  .ai-teacher-hint{right:12px;bottom:calc(var(--action-bar-height) + 148px)}
}
